<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8" />
<title>Diff result</title>
<style type="text/css">
body { width: 100%; font-size: 10pt; }
h1 { font-size: 125%; }
div.content { font-family: Verdana, "DejaVu Sans Condensed", "Liberation Sans","Nimbus Sans L", Helvetica, sans-serif; margin : 1em auto; width: 100%; }
div.left { float: left; width: 48%; padding: 1em; }
div.right { float: right; width: 48%; padding: 1em; }
div.code { font-family: "Liberation Mono", "Courrier New", monospace; border:1px solid black;}
div.clear { clear: both; }
span.del { background-color : red; font-weight: normal; font-style: normal;}
span.add { background-color : lightgreen; font-weight: bold; font-style: normal;}
span.upd { background-color : orange; font-weight: bold; font-style: italic;}
span.id { background-color : white; font-weight: normal; font-style: normal;}
span.mv { background-color : yellow; font-weight: normal; font-style: normal;}
</style></head><body><div class="content"><div class="left">
<h1>left_ColorsAndFontsPreferencePage_1.71.java</h1>
<div class="code">
<div class="id">
/*******************************************************************************<br/>
 * Copyright (c) 2003, 2010 IBM Corporation and others.<br/>
 * All rights reserved. This program and the accompanying materials<br/>
 * are made available under the terms of the Eclipse Public License v1.0<br/>
 * which accompanies this distribution, and is available at<br/>
 * http://www.eclipse.org/legal/epl-v10.html<br/>
 *<br/>
 * Contributors:<br/>
 *     IBM Corporation - initial API and implementation<br/>
 *******************************************************************************/<br/>
package org.eclipse.ui.internal.themes;<br/>
<br/>
import com.ibm.icu.text.MessageFormat;<br/>
import java.util.ArrayList;<br/>
import java.util.Arrays;<br/>
import java.util.HashMap;<br/>
import java.util.HashSet;<br/>
import java.util.Iterator;<br/>
import java.util.List;<br/>
import java.util.Map;<br/>
import java.util.ResourceBundle;<br/>
import java.util.Set;<br/>
import org.eclipse.core.runtime.CoreException;<br/>
import org.eclipse.core.runtime.IStatus;<br/>
import org.eclipse.jface.preference.PreferenceConverter;<br/>
import org.eclipse.jface.preference.PreferencePage;<br/>
import org.eclipse.jface.resource.JFaceResources;<br/>
import org.eclipse.jface.resource.StringConverter;<br/>
import org.eclipse.jface.util.IPropertyChangeListener;<br/>
import org.eclipse.jface.util.PropertyChangeEvent;<br/>
import org.eclipse.jface.viewers.DoubleClickEvent;<br/>
import org.eclipse.jface.viewers.IDoubleClickListener;<br/>
import org.eclipse.jface.viewers.IFontProvider;<br/>
import org.eclipse.jface.viewers.ISelection;<br/>
import org.eclipse.jface.viewers.ISelectionChangedListener;<br/>
import org.eclipse.jface.viewers.IStructuredSelection;<br/>
import org.eclipse.jface.viewers.ITreeContentProvider;<br/>
import org.eclipse.jface.viewers.LabelProvider;<br/>
import org.eclipse.jface.viewers.LabelProviderChangedEvent;<br/>
import org.eclipse.jface.viewers.SelectionChangedEvent;<br/>
import org.eclipse.jface.viewers.StructuredSelection;<br/>
import org.eclipse.jface.viewers.TreeViewer;<br/>
import org.eclipse.jface.viewers.Viewer;<br/>
import org.eclipse.jface.viewers.ViewerComparator;<br/>
import org.eclipse.swt.SWT;<br/>
import org.eclipse.swt.custom.SashForm;<br/>
import org.eclipse.swt.custom.StackLayout;<br/>
import org.eclipse.swt.events.DisposeEvent;<br/>
import org.eclipse.swt.events.DisposeListener;<br/>
import org.eclipse.swt.events.PaintEvent;<br/>
import org.eclipse.swt.events.PaintListener;<br/>
import org.eclipse.swt.events.SelectionAdapter;<br/>
import org.eclipse.swt.events.SelectionEvent;<br/>
import org.eclipse.swt.graphics.Color;<br/>
import org.eclipse.swt.graphics.Font;<br/>
import org.eclipse.swt.graphics.FontData;<br/>
import org.eclipse.swt.graphics.FontMetrics;<br/>
import org.eclipse.swt.graphics.GC;<br/>
import org.eclipse.swt.graphics.Image;<br/>
import org.eclipse.swt.graphics.RGB;<br/>
import org.eclipse.swt.graphics.Rectangle;<br/>
import org.eclipse.swt.layout.FillLayout;<br/>
import org.eclipse.swt.layout.GridData;<br/>
import org.eclipse.swt.layout.GridLayout;<br/>
import org.eclipse.swt.widgets.Button;<br/>
import org.eclipse.swt.widgets.Canvas;<br/>
import org.eclipse.swt.widgets.ColorDialog;<br/>
import org.eclipse.swt.widgets.Composite;<br/>
import org.eclipse.swt.widgets.Control;<br/>
import org.eclipse.swt.widgets.Display;<br/>
import org.eclipse.swt.widgets.FontDialog;<br/>
import org.eclipse.swt.widgets.Label;<br/>
import org.eclipse.swt.widgets.Text;<br/>
import org.eclipse.ui.IWorkbench;<br/>
import org.eclipse.ui.IWorkbenchPreferencePage;<br/>
import org.eclipse.ui.PlatformUI;<br/>
import org.eclipse.ui.dialogs.FilteredTree;<br/>
import org.eclipse.ui.dialogs.PatternFilter;<br/>
import org.eclipse.ui.internal.IWorkbenchGraphicConstants;<br/>
import org.eclipse.ui.internal.IWorkbenchHelpContextIds;<br/>
import org.eclipse.ui.internal.Workbench;<br/>
import org.eclipse.ui.internal.WorkbenchMessages;<br/>
import org.eclipse.ui.internal.WorkbenchPlugin;<br/>
import org.eclipse.ui.internal.misc.StatusUtil;<br/>
import org.eclipse.ui.internal.util.PrefUtil;<br/>
import org.eclipse.ui.internal.util.Util;<br/>
import org.eclipse.ui.themes.ITheme;<br/>
import org.eclipse.ui.themes.IThemeManager;<br/>
import org.eclipse.ui.themes.IThemePreview;<br/>
<br/>
/**<br/>
 * Preference page for management of system colors, gradients and fonts.<br/>
 * <br/>
 * @since 3.0<br/>
 */<br/>
public final class ColorsAndFontsPreferencePage extends PreferencePage<br/>
        implements IWorkbenchPreferencePage {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;private static final String SELECTED_ELEMENT_PREF = "ColorsAndFontsPreferencePage.selectedElement"; //$NON-NLS-1$<br/>
&nbsp;&nbsp;&nbsp;&nbsp;/**<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * The preference that stores the expanded state.<br/>
&nbsp;&nbsp;&nbsp;&nbsp; */<br/>
&nbsp;&nbsp;&nbsp;&nbsp;private static final String EXPANDED_ELEMENTS_PREF = "ColorsAndFontsPreferencePage.expandedCategories"; //$NON-NLS-1$<br/>
&nbsp;&nbsp;&nbsp;&nbsp;/**<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * The token that separates expanded elements in EXPANDED_ELEMENTS_PREF.<br/>
&nbsp;&nbsp;&nbsp;&nbsp; */<br/>
&nbsp;&nbsp;&nbsp;&nbsp;private static final String EXPANDED_ELEMENTS_TOKEN = "\t"; //$NON-NLS-1$<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;/**<br/>
     * Marks category tokens in EXPANDED_ELEMENTS_PREF and SELECTED_ELEMENT_PREF.<br/>
     */<br/>
&nbsp;&nbsp;&nbsp;&nbsp;private static final char MARKER_CATEGORY = 'T';<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;/**<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * Marks color tokens in EXPANDED_ELEMENTS_PREF and SELECTED_ELEMENT_PREF.<br/>
&nbsp;&nbsp;&nbsp;&nbsp; */<br/>
&nbsp;&nbsp;&nbsp;&nbsp;private static final char MARKER_COLOR = 'C';<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;/**<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * Marks font tokens in EXPANDED_ELEMENTS_PREF and SELECTED_ELEMENT_PREF.<br/>
&nbsp;&nbsp;&nbsp;&nbsp; */<br/>
&nbsp;&nbsp;&nbsp;&nbsp;private static final char MARKER_FONT = 'F';<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br/>
    private class ThemeContentProvider implements ITreeContentProvider {<br/>
<br/>
        private IThemeRegistry registry;<br/>
<br/>
        /* (non-Javadoc)<br/>
         * @see org.eclipse.jface.viewers.ITreeContentProvider#getChildren(java.lang.Object)<br/>
         */<br/>
        public Object[] getChildren(Object parentElement) {<br/>
            if (parentElement instanceof ThemeElementCategory) {<br/>
                String categoryId = ((ThemeElementCategory) parentElement)<br/>
                        .getId();<br/>
                Object[] defintions = (Object[]) categoryMap.get(categoryId);<br/>
                if (defintions == null) {<br/>
                    defintions = getCategoryChildren(categoryId);<br/>
                    categoryMap.put(categoryId, defintions);<br/>
                }<br/>
                return defintions;<br/>
            }<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ArrayList list = new ArrayList();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IHierarchalThemeElementDefinition def = (IHierarchalThemeElementDefinition) parentElement;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String id = def.getId();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IHierarchalThemeElementDefinition[] defs;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (def instanceof ColorDefinition) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;defs = registry.getColors();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;defs = registry.getFonts();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for (int i = 0; i &lt; defs.length; i++) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (id.equals(defs[i].getDefaultsTo())<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;&amp; ColorsAndFontsPreferencePage.equals(<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((ICategorizedThemeElementDefinition) def)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.getCategoryId(),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((ICategorizedThemeElementDefinition) defs[i])<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.getCategoryId())) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;list.add(defs[i]);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return list.toArray();<br/>
        }<br/>
<br/>
        private Object[] getCategoryChildren(String categoryId) {<br/>
            ArrayList list = new ArrayList();<br/>
<br/>
            if (categoryId != null) {<br/>
                ThemeElementCategory[] categories = registry.getCategories();<br/>
                for (int i = 0; i &lt; categories.length; i++) {<br/>
                    if (categoryId.equals(categories[i].getParentId())) {<br/>
                        Set bindings = themeRegistry<br/>
                                .getPresentationsBindingsFor(categories[i]);<br/>
                        if (bindings == null<br/>
                                || bindings.contains(workbench<br/>
                                        .getPresentationId())) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;list.add(categories[i]);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
                    }<br/>
                }<br/>
            }<br/>
            {<br/>
                ColorDefinition[] colorDefinitions = themeRegistry<br/>
                        .getColorsFor(currentTheme.getId());<br/>
                for (int i = 0; i &lt; colorDefinitions.length; i++) {<br/>
                    if (!colorDefinitions[i].isEditable()) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
                    String catId = colorDefinitions[i].getCategoryId();<br/>
                    if ((catId == null &amp;&amp; categoryId == null)<br/>
                            || (catId != null &amp;&amp; categoryId != null &amp;&amp; categoryId<br/>
                                    .equals(catId))) {<br/>
                        if (colorDefinitions[i].getDefaultsTo() != null<br/>
                                &amp;&amp; parentIsInSameCategory(colorDefinitions[i])) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
                        list.add(colorDefinitions[i]);<br/>
                    }<br/>
                }<br/>
            }<br/>
            {<br/>
                FontDefinition[] fontDefinitions = themeRegistry<br/>
                        .getFontsFor(currentTheme.getId());<br/>
                for (int i = 0; i &lt; fontDefinitions.length; i++) {<br/>
                    if (!fontDefinitions[i].isEditable()) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
                    String catId = fontDefinitions[i].getCategoryId();<br/>
                    if ((catId == null &amp;&amp; categoryId == null)<br/>
                            || (catId != null &amp;&amp; categoryId != null &amp;&amp; categoryId<br/>
                                    .equals(catId))) {<br/>
                        if (fontDefinitions[i].getDefaultsTo() != null<br/>
                                &amp;&amp; parentIsInSameCategory(fontDefinitions[i])) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
                        list.add(fontDefinitions[i]);<br/>
                    }<br/>
                }<br/>
            }<br/>
            return list.toArray(new Object[list.size()]);<br/>
        }<br/>
<br/>
        private boolean parentIsInSameCategory(ColorDefinition definition) {<br/>
            String defaultsTo = definition.getDefaultsTo();<br/>
            ColorDefinition[] defs = registry.getColors();<br/>
            for (int i = 0; i &lt; defs.length; i++) {<br/>
                if (defs[i].getId().equals(defaultsTo)<br/>
                        &amp;&amp; ColorsAndFontsPreferencePage.equals(defs[i]<br/>
                                .getCategoryId(), definition.getCategoryId())) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return true;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
            }<br/>
            return false;<br/>
        }<br/>
<br/>
        private boolean parentIsInSameCategory(FontDefinition definition) {<br/>
            String defaultsTo = definition.getDefaultsTo();<br/>
            FontDefinition[] defs = registry.getFonts();<br/>
            for (int i = 0; i &lt; defs.length; i++) {<br/>
                if (defs[i].getId().equals(defaultsTo)<br/>
                        &amp;&amp; ColorsAndFontsPreferencePage.equals(defs[i]<br/>
                                .getCategoryId(), definition.getCategoryId())) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return true;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
            }<br/>
            return false;<br/>
        }<br/>
<br/>
        /* (non-Javadoc)<br/>
         * @see org.eclipse.jface.viewers.ITreeContentProvider#getParent(java.lang.Object)<br/>
         */<br/>
        public Object getParent(Object element) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (element instanceof ThemeElementCategory)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return registry;<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (element instanceof ColorDefinition) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String defaultId = ((IHierarchalThemeElementDefinition) element).getDefaultsTo();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (defaultId != null) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ColorDefinition defaultElement = registry.findColor(defaultId);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (parentIsInSameCategory(defaultElement))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return defaultElement;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String categoryId = ((ColorDefinition) element).getCategoryId();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return registry.findCategory(categoryId);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (element instanceof FontDefinition) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String defaultId = ((FontDefinition) element).getDefaultsTo();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (defaultId != null) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FontDefinition defaultElement = registry.findFont(defaultId);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (parentIsInSameCategory(defaultElement))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return defaultElement;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String categoryId = ((FontDefinition) element).getCategoryId();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return registry.findCategory(categoryId);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return null;<br/>
        }<br/>
<br/>
        /* (non-Javadoc)<br/>
         * @see org.eclipse.jface.viewers.ITreeContentProvider#hasChildren(java.lang.Object)<br/>
         */<br/>
        public boolean hasChildren(Object element) {<br/>
            if (element instanceof ThemeElementCategory) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return true;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IHierarchalThemeElementDefinition def = (IHierarchalThemeElementDefinition) element;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String id = def.getId();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IHierarchalThemeElementDefinition[] defs;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (def instanceof ColorDefinition) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;defs = registry.getColors();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;defs = registry.getFonts();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for (int i = 0; i &lt; defs.length; i++) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (id.equals(defs[i].getDefaultsTo())<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;&amp; ColorsAndFontsPreferencePage.equals(<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((ICategorizedThemeElementDefinition) def)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.getCategoryId(),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((ICategorizedThemeElementDefinition) defs[i])<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.getCategoryId())) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return true;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
<br/>
            return false;<br/>
        }<br/>
<br/>
        /*<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; * (non-Javadoc)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; * <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; * @see org.eclipse.jface.viewers.IStructuredContentProvider#getElements(java.lang.Object)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; */<br/>
        public Object[] getElements(Object inputElement) {<br/>
            ArrayList list = new ArrayList();<br/>
            Object[] uncatChildren = getCategoryChildren(null);<br/>
            list.addAll(Arrays.asList(uncatChildren));<br/>
            ThemeElementCategory[] categories = ((IThemeRegistry) inputElement)<br/>
                    .getCategories();<br/>
            for (int i = 0; i &lt; categories.length; i++) {<br/>
                if (categories[i].getParentId() == null) {<br/>
                    Set bindings = themeRegistry<br/>
                            .getPresentationsBindingsFor(categories[i]);<br/>
                    if (bindings == null<br/>
                            || bindings.contains(workbench.getPresentationId())) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;list.add(categories[i]);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
                }<br/>
            }<br/>
            return list.toArray(new Object[list.size()]);<br/>
        }<br/>
<br/>
        /* (non-Javadoc)<br/>
         * @see org.eclipse.jface.viewers.IContentProvider#dispose()<br/>
         */<br/>
        public void dispose() {<br/>
            categoryMap.clear();<br/>
        }<br/>
<br/>
        /* (non-Javadoc)<br/>
         * @see org.eclipse.jface.viewers.IContentProvider#inputChanged(org.eclipse.jface.viewers.Viewer, java.lang.Object, java.lang.Object)<br/>
         */<br/>
        public void inputChanged(Viewer viewer, Object oldInput, Object newInput) {<br/>
            categoryMap.clear();<br/>
            registry = (IThemeRegistry) newInput;<br/>
        }<br/>
<br/>
    }<br/>
<br/>
    private class PresentationLabelProvider extends LabelProvider implements<br/>
            IFontProvider {<br/>
<br/>
        private HashMap fonts = new HashMap();<br/>
<br/>
        private HashMap images = new HashMap();<br/>
<br/>
        private int imageSize = -1;<br/>
<br/>
        private int usableImageSize = -1;<br/>
<br/>
        private IPropertyChangeListener listener = new IPropertyChangeListener() {<br/>
            public void propertyChange(PropertyChangeEvent event) {<br/>
                fireLabelProviderChanged(new LabelProviderChangedEvent(<br/>
                        PresentationLabelProvider.this));<br/>
            }<br/>
        };<br/>
<br/>
        private Image emptyImage;<br/>
<br/>
        public PresentationLabelProvider() {<br/>
            hookListeners();<br/>
        }<br/>
<br/>
        /**<br/>
         * Hook the listeners onto the various registries.<br/>
         */<br/>
        public void hookListeners() {<br/>
            colorRegistry.addListener(listener);<br/>
            fontRegistry.addListener(listener);<br/>
        }<br/>
<br/>
        /* (non-Javadoc)<br/>
         * @see org.eclipse.jface.viewers.IBaseLabelProvider#dispose()<br/>
         */<br/>
        public void dispose() {<br/>
            super.dispose();<br/>
            colorRegistry.removeListener(listener);<br/>
            fontRegistry.removeListener(listener);<br/>
            for (Iterator i = images.values().iterator(); i.hasNext();) {<br/>
                ((Image) i.next()).dispose();<br/>
            }<br/>
            images.clear();<br/>
<br/>
            if (emptyImage != null) {<br/>
                emptyImage.dispose();<br/>
                emptyImage = null;<br/>
            }<br/>
<br/>
            //clear the fonts.<br/>
            clearFontCache();<br/>
        }<br/>
<br/>
        /**<br/>
         * Clears and disposes all fonts.<br/>
         */<br/>
        public void clearFontCache() {<br/>
            for (Iterator i = fonts.values().iterator(); i.hasNext();) {<br/>
                ((Font) i.next()).dispose();<br/>
            }<br/>
            fonts.clear();<br/>
        }<br/>
        <br/>
        /**<br/>
         * Clears and disposes all fonts and fires a label update.<br/>
         */<br/>
        public void clearFontCacheAndUpdate() {<br/>
        &nbsp;&nbsp;&nbsp;&nbsp;clearFontCache();<br/>
        &nbsp;&nbsp;&nbsp;&nbsp;fireLabelProviderChanged(new LabelProviderChangedEvent(<br/>
                    PresentationLabelProvider.this));<br/>
        }<br/>
<br/>
        /* (non-Javadoc)<br/>
         * @see org.eclipse.jface.viewers.IFontProvider#getFont(java.lang.Object)<br/>
         */<br/>
        public Font getFont(Object element) {<br/>
            Display display = tree.getDisplay();<br/>
            if (element instanceof FontDefinition) {<br/>
                int parentHeight = tree.getViewer().getControl().getFont()<br/>
                        .getFontData()[0].getHeight();<br/>
                Font baseFont = fontRegistry.get(((FontDefinition) element)<br/>
                        .getId());<br/>
                Font font = (Font) fonts.get(baseFont);<br/>
                if (font == null) {<br/>
                    FontData[] data = baseFont.getFontData();<br/>
                    for (int i = 0; i &lt; data.length; i++) {<br/>
                        data[i].setHeight(parentHeight);<br/>
                    }<br/>
                    font = new Font(display, data);<br/>
<br/>
                    fonts.put(baseFont, font);<br/>
                }<br/>
                return font;<br/>
            }<br/>
<br/>
            return JFaceResources.getDialogFont();<br/>
        }<br/>
<br/>
        /* (non-Javadoc)<br/>
         * @see org.eclipse.jface.viewers.ILabelProvider#getImage(java.lang.Object)<br/>
         */<br/>
        public Image getImage(Object element) {<br/>
            if (element instanceof ColorDefinition) {<br/>
                Color c = colorRegistry<br/>
                        .get(((ColorDefinition) element).getId());<br/>
                Image image = (Image) images.get(c);<br/>
                if (image == null) {<br/>
                    Display display = tree.getDisplay();<br/>
                    ensureImageSize();<br/>
                    image = new Image(display, imageSize, imageSize);<br/>
<br/>
                    GC gc = new GC(image);<br/>
                    gc.setBackground(tree.getViewer().getControl()<br/>
                            .getBackground());<br/>
                    gc.setForeground(tree.getViewer().getControl()<br/>
                            .getBackground());<br/>
                    gc.drawRectangle(0, 0, imageSize - 1, imageSize - 1);<br/>
<br/>
                    gc.setForeground(tree.getViewer().getControl()<br/>
                            .getForeground());<br/>
                    gc.setBackground(c);<br/>
<br/>
                    int offset = (imageSize - usableImageSize) / 2;<br/>
                    gc.drawRectangle(offset, offset, usableImageSize - offset,<br/>
                            usableImageSize - offset);<br/>
                    gc.fillRectangle(offset + 1, offset + 1, usableImageSize<br/>
                            - offset - 1, usableImageSize - offset - 1);<br/>
                    gc.dispose();<br/>
<br/>
                    images.put(c, image);<br/>
                }<br/>
                return image;<br/>
<br/>
            } else if (element instanceof FontDefinition) {<br/>
                return workbench.getSharedImages().getImage(<br/>
                        IWorkbenchGraphicConstants.IMG_OBJ_FONT);<br/>
            } else {<br/>
                return workbench.getSharedImages().getImage(<br/>
                        IWorkbenchGraphicConstants.IMG_OBJ_THEME_CATEGORY);<br/>
            }<br/>
        }<br/>
<br/>
        private void ensureImageSize() {<br/>
            if (imageSize == -1) {<br/>
                imageSize = tree.getViewer().getTree().getItemHeight();<br/>
                usableImageSize = Math.max(1, imageSize - 4);<br/>
            }<br/>
        }<br/>
<br/>
        /* (non-Javadoc)<br/>
         * @see org.eclipse.jface.viewers.ILabelProvider#getText(java.lang.Object)<br/>
         */<br/>
        public String getText(Object element) {<br/>
            if (element instanceof IHierarchalThemeElementDefinition) {<br/>
                IHierarchalThemeElementDefinition themeElement = (IHierarchalThemeElementDefinition) element;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (themeElement.getDefaultsTo() != null) {<br/>
                    String myCategory = ((ICategorizedThemeElementDefinition) themeElement).getCategoryId();<br/>
                    ICategorizedThemeElementDefinition def;<br/>
                    if (element instanceof ColorDefinition)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;def = themeRegistry.findColor(themeElement.getDefaultsTo());<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;def = themeRegistry.findFont(themeElement.getDefaultsTo());<br/>
<br/>
                    if (!ColorsAndFontsPreferencePage.equals(def.getCategoryId(), myCategory)) {<br/>
                    &nbsp;&nbsp;&nbsp;&nbsp;if (isDefault(themeElement))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return MessageFormat.format(RESOURCE_BUNDLE.getString("defaultFormat_default"), new Object[] { themeElement.getName(), def.getName() }); //$NON-NLS-1$<br/>
               &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return MessageFormat.format(RESOURCE_BUNDLE.getString("defaultFormat_override"), new Object[] { themeElement.getName(), def.getName() }); //$NON-NLS-1$<br/>
                    }<br/>
                }<br/>
            }<br/>
            return ((IThemeElementDefinition) element).getName();<br/>
        }<br/>
<br/>
        /**<br/>
         * Return whether the element is set to default.<br/>
         * <br/>
         * @param def the definition<br/>
         * @return whether the element is set to default<br/>
         * @since 3.2<br/>
         */<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;private boolean isDefault(IThemeElementDefinition def) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (def instanceof FontDefinition)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return ColorsAndFontsPreferencePage.this.isDefault((FontDefinition)def);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (def instanceof ColorDefinition)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return ColorsAndFontsPreferencePage.this.isDefault((ColorDefinition)def);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return false;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
    }<br/>
<br/>
    /**<br/>
     * The translation bundle in which to look up internationalized text.<br/>
     */<br/>
    private final static ResourceBundle RESOURCE_BUNDLE = ResourceBundle<br/>
            .getBundle(ColorsAndFontsPreferencePage.class.getName());<br/>
<br/>
    /**<br/>
     * Map to precalculate category color lists.<br/>
     */<br/>
    private Map categoryMap = new HashMap(7);<br/>
<br/>
    private Font appliedDialogFont;<br/>
<br/>
    /**<br/>
     * Map of definition id-&gt;RGB objects that map to changes expressed in this<br/>
     * UI session.  These changes should be made in preferences and the<br/>
     * registry.<br/>
     */<br/>
    private Map colorPreferencesToSet = new HashMap(7);<br/>
<br/>
    private CascadingColorRegistry colorRegistry;<br/>
<br/>
    /**<br/>
     * Map of definition id-&gt;RGB objects that map to changes expressed in this<br/>
     * UI session.  These changes should be made in the registry.<br/>
     */<br/>
    private Map colorValuesToSet = new HashMap(7);<br/>
<br/>
    /**<br/>
     * The default color preview composite.<br/>
     */<br/>
    private Composite defaultColorPreview;<br/>
    <br/>
    /**<br/>
     * The default font preview composite.<br/>
     */<br/>
    private Composite defaultFontPreview;<br/>
    <br/>
    /**<br/>
     * The composite to use when no preview is available.<br/>
     */<br/>
    private Composite defaultNoPreview;<br/>
    <br/>
&nbsp;&nbsp;&nbsp;&nbsp;/**<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * Currently selected font for preview; might be null.<br/>
&nbsp;&nbsp;&nbsp;&nbsp; */<br/>
&nbsp;&nbsp;&nbsp;&nbsp;private Font currentFont;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;/**<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * Currently selected color for preview; might be null. <br/>
&nbsp;&nbsp;&nbsp;&nbsp; */<br/>
&nbsp;&nbsp;&nbsp;&nbsp;private Color currentColor;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;/**<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * Canvas used to draw default color preview <br/>
&nbsp;&nbsp;&nbsp;&nbsp; */<br/>
&nbsp;&nbsp;&nbsp;&nbsp;private Canvas colorSampler;<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;/**<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * Canvas used to draw default font preview<br/>
&nbsp;&nbsp;&nbsp;&nbsp; */<br/>
&nbsp;&nbsp;&nbsp;&nbsp;private Canvas fontSampler;<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;private String fontSampleText;<br/>
<br/>
    private List dialogFontWidgets = new ArrayList();<br/>
<br/>
    private Button fontChangeButton;<br/>
<br/>
    /**<br/>
     * The button to edit the default of the selected element.<br/>
     * @since 3.7<br/>
     */<br/>
&nbsp;&nbsp;&nbsp;&nbsp;private Button editDefaultButton;<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;/**<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * The button to go to the default of the selected element.<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * <br/>
&nbsp;&nbsp;&nbsp;&nbsp; * @since 3.7<br/>
&nbsp;&nbsp;&nbsp;&nbsp; */<br/>
&nbsp;&nbsp;&nbsp;&nbsp;private Button goToDefaultButton;<br/>
<br/>
    private Map fontPreferencesToSet = new HashMap(7);<br/>
<br/>
    private CascadingFontRegistry fontRegistry;<br/>
<br/>
    private Button fontResetButton;<br/>
<br/>
    private Button fontSystemButton;<br/>
<br/>
    /**<br/>
     * Map of definition id-&gt;FontData[] objects that map to changes expressed in<br/>
     * this UI session.  These changes should be made in preferences and the<br/>
     * registry.<br/>
     */<br/>
    private Map fontValuesToSet = new HashMap(7);<br/>
<br/>
    /**<br/>
     * The composite that is parent to all previews.<br/>
     */<br/>
    private Composite previewComposite;<br/>
<br/>
    /**<br/>
     * A mapping from PresentationCategory-&gt;Composite for the created previews.<br/>
     */<br/>
    private Map previewMap = new HashMap(7);<br/>
<br/>
    /**<br/>
     * Set containing all IPresentationPreviews created.<br/>
     */<br/>
    private Set previewSet = new HashSet(7);<br/>
<br/>
    /**<br/>
     * The layout for the previewComposite.<br/>
     */<br/>
    private StackLayout stackLayout;<br/>
<br/>
    private final IThemeRegistry themeRegistry;<br/>
<br/>
    private ITheme currentTheme;<br/>
<br/>
    private PresentationLabelProvider labelProvider;<br/>
<br/>
    private CascadingTheme cascadingTheme;<br/>
<br/>
    private IPropertyChangeListener themeChangeListener;<br/>
<br/>
    private Workbench workbench;<br/>
<br/>
    private FilteredTree tree;<br/>
    <br/>
&nbsp;&nbsp;&nbsp;&nbsp;private Text descriptionText;<br/>
<br/>
    /**<br/>
     * Create a new instance of the receiver.<br/>
     */<br/>
    public ColorsAndFontsPreferencePage() {<br/>
        themeRegistry = WorkbenchPlugin.getDefault().getThemeRegistry();<br/>
        //no-op<br/>
    }<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;/**<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * {@inheritDoc}<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * &lt;p&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * Everything else except the following string patterns is ignored:<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * &lt;ul&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * &lt;li&gt;&lt;strong&gt;selectCategory:&lt;/strong&gt;ID - selects and expands the category<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * with the given ID&lt;/li&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * &lt;li&gt;&lt;strong&gt;selectFont:&lt;/strong&gt;ID - selects the font with the given ID&lt;/li&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * &lt;li&gt;&lt;strong&gt;selectColor:&lt;/strong&gt;ID - selects the color with the given ID<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * &lt;/li&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * &lt;/p&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * <br/>
&nbsp;&nbsp;&nbsp;&nbsp; * @param data<br/>
&nbsp;&nbsp;&nbsp;&nbsp; *            the data to be applied<br/>
&nbsp;&nbsp;&nbsp;&nbsp; */<br/>
&nbsp;&nbsp;&nbsp;&nbsp;public void applyData(Object data) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (tree == null || !(data instanceof String))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ThemeRegistry themeRegistry = (ThemeRegistry) tree.getViewer().getInput();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String command = (String) data;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (command.startsWith("selectCategory:")) { //$NON-NLS-1$<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String categoryId = command.substring(15);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ThemeElementCategory category = themeRegistry.findCategory(categoryId);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (category != null) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;selectAndReveal(category);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tree.getViewer().expandToLevel(category, 1);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else if (command.startsWith("selectFont:")) { //$NON-NLS-1$<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String id = command.substring(11);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FontDefinition fontDef = themeRegistry.findFont(id);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (fontDef != null) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;selectAndReveal(fontDef);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else if (command.startsWith("selectColor:")) { //$NON-NLS-1$<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String id = command.substring(12);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ColorDefinition colorDef = themeRegistry.findColor(id);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (colorDef != null) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;selectAndReveal(colorDef);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;/**<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * Selects and reveals the given element.<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * <br/>
&nbsp;&nbsp;&nbsp;&nbsp; * @param selection<br/>
&nbsp;&nbsp;&nbsp;&nbsp; *            the object to select and reveal<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * @since 3.7<br/>
&nbsp;&nbsp;&nbsp;&nbsp; */<br/>
&nbsp;&nbsp;&nbsp;&nbsp;private void selectAndReveal(Object selection) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TreeViewer viewer = tree.getViewer();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;viewer.setSelection(new StructuredSelection(selection), <span class="mv">true</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;viewer.reveal(selection);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;viewer.getTree().setFocus();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
<br/>
    private static boolean equals(String string, String string2) {<br/>
        if ((string == null &amp;&amp; string2 == null))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="mv">return true;</span><br/>
        if (string == null || string2 == null)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="del">return <span class="mv">false</span>;</span><br/>
        if (string.equals(string2))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="del">return <span class="mv">true</span>;</span><br/>
        <span class="mv">return false;</span><br/>
    }<br/>
<br/>
    /**<br/>
     * Create a button for the preference page.<br/>
     * @param parent<br/>
     * @param label<br/>
     */<br/>
    private Button createButton(Composite parent, String label) {<br/>
        Button button = new Button(parent, SWT.PUSH | SWT.CENTER);<br/>
        button.setText(label);<br/>
        myApplyDialogFont(button);<br/>
        setButtonLayoutData(button);<br/>
        button.setEnabled(<span class="mv">false</span>);<br/>
        return button;<br/>
    }<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;private Label createSeparator(Composite parent) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Label separator = new Label(parent, SWT.NONE);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;separator.setFont(parent.getFont());<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;separator.setVisible(<span class="mv">false</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GridData gd = new GridData();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gd.horizontalAlignment = GridData.FILL;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gd.verticalAlignment = GridData.BEGINNING;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gd.heightHint = 4;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;separator.setLayoutData(gd);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return separator;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
<br/>
<br/>
    /* (non-Javadoc)<br/>
     * @see org.eclipse.jface.preference.PreferencePage#createContents(org.eclipse.swt.widgets.Composite)<br/>
     */<br/>
    protected Control createContents(Composite parent) {<br/>
    &nbsp;&nbsp;&nbsp;&nbsp;PlatformUI.getWorkbench().getHelpSystem().setHelp(parent, IWorkbenchHelpContextIds.FONTS_PREFERENCE_PAGE);<br/>
    &nbsp;&nbsp;&nbsp;&nbsp;<br/>
        parent.addDisposeListener(new DisposeListener() {<br/>
            public void widgetDisposed(DisposeEvent e) {<br/>
                if (appliedDialogFont != null)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;appliedDialogFont.dispose();<br/>
            }<br/>
        });<br/>
        <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final SashForm advancedComposite = new SashForm(parent, SWT.VERTICAL);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GridData sashData = new GridData(SWT.FILL, SWT.FILL, true, <span class="mv">true</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;advancedComposite.setLayoutData(sashData);<br/>
        <br/>
        Composite mainColumn = new Composite(advancedComposite, SWT.NONE);<br/>
        GridLayout layout = new GridLayout();<br/>
        layout.numColumns = 2;<br/>
        layout.marginWidth = 0;<br/>
        layout.marginHeight = 0;<br/>
        mainColumn.setFont(parent.getFont());<br/>
        mainColumn.setLayout(layout);<br/>
<br/>
        GridData data = new GridData(GridData.BEGINNING);<br/>
        data.horizontalSpan = 2;<br/>
        Label label = new Label(mainColumn, SWT.LEFT);<br/>
        label.setText(RESOURCE_BUNDLE.getString("colorsAndFonts")); //$NON-NLS-1$<br/>
        myApplyDialogFont(label);<br/>
        label.setLayoutData(data);<br/>
<br/>
        createTree(mainColumn);<br/>
        <br/>
        // --- buttons<br/>
        Composite controlColumn = new Composite(mainColumn, SWT.NONE);<br/>
        data = new GridData(GridData.FILL_VERTICAL);<br/>
        controlColumn.setLayoutData(data);<br/>
        layout = new GridLayout();<br/>
        layout.marginHeight = 0;<br/>
        layout.marginWidth = 0;<br/>
        controlColumn.setLayout(layout);<br/>
        <br/>
        // we need placeholder to offset the filter control of the table<br/>
        Label placeholder = new Label(controlColumn, SWT.NONE);<br/>
        GridData placeholderData = new GridData(SWT.TOP);<br/>
        placeholderData.heightHint = convertVerticalDLUsToPixels(12);<br/>
        placeholder.setLayoutData(placeholderData);<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fontChangeButton = createButton(controlColumn, RESOURCE_BUNDLE.getString("openChange")); //$NON-NLS-1$<br/>
        fontSystemButton = createButton(controlColumn, WorkbenchMessages.FontsPreference_useSystemFont);<br/>
        fontResetButton = createButton(controlColumn, RESOURCE_BUNDLE.getString("reset")); //$NON-NLS-1$<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;createSeparator(controlColumn);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;editDefaultButton = createButton(controlColumn, RESOURCE_BUNDLE.getString("editDefault")); //$NON-NLS-1$<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goToDefaultButton = createButton(controlColumn, RESOURCE_BUNDLE.getString("goToDefault")); //$NON-NLS-1$<br/>
        // --- end of buttons<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;createDescriptionControl(mainColumn);<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Composite previewColumn = new Composite(advancedComposite, SWT.NONE);<br/>
        GridLayout previewLayout = new GridLayout();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;previewLayout.marginTop = 7;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;previewLayout.marginWidth = 0;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;previewLayout.marginHeight = 0;<br/>
        previewColumn.setFont(parent.getFont());<br/>
        previewColumn.setLayout(previewLayout);<br/>
        <br/>
        // --- create preview control<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Composite composite = new Composite(previewColumn, SWT.NONE);<br/>
<br/>
        GridData data2 = new GridData(GridData.FILL_BOTH);<br/>
        composite.setLayoutData(data2);<br/>
        GridLayout layout2 = new GridLayout(1, <span class="mv">true</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;layout2.marginHeight = 0;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;layout2.marginWidth = 0;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;composite.setLayout(layout2);<br/>
        <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Label label2 = new Label(composite, SWT.LEFT);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;label2.setText(RESOURCE_BUNDLE.getString("preview")); //$NON-NLS-1$<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;myApplyDialogFont(label2);<br/>
        <br/>
        previewComposite = new Composite(composite, SWT.NONE);<br/>
        previewComposite.setLayoutData(new GridData(GridData.FILL_BOTH));<br/>
        stackLayout = new StackLayout();<br/>
        stackLayout.marginHeight = 0;<br/>
        stackLayout.marginWidth = 0;<br/>
        previewComposite.setLayout(stackLayout);<br/>
        // -- end of preview control<br/>
         <br/>
        <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;defaultFontPreview = createFontPreviewControl();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;defaultColorPreview = createColorPreviewControl();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;defaultNoPreview = createNoPreviewControl();<br/>
        <br/>
        hookListeners();<br/>
        <br/>
        updateTreeSelection(tree.getViewer().getSelection());<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;advancedComposite.setWeights(new int[] { 75, 25 });<br/>
        return advancedComposite;<br/>
    }<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;/**<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * Create the &lt;code&gt;ListViewer&lt;/code&gt; that will contain all color<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * definitions as defined in the extension point.<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * <br/>
&nbsp;&nbsp;&nbsp;&nbsp; * @param parent<br/>
&nbsp;&nbsp;&nbsp;&nbsp; *            the parent &lt;code&gt;Composite&lt;/code&gt;.<br/>
&nbsp;&nbsp;&nbsp;&nbsp; */<br/>
&nbsp;&nbsp;&nbsp;&nbsp;private void createTree(Composite parent) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;labelProvider = new PresentationLabelProvider();<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Create a custom pattern matcher that will allow<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// non-category elements to be returned in the event that their children<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// do not and also search the descriptions.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PatternFilter filter = new PatternFilter() {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; * (non-Javadoc)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; * @see org.eclipse.ui.dialogs.PatternFilter#isLeafMatch(org.eclipse.jface.viewers.Viewer, java.lang.Object)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; * @since 3.7<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; */<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;protected boolean isLeafMatch(Viewer viewer, Object element) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (super.isLeafMatch(viewer, element))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="del">return <span class="mv">true</span>;</span><br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String text = null;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (element instanceof ICategorizedThemeElementDefinition)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text = ((ICategorizedThemeElementDefinition) element).getDescription();<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return text != null ? wordMatches(text) : <span class="mv">false</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;filter.setIncludeLeadingWildcard(<span class="mv">true</span>);<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tree = new FilteredTree(parent, SWT.SINGLE | SWT.H_SCROLL | SWT.V_SCROLL | SWT.BORDER,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;filter, <span class="mv">true</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GridData data = new GridData(GridData.FILL_BOTH | GridData.VERTICAL_ALIGN_FILL);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;data.widthHint = Math.max(285, convertWidthInCharsToPixels(30));<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;data.heightHint = Math.max(175, convertHeightInCharsToPixels(10));<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tree.setLayoutData(data);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;myApplyDialogFont(tree.getViewer().getControl());<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Text filterText = tree.getFilterControl();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (filterText != null)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;myApplyDialogFont(filterText);<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tree.getViewer().setLabelProvider(labelProvider);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tree.getViewer().setContentProvider(new ThemeContentProvider());<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tree.getViewer().setComparator(new ViewerComparator() {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public int category(Object element) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (element instanceof ThemeElementCategory)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 1;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tree.getViewer().setInput(WorkbenchPlugin.getDefault().getThemeRegistry());<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tree.getViewer().addDoubleClickListener(new IDoubleClickListener() {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public void doubleClick(DoubleClickEvent event) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IStructuredSelection s = (IStructuredSelection) event.getSelection();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Object element = s.getFirstElement();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (tree.getViewer().isExpandable(element))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tree.getViewer().setExpandedState(element,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!tree.getViewer().getExpandedState(element));<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (element instanceof FontDefinition)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;editFont(tree.getDisplay());<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else if (element instanceof ColorDefinition)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;editColor(tree.getDisplay());<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;updateControls();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;restoreTreeExpansion();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;restoreTreeSelection();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
<br/>
    /* (non-Javadoc)<br/>
     * @see org.eclipse.jface.dialogs.IDialogPage#dispose()<br/>
     */<br/>
    public void dispose() {<br/>
        super.dispose();<br/>
        <br/>
        workbench.getThemeManager().removePropertyChangeListener(themeChangeListener);<br/>
        clearPreviews();<br/>
        // also dispose elements used by default previewers<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (currentFont != null &amp;&amp; !currentFont.isDisposed()) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;currentFont.dispose();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;currentFont = null;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (currentColor != null &amp;&amp; !currentColor.isDisposed()) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;currentColor.dispose();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;currentColor = null;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
        colorRegistry.dispose();<br/>
        fontRegistry.dispose();<br/>
    }<br/>
<br/>
    /**<br/>
     * Clear all previews.<br/>
     */<br/>
    private void clearPreviews() {<br/>
        if (cascadingTheme != null)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cascadingTheme.dispose();<br/>
<br/>
        for (Iterator i = previewSet.iterator(); i.hasNext();) {<br/>
            IThemePreview preview = (IThemePreview) i.next();<br/>
            try {<br/>
                preview.dispose();<br/>
            } catch (RuntimeException e) {<br/>
                WorkbenchPlugin.log(RESOURCE_BUNDLE.getString("errorDisposePreviewLog"), //$NON-NLS-1$ <br/>
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;StatusUtil.newStatus(IStatus.ERROR, e.getMessage(), e));<br/>
            }<br/>
        }<br/>
        previewSet.clear();<br/>
    }<br/>
<br/>
    /**<br/>
     * Get the ancestor of the given color, if any.<br/>
     * <br/>
     * @param definition the descendant &lt;code&gt;ColorDefinition&lt;/code&gt;.<br/>
     * @return the ancestor &lt;code&gt;ColorDefinition&lt;/code&gt;, or &lt;code&gt;null&lt;/code&gt;<br/>
     * &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if none.<br/>
     */<br/>
    private ColorDefinition getColorAncestor(ColorDefinition definition) {<br/>
        String defaultsTo = definition.getDefaultsTo();<br/>
        if (defaultsTo == null)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return null;<br/>
        return themeRegistry.findColor(defaultsTo);<br/>
    }<br/>
<br/>
    /**<br/>
     * Get the RGB value of the given colors ancestor, if any.<br/>
     * <br/>
     * @param definition the descendant &lt;code&gt;ColorDefinition&lt;/code&gt;.<br/>
     * @return the ancestor &lt;code&gt;RGB&lt;/code&gt;, or &lt;code&gt;null&lt;/code&gt; if none.<br/>
     */<br/>
    private RGB getColorAncestorValue(ColorDefinition definition) {<br/>
        ColorDefinition ancestor = getColorAncestor(definition);<br/>
        if (ancestor == null)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return null;<br/>
        return getColorValue(ancestor);<br/>
    }<br/>
<br/>
    /**<br/>
     * Get the RGB value for the specified definition.  Cascades through<br/>
     * preferenceToSet, valuesToSet and finally the registry.<br/>
     * <br/>
     * @param definition the &lt;code&gt;ColorDefinition&lt;/code&gt;.<br/>
     * @return the &lt;code&gt;RGB&lt;/code&gt; value.<br/>
     */<br/>
    private RGB getColorValue(ColorDefinition definition) {<br/>
        String id = definition.getId();<br/>
        RGB updatedRGB = (RGB) colorPreferencesToSet.get(id);<br/>
        if (updatedRGB == null) {<br/>
            updatedRGB = (RGB) colorValuesToSet.get(id);<br/>
            if (updatedRGB == null)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;updatedRGB = currentTheme.getColorRegistry().getRGB(id);<br/>
        }<br/>
        return updatedRGB;<br/>
    }<br/>
<br/>
    /**<br/>
     * Get colors that descend from the provided color.<br/>
     * <br/>
     * @param definition the ancestor &lt;code&gt;ColorDefinition&lt;/code&gt;.<br/>
     * @return the ColorDefinitions that have the provided definition as their<br/>
     * &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;defaultsTo attribute.<br/>
     */<br/>
    private ColorDefinition[] getDescendantColors(ColorDefinition definition) {<br/>
        List list = new ArrayList(5);<br/>
        String id = definition.getId();<br/>
<br/>
        ColorDefinition[] colors = themeRegistry.getColors();<br/>
        ColorDefinition[] sorted = new ColorDefinition[colors.length];<br/>
        System.arraycopy(colors, 0, sorted, 0, sorted.length);<br/>
<br/>
        Arrays.sort(sorted, new IThemeRegistry.HierarchyComparator(colors));<br/>
<br/>
        for (int i = 0; i &lt; sorted.length; i++) {<br/>
            if (id.equals(sorted[i].getDefaultsTo()))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;list.add(sorted[i]);<br/>
        }<br/>
        return (ColorDefinition[]) list.toArray(new ColorDefinition[list.size()]);<br/>
    }<br/>
<br/>
    private FontDefinition[] getDescendantFonts(FontDefinition definition) {<br/>
        List list = new ArrayList(5);<br/>
        String id = definition.getId();<br/>
<br/>
        FontDefinition[] fonts = themeRegistry.getFonts();<br/>
        FontDefinition[] sorted = new FontDefinition[fonts.length];<br/>
        System.arraycopy(fonts, 0, sorted, 0, sorted.length);<br/>
<br/>
        Arrays.sort(sorted, new IThemeRegistry.HierarchyComparator(fonts));<br/>
<br/>
        for (int i = 0; i &lt; sorted.length; i++) {<br/>
            if (id.equals(sorted[i].getDefaultsTo()))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;list.add(sorted[i]);<br/>
        }<br/>
        return (FontDefinition[]) list.toArray(new FontDefinition[list.size()]);<br/>
    }<br/>
<br/>
    private FontDefinition getFontAncestor(FontDefinition definition) {<br/>
        String defaultsTo = definition.getDefaultsTo();<br/>
        if (defaultsTo == null)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return null;<br/>
        return themeRegistry.findFont(defaultsTo);<br/>
    }<br/>
<br/>
    private FontData[] getFontAncestorValue(FontDefinition definition) {<br/>
        FontDefinition ancestor = getFontAncestor(definition);<br/>
        if (ancestor == null) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return PreferenceConverter.getDefaultFontDataArray(<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;getPreferenceStore(), ThemeElementHelper.createPreferenceKey(currentTheme, definition.getId()));<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
        return getFontValue(ancestor);<br/>
    }<br/>
<br/>
    protected FontData[] getFontValue(FontDefinition definition) {<br/>
        String id = definition.getId();<br/>
        FontData[] updatedFD = (FontData[]) fontPreferencesToSet.get(id);<br/>
        if (updatedFD == null) {<br/>
            updatedFD = (FontData[]) fontValuesToSet.get(id);<br/>
            if (updatedFD == null)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;updatedFD = currentTheme.getFontRegistry().getFontData(id);<br/>
        }<br/>
        return updatedFD;<br/>
    }<br/>
<br/>
    protected ColorDefinition getSelectedColorDefinition() {<br/>
        Object o = ((IStructuredSelection) tree.getViewer().getSelection()).getFirstElement();<br/>
        if (o instanceof ColorDefinition)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return (ColorDefinition) o;<br/>
        return null;<br/>
    }<br/>
<br/>
    protected FontDefinition getSelectedFontDefinition() {<br/>
        Object o = ((IStructuredSelection) tree.getViewer().getSelection()).getFirstElement();<br/>
        if (o instanceof FontDefinition)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return (FontDefinition) o;<br/>
        return null;<br/>
    }<br/>
    <br/>
    protected boolean isFontSelected() {<br/>
    &nbsp;&nbsp;&nbsp;&nbsp;Object o = ((IStructuredSelection) tree.getViewer().getSelection()).getFirstElement();<br/>
    &nbsp;&nbsp;&nbsp;&nbsp;return (o instanceof FontDefinition);<br/>
    }<br/>
<br/>
    protected boolean isColorSelected() {<br/>
    &nbsp;&nbsp;&nbsp;&nbsp;Object o = ((IStructuredSelection) tree.getViewer().getSelection()).getFirstElement();<br/>
    &nbsp;&nbsp;&nbsp;&nbsp;return (o instanceof ColorDefinition);<br/>
    }<br/>
    <br/>
    /**<br/>
     * Hook all control listeners.<br/>
     */<br/>
    private void hookListeners() {<br/>
        TreeViewer viewer = tree.getViewer();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;viewer.addSelectionChangedListener(new ISelectionChangedListener() {<br/>
                public void selectionChanged(SelectionChangedEvent event) {<br/>
                    updateTreeSelection(event.getSelection());<br/>
                }<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br/>
        fontChangeButton.addSelectionListener(new SelectionAdapter() {<br/>
            public void widgetSelected(SelectionEvent event) {<br/>
            &nbsp;&nbsp;&nbsp;&nbsp;Display display = event.display;<br/>
            &nbsp;&nbsp;&nbsp;&nbsp;if (isFontSelected())<br/>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;editFont(display);<br/>
            &nbsp;&nbsp;&nbsp;&nbsp;else if (isColorSelected())<br/>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;editColor(display);<br/>
            &nbsp;&nbsp;&nbsp;&nbsp;updateControls();<br/>
            }<br/>
        });<br/>
<br/>
        fontResetButton.addSelectionListener(new SelectionAdapter() {<br/>
<br/>
            public void widgetSelected(SelectionEvent e) {<br/>
            &nbsp;&nbsp;&nbsp;&nbsp;if (isFontSelected())<br/>
                    resetFont(getSelectedFontDefinition());<br/>
            &nbsp;&nbsp;&nbsp;&nbsp;else if (isColorSelected())<br/>
                  resetColor(getSelectedColorDefinition());<br/>
            &nbsp;&nbsp;&nbsp;&nbsp;updateControls();<br/>
            }<br/>
        });<br/>
<br/>
        fontSystemButton.addSelectionListener(new SelectionAdapter() {<br/>
            public void widgetSelected(SelectionEvent event) {<br/>
                FontDefinition definition = getSelectedFontDefinition();<br/>
                if (definition == null)<br/>
                &nbsp;&nbsp;&nbsp;&nbsp;return;<br/>
                FontData[] defaultFontData = JFaceResources.getDefaultFont().getFontData();<br/>
                setFontPreferenceValue(definition, defaultFontData);<br/>
                setRegistryValue(definition, defaultFontData);<br/>
                updateControls();<br/>
            }<br/>
        });<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;editDefaultButton.addSelectionListener(new SelectionAdapter() {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public void widgetSelected(SelectionEvent event) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Display display = event.display;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FontDefinition fontDefinition = getSelectedFontDefinition();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (fontDefinition != null) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String defaultFontId = fontDefinition.getDefaultsTo();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FontDefinition defaultFontDefinition = themeRegistry.findFont(defaultFontId);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;editFont(defaultFontDefinition, display);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ColorDefinition colorDefinition = getSelectedColorDefinition();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (colorDefinition != null) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String defaultColorId = colorDefinition.getDefaultsTo();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ColorDefinition defaultColorDefinition = themeRegistry<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.findColor(defaultColorId);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;editColor(defaultColorDefinition, display);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;updateControls();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goToDefaultButton.addSelectionListener(new SelectionAdapter() {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public void widgetSelected(SelectionEvent event) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FontDefinition fontDefinition = getSelectedFontDefinition();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (fontDefinition != null) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String defaultFontId = fontDefinition.getDefaultsTo();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FontDefinition defaultFontDefinition = themeRegistry.findFont(defaultFontId);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;selectAndReveal(defaultFontDefinition);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ColorDefinition colorDefinition = getSelectedColorDefinition();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (colorDefinition != null) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String defaultColorId = colorDefinition.getDefaultsTo();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ColorDefinition defaultColorDefinition = themeRegistry<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.findColor(defaultColorId);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;selectAndReveal(defaultColorDefinition);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;updateControls();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});<br/>
<br/>
    }<br/>
<br/>
    /* (non-Javadoc)<br/>
     * @see org.eclipse.ui.IWorkbenchPreferencePage#init(org.eclipse.ui.IWorkbench)<br/>
     */<br/>
    public void init(IWorkbench aWorkbench) {<br/>
        this.workbench = (Workbench) aWorkbench;<br/>
        setPreferenceStore(PrefUtil.getInternalPreferenceStore());<br/>
<br/>
        final IThemeManager themeManager = aWorkbench.getThemeManager();<br/>
<br/>
        themeChangeListener = new IPropertyChangeListener() {<br/>
            public void propertyChange(PropertyChangeEvent event) {<br/>
                if (event.getProperty().equals(<br/>
                        IThemeManager.CHANGE_CURRENT_THEME)) {<br/>
                    updateThemeInfo(themeManager);<br/>
                    refreshCategory();<br/>
                    tree.getViewer().refresh(); // refresh all the labels in the tree<br/>
                }<br/>
            }<br/>
        };<br/>
        themeManager.addPropertyChangeListener(themeChangeListener);<br/>
<br/>
        updateThemeInfo(themeManager);<br/>
    }<br/>
<br/>
    private void updateThemeInfo(IThemeManager manager) {<br/>
        clearPreviews();<br/>
        categoryMap.clear();<br/>
<br/>
        if (labelProvider != null)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;labelProvider.dispose(); // nuke the old cache<br/>
<br/>
        currentTheme = manager.getCurrentTheme();<br/>
<br/>
        if (colorRegistry != null)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;colorRegistry.dispose();<br/>
        if (fontRegistry != null)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fontRegistry.dispose();<br/>
<br/>
        currentTheme = manager.getCurrentTheme();<br/>
<br/>
        colorRegistry = new CascadingColorRegistry(currentTheme.getColorRegistry());<br/>
        fontRegistry = new CascadingFontRegistry(currentTheme.getFontRegistry());<br/>
<br/>
        fontPreferencesToSet.clear();<br/>
        fontValuesToSet.clear();<br/>
<br/>
        colorPreferencesToSet.clear();<br/>
        colorValuesToSet.clear();<br/>
<br/>
        if (labelProvider != null)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;labelProvider.hookListeners(); // rehook the listeners<br/>
    }<br/>
<br/>
    /**<br/>
     * Answers whether the definition is currently set to the default value.<br/>
     * <br/>
     * @param definition the &lt;code&gt;ColorDefinition&lt;/code&gt; to check.<br/>
     * @return Return whether the definition is currently mapped to the default<br/>
     * &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;value, either in the preference store or in the local change record<br/>
     * &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;of this preference page.<br/>
     */<br/>
    private boolean isDefault(ColorDefinition definition) {<br/>
        String id = definition.getId();<br/>
<br/>
        if (colorPreferencesToSet.containsKey(id)) {<br/>
            if (definition.getValue() != null) { // value-based color<br/>
                if (colorPreferencesToSet.get(id).equals(definition.getValue()))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="mv">return true;</span><br/>
            } else {<br/>
                if (colorPreferencesToSet.get(id).equals(getColorAncestorValue(definition)))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="mv">return true;</span><br/>
            }<br/>
        } else {<br/>
            if (definition.getValue() != null) { // value-based color<br/>
                if (getPreferenceStore().isDefault(ThemeElementHelper.createPreferenceKey(currentTheme, id)))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="mv">return true;</span><br/>
            } else {<br/>
                // a descendant is default if it's the same value as its ancestor<br/>
                if (getColorValue(definition).equals(getColorAncestorValue(definition)))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="mv">return true;</span><br/>
            }<br/>
        }<br/>
        <span class="del">return <span class="mv">false</span>;</span><br/>
    }<br/>
<br/>
    private boolean isDefault(FontDefinition definition) {<br/>
        String id = definition.getId();<br/>
<br/>
        if (fontPreferencesToSet.containsKey(id)) {<br/>
            if (definition.getValue() != null) { // value-based font<br/>
                if (Arrays.equals((FontData[]) fontPreferencesToSet.get(id), definition.getValue()))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="mv">return true;</span><br/>
            } else {<br/>
                FontData[] ancestor = getFontAncestorValue(definition);<br/>
                if (Arrays.equals((FontData[]) fontPreferencesToSet.get(id), ancestor))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="mv">return true;</span><br/>
            }<br/>
        } else {<br/>
            if (definition.getValue() != null) { // value-based font<br/>
                if (getPreferenceStore().isDefault(ThemeElementHelper.createPreferenceKey(currentTheme, id)))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="mv">return true;</span><br/>
            } else {<br/>
                FontData[] ancestor = getFontAncestorValue(definition);<br/>
                if (ancestor == null)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="mv">return true;</span><br/>
                // a descendant is default if it's the same value as its ancestor<br/>
                if (Arrays.equals(getFontValue(definition), ancestor))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="mv">return true;</span><br/>
            }<br/>
        }<br/>
        <span class="mv">return false;</span><br/>
    }<br/>
<br/>
    /**<br/>
     * Apply the dialog font to the control and store<br/>
     * it for later so that it can be used for a later<br/>
     * update.<br/>
     * @param control<br/>
     */<br/>
    private void myApplyDialogFont(Control control) {<br/>
        control.setFont(JFaceResources.getDialogFont());<br/>
        dialogFontWidgets.add(control);<br/>
    }<br/>
<br/>
    /**<br/>
     * @see org.eclipse.jface.preference.PreferencePage#performApply()<br/>
     */<br/>
    protected void performApply() {<br/>
        super.performApply();<br/>
<br/>
        //Apply the default font to the dialog.<br/>
        Font oldFont = appliedDialogFont;<br/>
        FontDefinition fontDefinition = themeRegistry.findFont(JFaceResources.DIALOG_FONT);<br/>
        if (fontDefinition == null)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;<br/>
        FontData[] newData = getFontValue(fontDefinition);<br/>
<br/>
        appliedDialogFont = new Font(getControl().getDisplay(), newData);<br/>
<br/>
        updateForDialogFontChange(appliedDialogFont);<br/>
        getApplyButton().setFont(appliedDialogFont);<br/>
        getDefaultsButton().setFont(appliedDialogFont);<br/>
<br/>
        if (oldFont != null)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;oldFont.dispose();<br/>
    }<br/>
<br/>
    private void performColorDefaults() {<br/>
        ColorDefinition[] definitions = themeRegistry.getColors();<br/>
<br/>
        // apply defaults in depth-order.<br/>
        ColorDefinition[] definitionsCopy = new ColorDefinition[definitions.length];<br/>
        System.arraycopy(definitions, 0, definitionsCopy, 0,definitions.length);<br/>
<br/>
        Arrays.sort(definitionsCopy, new IThemeRegistry.HierarchyComparator(definitions));<br/>
<br/>
        for (int i = 0; i &lt; definitionsCopy.length; i++) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;resetColor(definitionsCopy[i]);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
    }<br/>
<br/>
    private boolean performColorOk() {<br/>
        for (Iterator i = colorPreferencesToSet.keySet().iterator(); i.hasNext();) {<br/>
            String id = (String) i.next();<br/>
            String key = ThemeElementHelper.createPreferenceKey(currentTheme, id);<br/>
            RGB rgb = (RGB) colorPreferencesToSet.get(id);<br/>
            String rgbString = StringConverter.asString(rgb);<br/>
            String storeString = getPreferenceStore().getString(key);<br/>
<br/>
            if (!rgbString.equals(storeString))<br/>
                getPreferenceStore().setValue(key, rgbString);<br/>
        }<br/>
<br/>
        colorValuesToSet.clear();<br/>
        colorPreferencesToSet.clear();<br/>
        <span class="mv">return true;</span><br/>
    }<br/>
<br/>
    /* (non-Javadoc)<br/>
     * @see org.eclipse.jface.preference.PreferencePage#performDefaults()<br/>
     */<br/>
    protected void performDefaults() {<br/>
        performColorDefaults();<br/>
        performFontDefaults();<br/>
        updateControls();<br/>
    }<br/>
<br/>
    private void performFontDefaults() {<br/>
        FontDefinition[] definitions = themeRegistry.getFonts();<br/>
<br/>
        // apply defaults in depth-order.<br/>
        FontDefinition[] definitionsCopy = new FontDefinition[definitions.length];<br/>
        System.arraycopy(definitions, 0, definitionsCopy, 0, definitions.length);<br/>
<br/>
        Arrays.sort(definitionsCopy, new IThemeRegistry.HierarchyComparator(definitions));<br/>
<br/>
        for (int i = 0; i &lt; definitionsCopy.length; i++) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;resetFont(definitionsCopy[i]);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
    }<br/>
<br/>
    private boolean performFontOk() {<br/>
        for (Iterator i = fontPreferencesToSet.keySet().iterator(); i.hasNext();) {<br/>
            String id = (String) i.next();<br/>
            String key = ThemeElementHelper.createPreferenceKey(currentTheme, id);<br/>
            FontData[] fd = (FontData[]) fontPreferencesToSet.get(id);<br/>
<br/>
            String fdString = PreferenceConverter.getStoredRepresentation(fd);<br/>
            String storeString = getPreferenceStore().getString(key);<br/>
<br/>
            if (!fdString.equals(storeString))<br/>
                getPreferenceStore().setValue(key, fdString);<br/>
        }<br/>
<br/>
        fontValuesToSet.clear();<br/>
        fontPreferencesToSet.clear();<br/>
        <span class="mv">return true;</span><br/>
    }<br/>
<br/>
    /* (non-Javadoc)<br/>
     * @see org.eclipse.jface.preference.IPreferencePage#performOk()<br/>
     */<br/>
    public boolean performOk() {<br/>
    &nbsp;&nbsp;&nbsp;&nbsp;saveTreeExpansion();<br/>
    &nbsp;&nbsp;&nbsp;&nbsp;saveTreeSelection();<br/>
        boolean result =  performColorOk() &amp;&amp; performFontOk();<br/>
        if(result)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PrefUtil.savePrefs();<br/>
        return result;<br/>
    }<br/>
<br/>
    /**<br/>
     * Refreshes the category.<br/>
     */<br/>
    private void refreshCategory() {<br/>
        updateControls();<br/>
    }<br/>
<br/>
    /**<br/>
     * Resets the supplied definition to its default value.<br/>
     * <br/>
     * @param definition the &lt;code&gt;ColorDefinition&lt;/code&gt; to reset.<br/>
     * @return whether any change was made.<br/>
     */<br/>
    private boolean resetColor(ColorDefinition definition) {<br/>
        if (!isDefault(definition)) {<br/>
            RGB newRGB;<br/>
            if (definition.getValue() != null)<br/>
                newRGB = definition.getValue();<br/>
            else<br/>
                newRGB = getColorAncestorValue(definition);<br/>
<br/>
            if (newRGB != null) {<br/>
                setColorPreferenceValue(definition, newRGB);<br/>
                setRegistryValue(definition, newRGB);<br/>
                <span class="mv">return true;</span><br/>
            }<br/>
        }<br/>
        <span class="mv">return false;</span><br/>
    }<br/>
<br/>
    protected boolean resetFont(FontDefinition definition) {<br/>
        if (!isDefault(definition)) {<br/>
            FontData[] newFD;<br/>
            if (definition.getDefaultsTo() != null)<br/>
                newFD = getFontAncestorValue(definition);<br/>
            else<br/>
                newFD = PreferenceConverter.getDefaultFontDataArray(getPreferenceStore(), ThemeElementHelper<br/>
                                .createPreferenceKey(currentTheme, definition.getId()));<br/>
<br/>
            if (newFD != null) {<br/>
                setFontPreferenceValue(definition, newFD);<br/>
                setRegistryValue(definition, newFD);<br/>
                <span class="del">return <span class="mv">true</span>;</span><br/>
            }<br/>
        }<br/>
        <span class="mv">return false;</span><br/>
    }<br/>
<br/>
    /**<br/>
     * Set the value (in preferences) for the given color.<br/>
     * <br/>
     * @param definition the &lt;code&gt;ColorDefinition&lt;/code&gt; to set.<br/>
     * @param newRGB the new &lt;code&gt;RGB&lt;/code&gt; value for the definitions<br/>
     * &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;identifier.<br/>
     */<br/>
    protected void setColorPreferenceValue(ColorDefinition definition, RGB newRGB) {<br/>
        setDescendantRegistryValues(definition, newRGB);<br/>
        colorPreferencesToSet.put(definition.getId(), newRGB);<br/>
    }<br/>
<br/>
    /**<br/>
     * Set the value (in registry) for the given colors children.<br/>
     * <br/>
     * @param definition the &lt;code&gt;ColorDefinition&lt;/code&gt; whose children should<br/>
     * &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;be set.<br/>
     * @param newRGB the new &lt;code&gt;RGB&lt;/code&gt; value for the definitions<br/>
     * &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;identifier.<br/>
     */<br/>
    private void setDescendantRegistryValues(ColorDefinition definition, RGB newRGB) {<br/>
        ColorDefinition[] children = getDescendantColors(definition);<br/>
<br/>
        for (int i = 0; i &lt; children.length; i++) {<br/>
            if (isDefault(children[i])) {<br/>
                setDescendantRegistryValues(children[i], newRGB);<br/>
                setRegistryValue(children[i], newRGB);<br/>
                colorValuesToSet.put(children[i].getId(), newRGB);<br/>
            }<br/>
        }<br/>
    }<br/>
<br/>
    private void setDescendantRegistryValues(FontDefinition definition, FontData[] datas) {<br/>
        FontDefinition[] children = getDescendantFonts(definition);<br/>
<br/>
        for (int i = 0; i &lt; children.length; i++) {<br/>
            if (isDefault(children[i])) {<br/>
                setDescendantRegistryValues(children[i], datas);<br/>
                setRegistryValue(children[i], datas);<br/>
                fontValuesToSet.put(children[i].getId(), datas);<br/>
            }<br/>
        }<br/>
    }<br/>
<br/>
    protected void setFontPreferenceValue(FontDefinition definition, FontData[] datas) {<br/>
        setDescendantRegistryValues(definition, datas);<br/>
        fontPreferencesToSet.put(definition.getId(), datas);<br/>
    }<br/>
<br/>
    /**<br/>
     * Updates the working registry.<br/>
     * @param definition<br/>
     * @param newRGB<br/>
     */<br/>
    protected void setRegistryValue(ColorDefinition definition, RGB newRGB) {<br/>
        colorRegistry.put(definition.getId(), newRGB);<br/>
    }<br/>
<br/>
    protected void setRegistryValue(FontDefinition definition, FontData[] datas) {<br/>
        fontRegistry.put(definition.getId(), datas);<br/>
    }<br/>
<br/>
    /**<br/>
     * Returns the preview for the category.<br/>
     * @param category the category<br/>
     * @return the preview for the category, or its ancestors preview if it does not have one.<br/>
     */<br/>
    private IThemePreview getThemePreview(ThemeElementCategory category) throws CoreException {<br/>
        IThemePreview preview = category.createPreview();<br/>
        if (preview != null)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return preview;<br/>
<br/>
        if (category.getParentId() != null) {<br/>
            int idx = Arrays.binarySearch(themeRegistry.getCategories(),<br/>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;category.getParentId(), IThemeRegistry.ID_COMPARATOR);<br/>
            if (idx &gt;= 0)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return getThemePreview(themeRegistry.getCategories()[idx]);<br/>
        }<br/>
        return null;<br/>
    }<br/>
<br/>
    private ITheme getCascadingTheme() {<br/>
        if (cascadingTheme == null)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cascadingTheme = new CascadingTheme(currentTheme, colorRegistry, fontRegistry);<br/>
        return cascadingTheme;<br/>
    }<br/>
<br/>
    /**<br/>
     * Update for a change in the dialog font.<br/>
     * @param newFont<br/>
     */<br/>
    private void updateForDialogFontChange(Font newFont) {<br/>
        Iterator iterator = dialogFontWidgets.iterator();<br/>
        while (iterator.hasNext()) {<br/>
            ((Control) iterator.next()).setFont(newFont);<br/>
        }<br/>
<br/>
        //recalculate the fonts for the tree<br/>
        labelProvider.clearFontCacheAndUpdate();<br/>
    }<br/>
    <br/>
    private void updateTreeSelection(ISelection selection) {<br/>
    &nbsp;&nbsp;&nbsp;&nbsp;ThemeElementCategory category = null;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;    Object element = ((IStructuredSelection) selection).getFirstElement();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;    if (element instanceof ThemeElementCategory) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;    &nbsp;&nbsp;&nbsp;&nbsp;category = (ThemeElementCategory) element;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;    } else if (element instanceof ColorDefinition) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;    &nbsp;&nbsp;&nbsp;&nbsp;String categoryID = ((ColorDefinition) element).getCategoryId();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;    &nbsp;&nbsp;&nbsp;&nbsp;category = WorkbenchPlugin.getDefault().getThemeRegistry().findCategory(categoryID);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;    } else if (element instanceof FontDefinition) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;    &nbsp;&nbsp;&nbsp;&nbsp;String categoryID = ((FontDefinition) element).getCategoryId();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;    &nbsp;&nbsp;&nbsp;&nbsp;category = WorkbenchPlugin.getDefault().getThemeRegistry().findCategory(categoryID);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;    }<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Composite previewControl = null;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (category != null) { // check if there is a preview for it<br/>
&nbsp;&nbsp;&nbsp;&nbsp;        previewControl = (Composite) previewMap.get(category);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;        if (previewControl == null) {<br/>
                try {<br/>
                    IThemePreview preview = getThemePreview(category);<br/>
                    if (preview != null) {<br/>
                        previewControl = new Composite(previewComposite, SWT.NONE);<br/>
                        previewControl.setLayout(new FillLayout());<br/>
                        ITheme theme = getCascadingTheme();<br/>
                        preview.createControl(previewControl, theme);<br/>
                        previewSet.add(preview);<br/>
                        previewMap.put(category, previewControl);<br/>
                    }<br/>
                } catch (CoreException e) {<br/>
                    previewControl = new Composite(previewComposite, SWT.NONE);<br/>
                    previewControl.setLayout(new FillLayout());<br/>
                    myApplyDialogFont(previewControl);<br/>
                    Text error = new Text(previewControl, SWT.WRAP | SWT.READ_ONLY);<br/>
                    error.setText(RESOURCE_BUNDLE.getString("errorCreatingPreview")); //$NON-NLS-1$<br/>
                    WorkbenchPlugin.log(RESOURCE_BUNDLE.getString("errorCreatePreviewLog"), //$NON-NLS-1$ <br/>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;StatusUtil.newStatus(IStatus.ERROR, e.getMessage(), e));<br/>
                }<br/>
&nbsp;&nbsp;&nbsp;&nbsp;        }<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
    &nbsp;&nbsp;&nbsp;&nbsp;<br/>
        if (previewControl == null) { // there is no preview for this theme, use default preview<br/>
        &nbsp;&nbsp;&nbsp;&nbsp;if (element instanceof ColorDefinition)<br/>
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;previewControl = defaultColorPreview;<br/>
        &nbsp;&nbsp;&nbsp;&nbsp;else if (element instanceof FontDefinition)<br/>
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;previewControl = defaultFontPreview;<br/>
        &nbsp;&nbsp;&nbsp;&nbsp;else<br/>
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;previewControl = defaultNoPreview;<br/>
        }<br/>
<br/>
        stackLayout.topControl = previewControl;<br/>
        previewComposite.layout();<br/>
        updateControls();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
<br/>
    /**<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * Restore the selection state of the tree.<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * @since 3.1<br/>
&nbsp;&nbsp;&nbsp;&nbsp; */<br/>
&nbsp;&nbsp;&nbsp;&nbsp;private void restoreTreeSelection() {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String selectedElementString = getPreferenceStore().getString(SELECTED_ELEMENT_PREF);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (selectedElementString == null)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Object element = findElementFromMarker(selectedElementString);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (element == null)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tree.getViewer().setSelection(new StructuredSelection(element), <span class="mv">true</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;/**<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * Save the selection state of the tree.<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * @since 3.1<br/>
&nbsp;&nbsp;&nbsp;&nbsp; */<br/>
&nbsp;&nbsp;&nbsp;&nbsp;private void saveTreeSelection() {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IStructuredSelection selection = (IStructuredSelection) tree.getViewer().getSelection();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Object element = selection.getFirstElement();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;StringBuffer buffer = new StringBuffer();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;appendMarkerToBuffer(buffer, element);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (buffer.length() &gt; 0)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buffer.append(((IThemeElementDefinition) element).getId());<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;getPreferenceStore().setValue(SELECTED_ELEMENT_PREF, buffer.toString());<br/>
&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;/**<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * Restore the expansion state of the tree.<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * @since 3.1<br/>
&nbsp;&nbsp;&nbsp;&nbsp; */<br/>
&nbsp;&nbsp;&nbsp;&nbsp;private void restoreTreeExpansion() {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String expandedElementsString = getPreferenceStore().getString(EXPANDED_ELEMENTS_PREF);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (expandedElementsString == null)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String[] expandedElementIDs = Util.getArrayFromList(expandedElementsString, EXPANDED_ELEMENTS_TOKEN);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (expandedElementIDs.length == 0)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List elements = new ArrayList(expandedElementIDs.length);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for (int i = 0; i &lt; expandedElementIDs.length; i++) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IThemeElementDefinition def = findElementFromMarker(expandedElementIDs[i]);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (def != null)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;elements.add(def);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tree.getViewer().setExpandedElements(elements.toArray());<br/>
&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;/**<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * Find the theme element from the given string. It will check the first<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * character against the known constants and then call the appropriate<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * method on the theme registry. If the element does not exist or the string<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * is invalid &lt;code&gt;null&lt;/code&gt; is returned.<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * <br/>
&nbsp;&nbsp;&nbsp;&nbsp; * @param string the string to parse<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * @return the element, or &lt;code&gt;null&lt;/code&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp; */<br/>
&nbsp;&nbsp;&nbsp;&nbsp;private IThemeElementDefinition findElementFromMarker(String string) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (string.length() &lt; 2)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return null;<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;char marker = string.charAt(0);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String id = string.substring(1);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IThemeElementDefinition def = null;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;switch (marker) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case MARKER_FONT:<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;def = themeRegistry.findFont(id);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case MARKER_COLOR:<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;def = themeRegistry.findColor(id);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case MARKER_CATEGORY:<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;def = themeRegistry.findCategory(id);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return def;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;/**<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * Saves the expansion state of the tree.<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * @since 3.1<br/>
&nbsp;&nbsp;&nbsp;&nbsp; */<br/>
&nbsp;&nbsp;&nbsp;&nbsp;private void saveTreeExpansion() {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Object[] elements = tree.getViewer().getExpandedElements();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List elementIds = new ArrayList(elements.length);<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;StringBuffer buffer = new StringBuffer();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for (int i = 0; i &lt; elements.length; i++) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Object object = elements[i];<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;appendMarkerToBuffer(buffer, object);<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (buffer.length() != 0) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buffer.append(((IThemeElementDefinition) object).getId());<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;elementIds.add(buffer.toString());<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buffer.setLength(0);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for (Iterator i = elementIds.iterator(); i.hasNext();) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String id = (String) i.next();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buffer.append(id);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (i.hasNext()) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buffer.append(EXPANDED_ELEMENTS_TOKEN);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;getPreferenceStore().setValue(EXPANDED_ELEMENTS_PREF, buffer.toString());<br/>
&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;private void appendMarkerToBuffer(StringBuffer buffer, Object object) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (object instanceof FontDefinition) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buffer.append(MARKER_FONT);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else if (object instanceof ColorDefinition) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buffer.append(MARKER_COLOR);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else if (object instanceof ThemeElementCategory) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buffer.append(MARKER_CATEGORY);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;/**<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * Edit the currently selected font.<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * <br/>
&nbsp;&nbsp;&nbsp;&nbsp; * @param display<br/>
&nbsp;&nbsp;&nbsp;&nbsp; *            the display to open the dialog on<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * @since 3.2<br/>
&nbsp;&nbsp;&nbsp;&nbsp; */<br/>
&nbsp;&nbsp;&nbsp;&nbsp;private void editFont(Display display) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;editFont(getSelectedFontDefinition(), display);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;/**<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * Edit the given font.<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * <br/>
&nbsp;&nbsp;&nbsp;&nbsp; * @param definition<br/>
&nbsp;&nbsp;&nbsp;&nbsp; *            the font definition<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * @param display<br/>
&nbsp;&nbsp;&nbsp;&nbsp; *            the display to open the dialog on<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * @since 3.7<br/>
&nbsp;&nbsp;&nbsp;&nbsp; */<br/>
&nbsp;&nbsp;&nbsp;&nbsp;private void editFont(FontDefinition definition, Display display) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (definition != null) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final FontDialog fontDialog = new FontDialog(getShell());<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fontDialog.setFontList(getFontValue(definition));<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final FontData data = fontDialog.open();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (data != null) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;setFontPreferenceValue(definition, fontDialog.getFontList());<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;setRegistryValue(definition, fontDialog.getFontList());<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;private void editColor(Display display) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;editColor(getSelectedColorDefinition(), display);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;private void editColor(ColorDefinition definition, Display display) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (definition == null)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RGB currentColor = colorRegistry.getRGB(definition.getId());<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ColorDialog colorDialog = new ColorDialog(display.getActiveShell());<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;colorDialog.setRGB(currentColor);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RGB selectedColor =  colorDialog.open();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ((selectedColor != null) &amp;&amp; (!selectedColor.equals(currentColor))) {<br/>
             setColorPreferenceValue(definition, selectedColor);<br/>
             setRegistryValue(definition, selectedColor);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;protected void updateControls() {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FontDefinition fontDefinition = getSelectedFontDefinition();<br/>
        if (fontDefinition != null) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;boolean isDefault = isDefault(fontDefinition);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;boolean hasDefault = fontDefinition.getDefaultsTo() != null;<br/>
            fontChangeButton.setEnabled(<span class="mv">true</span>);<br/>
            fontSystemButton.setEnabled(<span class="mv">true</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fontResetButton.setEnabled(!isDefault);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;editDefaultButton.setEnabled(hasDefault &amp;&amp; isDefault);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goToDefaultButton.setEnabled(hasDefault);<br/>
            setCurrentFont(fontDefinition);<br/>
            return;<br/>
        }<br/>
        ColorDefinition colorDefinition = getSelectedColorDefinition();<br/>
        if (colorDefinition != null) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;boolean isDefault = isDefault(getSelectedColorDefinition());<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;boolean hasDefault = colorDefinition.getDefaultsTo() != null;<br/>
            fontChangeButton.setEnabled(<span class="del">true</span>);<br/>
            fontSystemButton.setEnabled(<span class="mv">false</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fontResetButton.setEnabled(!isDefault);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;editDefaultButton.setEnabled(hasDefault &amp;&amp; isDefault);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goToDefaultButton.setEnabled(hasDefault);<br/>
            setCurrentColor(colorDefinition);<br/>
            return;<br/>
        }<br/>
        // not a font or a color?<br/>
        fontChangeButton.setEnabled(<span class="mv">false</span>);<br/>
        fontSystemButton.setEnabled(<span class="mv">false</span>);<br/>
        fontResetButton.setEnabled(<span class="mv">false</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;editDefaultButton.setEnabled(<span class="mv">false</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goToDefaultButton.setEnabled(<span class="mv">false</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;descriptionText.setText(""); //$NON-NLS-1$<br/>
&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<br/>
    /**<br/>
     * @return Return the default "No preview available." preview.<br/>
     */<br/>
&nbsp;&nbsp;&nbsp;&nbsp;private Composite createNoPreviewControl() {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Composite noPreviewControl = new Composite(previewComposite, SWT.NONE);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;noPreviewControl.setLayout(new FillLayout());<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Label l = new Label(noPreviewControl, SWT.LEFT);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;l.setText(RESOURCE_BUNDLE.getString("noPreviewAvailable")); //$NON-NLS-1$<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;myApplyDialogFont(l);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return noPreviewControl;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;private void setCurrentFont(FontDefinition fontDefinition) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FontData[] fontData = getFontValue(fontDefinition);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (currentFont != null &amp;&amp; !currentFont.isDisposed())<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;currentFont.dispose();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;currentFont = new Font(previewComposite.getDisplay(), fontData);<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// recalculate sample text<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;StringBuffer tmp = new StringBuffer();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for (int i = 0; i &lt; fontData.length; i++) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tmp.append(fontData[i].getName());<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tmp.append(' ');<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tmp.append(fontData[i].getHeight());<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int style = fontData[i].getStyle();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ((style &amp; SWT.BOLD) != 0) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tmp.append(' ');<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tmp.append(RESOURCE_BUNDLE.getString("boldFont")); //$NON-NLS-1$<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ((style &amp; SWT.ITALIC) != 0) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tmp.append(' ');<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tmp.append(RESOURCE_BUNDLE.getString("italicFont")); //$NON-NLS-1$<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fontSampleText = tmp.toString();<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String description = fontDefinition.getDescription();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;descriptionText.setText(description == null ? "" : description); //$NON-NLS-1$<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fontSampler.redraw();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;public void setCurrentColor(ColorDefinition colorDefinition) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RGB color = getColorValue(colorDefinition);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (currentColor != null &amp;&amp; !currentColor.isDisposed())<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;currentColor.dispose();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;currentColor = new Color(previewComposite.getDisplay(), color);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;colorSampler.redraw();<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String description = colorDefinition.getDescription();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;descriptionText.setText(description == null ? "" : description); //$NON-NLS-1$<br/>
&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;private Composite createFontPreviewControl() {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fontSampler = new Canvas(previewComposite, SWT.NONE);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GridLayout gridLayout = new GridLayout();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gridLayout.marginWidth = 0;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gridLayout.marginHeight = 0;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fontSampler.setLayout(gridLayout);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fontSampler.setLayoutData(new GridData(GridData.FILL_BOTH));<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fontSampler.addPaintListener(new PaintListener() {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public void paintControl(PaintEvent e) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (currentFont != null) // do the font preview<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;paintFontSample(e.gc);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return fontSampler;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;private void paintFontSample(GC gc) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (currentFont == null || currentFont.isDisposed())<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// draw rectangle all around<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Rectangle clientArea = colorSampler.getClientArea();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FontMetrics standardFontMetrics = gc.getFontMetrics();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int standardLineHeight = standardFontMetrics.getHeight();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int maxHeight = standardLineHeight * 4;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (clientArea.height &gt; maxHeight)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;clientArea = new Rectangle(clientArea.x, clientArea.y, clientArea.width, maxHeight);<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gc.setForeground(previewComposite.getDisplay().getSystemColor(SWT.COLOR_WIDGET_NORMAL_SHADOW));<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gc.drawRectangle(0, 0, clientArea.width - 1, clientArea.height - 1);<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gc.setForeground(previewComposite.getDisplay().getSystemColor(SWT.COLOR_BLACK));<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gc.setFont(currentFont);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FontMetrics fontMetrics = gc.getFontMetrics();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int lineHeight = fontMetrics.getHeight();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int topY = clientArea.y + 5;<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gc.setClipping(1, 1, clientArea.width - 2, clientArea.height - 2);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gc.drawText(fontSampleText, clientArea.x + 5, topY);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gc.drawText(RESOURCE_BUNDLE.getString("fontTextSample"), clientArea.x + 5, topY + lineHeight); //$NON-NLS-1$<br/>
&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;private Composite createColorPreviewControl() {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;colorSampler = new Canvas(previewComposite, SWT.NONE);<br/>
        GridLayout gridLayout = new GridLayout();<br/>
        gridLayout.marginWidth = 0;<br/>
        gridLayout.marginHeight = 0;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;colorSampler.setLayout(gridLayout);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;colorSampler.setLayoutData(new GridData(GridData.FILL_BOTH));<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;colorSampler.addPaintListener(new PaintListener() {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public void paintControl(PaintEvent e) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (currentColor != null) // do the color preview<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;paintColorSample(e.gc);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return colorSampler;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;private void paintColorSample(GC gc) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (currentColor == null || currentColor.isDisposed())<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gc.setFont(previewComposite.getDisplay().getSystemFont());<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FontMetrics fontMetrics = gc.getFontMetrics();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int lineHeight = fontMetrics.getHeight();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Rectangle clientArea = colorSampler.getClientArea();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int maxHeight = lineHeight * 4;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (clientArea.height &gt; maxHeight)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;clientArea = new Rectangle(clientArea.x, clientArea.y, clientArea.width, maxHeight);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String messageTop = RESOURCE_BUNDLE.getString("fontColorSample"); //$NON-NLS-1$<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RGB rgb = currentColor.getRGB();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String messageBottom = MessageFormat<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.format(<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"RGB({0}, {1}, {2})", new Object[] { new Integer(rgb.red), new Integer(rgb.green), new Integer(rgb.blue) }); //$NON-NLS-1$<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// calculate position of the vertical line<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int separator = (clientArea.width - 2) / 3;<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// calculate text positions<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int verticalCenter = clientArea.height / 2;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int textTopY = (verticalCenter - lineHeight) / 2;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (textTopY &lt; 1)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;textTopY = 1;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;textTopY += clientArea.y;<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int textBottomY = verticalCenter + textTopY;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (textBottomY &gt; clientArea.height - 2)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;textBottomY = clientArea.height - 2;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;textBottomY += clientArea.y;<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int stringWidthTop = gc.stringExtent(messageTop).x;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int textTopX = (separator - stringWidthTop - 1) / 2;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (textTopX &lt; 1)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;textTopX = 1;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;textTopX += clientArea.x;<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int stringWidthBottom = gc.stringExtent(messageBottom).x;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int textBottomX = (separator - stringWidthBottom - 1) / 2;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (textBottomX &lt; 1)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;textBottomX = 1;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;textBottomX += clientArea.x;<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// put text on the left - default background<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gc.setForeground(currentColor);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gc.drawText(messageTop, textTopX, textTopY);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gc.drawText(messageBottom, textBottomX, textBottomY);<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// fill right rectangle<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gc.setBackground(previewComposite.getDisplay().getSystemColor(SWT.COLOR_LIST_BACKGROUND));<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int rightWidth = clientArea.width - 2 - separator * 2;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gc.fillRectangle(separator * 2, 1, rightWidth, clientArea.height - 2);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// put text in the right rectangle<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gc.setForeground(currentColor);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gc.drawText(messageTop, separator * 2 + textTopX, textTopY);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gc.drawText(messageBottom, separator * 2 + textBottomX, textBottomY);<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// fill center rectangle<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gc.setBackground(currentColor);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gc.fillRectangle(separator, 1, separator, clientArea.height - 2);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// text: center top<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gc.setForeground(previewComposite.getDisplay().getSystemColor(SWT.COLOR_BLACK));<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gc.drawText(messageTop, separator + textTopX, textTopY);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gc.setForeground(previewComposite.getDisplay().getSystemColor(SWT.COLOR_WHITE));<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gc.drawText(messageBottom, separator + textBottomX, textBottomY);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// niceties<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gc.setForeground(previewComposite.getDisplay().getSystemColor(SWT.COLOR_WIDGET_NORMAL_SHADOW));<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gc.drawLine(separator, verticalCenter, separator * 2 - 1, verticalCenter);<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// draw rectangle all around<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gc.setForeground(previewComposite.getDisplay().getSystemColor(SWT.COLOR_WIDGET_NORMAL_SHADOW));<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gc.drawRectangle(0, 0, clientArea.width - 1, clientArea.height - 1);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;private void createDescriptionControl(Composite parent) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Composite composite = new Composite(parent, SWT.NONE);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GridLayout layout = new GridLayout();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;layout.marginWidth = 0;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;layout.marginHeight = 0;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;composite.setLayout(layout);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GridData data = new GridData(GridData.FILL_HORIZONTAL);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;data.horizontalSpan = 2;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;composite.setLayoutData(data);<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Label label = new Label(composite, SWT.LEFT);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;label.setText(RESOURCE_BUNDLE.getString("description")); //$NON-NLS-1$<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;myApplyDialogFont(label);<br/>
<br/>
        descriptionText = new Text(composite, SWT.READ_ONLY | SWT.BORDER | SWT.WRAP);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;data = new GridData(GridData.FILL_BOTH);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;data.heightHint = convertHeightInCharsToPixels(3);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;data.widthHint = convertWidthInCharsToPixels(30);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;descriptionText.setLayoutData(data);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;myApplyDialogFont(descriptionText);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
}<br/>
</div>
</div>
</div>
<div class="right">
<h1>right_ColorsAndFontsPreferencePage_1.72.java</h1>
<div class="code">
<div class="id">
/*******************************************************************************<br/>
 * Copyright (c) 2003, 2010 IBM Corporation and others.<br/>
 * All rights reserved. This program and the accompanying materials<br/>
 * are made available under the terms of the Eclipse Public License v1.0<br/>
 * which accompanies this distribution, and is available at<br/>
 * http://www.eclipse.org/legal/epl-v10.html<br/>
 *<br/>
 * Contributors:<br/>
 *     IBM Corporation - initial API and implementation<br/>
 *******************************************************************************/<br/>
package org.eclipse.ui.internal.themes;<br/>
<br/>
import com.ibm.icu.text.MessageFormat;<br/>
import java.util.ArrayList;<br/>
import java.util.Arrays;<br/>
import java.util.HashMap;<br/>
import java.util.HashSet;<br/>
import java.util.Iterator;<br/>
import java.util.List;<br/>
import java.util.Map;<br/>
import java.util.ResourceBundle;<br/>
import java.util.Set;<br/>
import org.eclipse.core.runtime.CoreException;<br/>
import org.eclipse.core.runtime.IStatus;<br/>
import org.eclipse.jface.preference.PreferenceConverter;<br/>
import org.eclipse.jface.preference.PreferencePage;<br/>
import org.eclipse.jface.resource.JFaceResources;<br/>
import org.eclipse.jface.resource.StringConverter;<br/>
import org.eclipse.jface.util.IPropertyChangeListener;<br/>
import org.eclipse.jface.util.PropertyChangeEvent;<br/>
import org.eclipse.jface.viewers.DoubleClickEvent;<br/>
import org.eclipse.jface.viewers.IDoubleClickListener;<br/>
import org.eclipse.jface.viewers.IFontProvider;<br/>
import org.eclipse.jface.viewers.ISelection;<br/>
import org.eclipse.jface.viewers.ISelectionChangedListener;<br/>
import org.eclipse.jface.viewers.IStructuredSelection;<br/>
import org.eclipse.jface.viewers.ITreeContentProvider;<br/>
import org.eclipse.jface.viewers.LabelProvider;<br/>
import org.eclipse.jface.viewers.LabelProviderChangedEvent;<br/>
import org.eclipse.jface.viewers.SelectionChangedEvent;<br/>
import org.eclipse.jface.viewers.StructuredSelection;<br/>
import org.eclipse.jface.viewers.TreeViewer;<br/>
import org.eclipse.jface.viewers.Viewer;<br/>
import org.eclipse.jface.viewers.ViewerComparator;<br/>
import org.eclipse.swt.SWT;<br/>
import org.eclipse.swt.custom.SashForm;<br/>
import org.eclipse.swt.custom.StackLayout;<br/>
import org.eclipse.swt.events.DisposeEvent;<br/>
import org.eclipse.swt.events.DisposeListener;<br/>
import org.eclipse.swt.events.PaintEvent;<br/>
import org.eclipse.swt.events.PaintListener;<br/>
import org.eclipse.swt.events.SelectionAdapter;<br/>
import org.eclipse.swt.events.SelectionEvent;<br/>
import org.eclipse.swt.graphics.Color;<br/>
import org.eclipse.swt.graphics.Font;<br/>
import org.eclipse.swt.graphics.FontData;<br/>
import org.eclipse.swt.graphics.FontMetrics;<br/>
import org.eclipse.swt.graphics.GC;<br/>
import org.eclipse.swt.graphics.Image;<br/>
import org.eclipse.swt.graphics.RGB;<br/>
import org.eclipse.swt.graphics.Rectangle;<br/>
import org.eclipse.swt.layout.FillLayout;<br/>
import org.eclipse.swt.layout.GridData;<br/>
import org.eclipse.swt.layout.GridLayout;<br/>
import org.eclipse.swt.widgets.Button;<br/>
import org.eclipse.swt.widgets.Canvas;<br/>
import org.eclipse.swt.widgets.ColorDialog;<br/>
import org.eclipse.swt.widgets.Composite;<br/>
import org.eclipse.swt.widgets.Control;<br/>
import org.eclipse.swt.widgets.Display;<br/>
import org.eclipse.swt.widgets.FontDialog;<br/>
import org.eclipse.swt.widgets.Label;<br/>
import org.eclipse.swt.widgets.Text;<br/>
import org.eclipse.ui.IWorkbench;<br/>
import org.eclipse.ui.IWorkbenchPreferencePage;<br/>
import org.eclipse.ui.PlatformUI;<br/>
import org.eclipse.ui.dialogs.FilteredTree;<br/>
import org.eclipse.ui.dialogs.PatternFilter;<br/>
import org.eclipse.ui.internal.IWorkbenchGraphicConstants;<br/>
import org.eclipse.ui.internal.IWorkbenchHelpContextIds;<br/>
import org.eclipse.ui.internal.Workbench;<br/>
import org.eclipse.ui.internal.WorkbenchMessages;<br/>
import org.eclipse.ui.internal.WorkbenchPlugin;<br/>
import org.eclipse.ui.internal.misc.StatusUtil;<br/>
import org.eclipse.ui.internal.util.PrefUtil;<br/>
import org.eclipse.ui.internal.util.Util;<br/>
import org.eclipse.ui.themes.ITheme;<br/>
import org.eclipse.ui.themes.IThemeManager;<br/>
import org.eclipse.ui.themes.IThemePreview;<br/>
<br/>
/**<br/>
 * Preference page for management of system colors, gradients and fonts.<br/>
 * <br/>
 * @since 3.0<br/>
 */<br/>
public final class ColorsAndFontsPreferencePage extends PreferencePage<br/>
        implements IWorkbenchPreferencePage {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;private static final String SELECTED_ELEMENT_PREF = "ColorsAndFontsPreferencePage.selectedElement"; //$NON-NLS-1$<br/>
&nbsp;&nbsp;&nbsp;&nbsp;/**<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * The preference that stores the expanded state.<br/>
&nbsp;&nbsp;&nbsp;&nbsp; */<br/>
&nbsp;&nbsp;&nbsp;&nbsp;private static final String EXPANDED_ELEMENTS_PREF = "ColorsAndFontsPreferencePage.expandedCategories"; //$NON-NLS-1$<br/>
&nbsp;&nbsp;&nbsp;&nbsp;/**<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * The token that separates expanded elements in EXPANDED_ELEMENTS_PREF.<br/>
&nbsp;&nbsp;&nbsp;&nbsp; */<br/>
&nbsp;&nbsp;&nbsp;&nbsp;private static final String EXPANDED_ELEMENTS_TOKEN = "\t"; //$NON-NLS-1$<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;/**<br/>
     * Marks category tokens in EXPANDED_ELEMENTS_PREF and SELECTED_ELEMENT_PREF.<br/>
     */<br/>
&nbsp;&nbsp;&nbsp;&nbsp;private static final char MARKER_CATEGORY = 'T';<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;/**<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * Marks color tokens in EXPANDED_ELEMENTS_PREF and SELECTED_ELEMENT_PREF.<br/>
&nbsp;&nbsp;&nbsp;&nbsp; */<br/>
&nbsp;&nbsp;&nbsp;&nbsp;private static final char MARKER_COLOR = 'C';<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;/**<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * Marks font tokens in EXPANDED_ELEMENTS_PREF and SELECTED_ELEMENT_PREF.<br/>
&nbsp;&nbsp;&nbsp;&nbsp; */<br/>
&nbsp;&nbsp;&nbsp;&nbsp;private static final char MARKER_FONT = 'F';<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br/>
    private class ThemeContentProvider implements ITreeContentProvider {<br/>
<br/>
        private IThemeRegistry registry;<br/>
<br/>
        /* (non-Javadoc)<br/>
         * @see org.eclipse.jface.viewers.ITreeContentProvider#getChildren(java.lang.Object)<br/>
         */<br/>
        public Object[] getChildren(Object parentElement) {<br/>
            if (parentElement instanceof ThemeElementCategory) {<br/>
                String categoryId = ((ThemeElementCategory) parentElement)<br/>
                        .getId();<br/>
                Object[] defintions = (Object[]) categoryMap.get(categoryId);<br/>
                if (defintions == null) {<br/>
                    defintions = getCategoryChildren(categoryId);<br/>
                    categoryMap.put(categoryId, defintions);<br/>
                }<br/>
                return defintions;<br/>
            }<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ArrayList list = new ArrayList();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IHierarchalThemeElementDefinition def = (IHierarchalThemeElementDefinition) parentElement;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String id = def.getId();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IHierarchalThemeElementDefinition[] defs;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (def instanceof ColorDefinition) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;defs = registry.getColors();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;defs = registry.getFonts();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for (int i = 0; i &lt; defs.length; i++) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (id.equals(defs[i].getDefaultsTo())<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;&amp; ColorsAndFontsPreferencePage.equals(<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((ICategorizedThemeElementDefinition) def)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.getCategoryId(),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((ICategorizedThemeElementDefinition) defs[i])<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.getCategoryId())) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;list.add(defs[i]);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return list.toArray();<br/>
        }<br/>
<br/>
        private Object[] getCategoryChildren(String categoryId) {<br/>
            ArrayList list = new ArrayList();<br/>
<br/>
            if (categoryId != null) {<br/>
                ThemeElementCategory[] categories = registry.getCategories();<br/>
                for (int i = 0; i &lt; categories.length; i++) {<br/>
                    if (categoryId.equals(categories[i].getParentId())) {<br/>
                        Set bindings = themeRegistry<br/>
                                .getPresentationsBindingsFor(categories[i]);<br/>
                        if (bindings == null<br/>
                                || bindings.contains(workbench<br/>
                                        .getPresentationId())) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;list.add(categories[i]);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
                    }<br/>
                }<br/>
            }<br/>
            {<br/>
                ColorDefinition[] colorDefinitions = themeRegistry<br/>
                        .getColorsFor(currentTheme.getId());<br/>
                for (int i = 0; i &lt; colorDefinitions.length; i++) {<br/>
                    if (!colorDefinitions[i].isEditable()) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
                    String catId = colorDefinitions[i].getCategoryId();<br/>
                    if ((catId == null &amp;&amp; categoryId == null)<br/>
                            || (catId != null &amp;&amp; categoryId != null &amp;&amp; categoryId<br/>
                                    .equals(catId))) {<br/>
                        if (colorDefinitions[i].getDefaultsTo() != null<br/>
                                &amp;&amp; parentIsInSameCategory(colorDefinitions[i])) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
                        list.add(colorDefinitions[i]);<br/>
                    }<br/>
                }<br/>
            }<br/>
            {<br/>
                FontDefinition[] fontDefinitions = themeRegistry<br/>
                        .getFontsFor(currentTheme.getId());<br/>
                for (int i = 0; i &lt; fontDefinitions.length; i++) {<br/>
                    if (!fontDefinitions[i].isEditable()) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
                    String catId = fontDefinitions[i].getCategoryId();<br/>
                    if ((catId == null &amp;&amp; categoryId == null)<br/>
                            || (catId != null &amp;&amp; categoryId != null &amp;&amp; categoryId<br/>
                                    .equals(catId))) {<br/>
                        if (fontDefinitions[i].getDefaultsTo() != null<br/>
                                &amp;&amp; parentIsInSameCategory(fontDefinitions[i])) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
                        list.add(fontDefinitions[i]);<br/>
                    }<br/>
                }<br/>
            }<br/>
            return list.toArray(new Object[list.size()]);<br/>
        }<br/>
<br/>
        private boolean parentIsInSameCategory(ColorDefinition definition) {<br/>
            String defaultsTo = definition.getDefaultsTo();<br/>
            ColorDefinition[] defs = registry.getColors();<br/>
            for (int i = 0; i &lt; defs.length; i++) {<br/>
                if (defs[i].getId().equals(defaultsTo)<br/>
                        &amp;&amp; ColorsAndFontsPreferencePage.equals(defs[i]<br/>
                                .getCategoryId(), definition.getCategoryId())) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return true;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
            }<br/>
            return false;<br/>
        }<br/>
<br/>
        private boolean parentIsInSameCategory(FontDefinition definition) {<br/>
            String defaultsTo = definition.getDefaultsTo();<br/>
            FontDefinition[] defs = registry.getFonts();<br/>
            for (int i = 0; i &lt; defs.length; i++) {<br/>
                if (defs[i].getId().equals(defaultsTo)<br/>
                        &amp;&amp; ColorsAndFontsPreferencePage.equals(defs[i]<br/>
                                .getCategoryId(), definition.getCategoryId())) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return true;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
            }<br/>
            return false;<br/>
        }<br/>
<br/>
        /* (non-Javadoc)<br/>
         * @see org.eclipse.jface.viewers.ITreeContentProvider#getParent(java.lang.Object)<br/>
         */<br/>
        public Object getParent(Object element) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (element instanceof ThemeElementCategory)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return registry;<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (element instanceof ColorDefinition) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String defaultId = ((IHierarchalThemeElementDefinition) element).getDefaultsTo();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (defaultId != null) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ColorDefinition defaultElement = registry.findColor(defaultId);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (parentIsInSameCategory(defaultElement))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return defaultElement;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String categoryId = ((ColorDefinition) element).getCategoryId();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return registry.findCategory(categoryId);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (element instanceof FontDefinition) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String defaultId = ((FontDefinition) element).getDefaultsTo();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (defaultId != null) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FontDefinition defaultElement = registry.findFont(defaultId);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (parentIsInSameCategory(defaultElement))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return defaultElement;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String categoryId = ((FontDefinition) element).getCategoryId();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return registry.findCategory(categoryId);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return null;<br/>
        }<br/>
<br/>
        /* (non-Javadoc)<br/>
         * @see org.eclipse.jface.viewers.ITreeContentProvider#hasChildren(java.lang.Object)<br/>
         */<br/>
        public boolean hasChildren(Object element) {<br/>
            if (element instanceof ThemeElementCategory) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return true;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IHierarchalThemeElementDefinition def = (IHierarchalThemeElementDefinition) element;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String id = def.getId();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IHierarchalThemeElementDefinition[] defs;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (def instanceof ColorDefinition) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;defs = registry.getColors();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;defs = registry.getFonts();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for (int i = 0; i &lt; defs.length; i++) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (id.equals(defs[i].getDefaultsTo())<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;&amp; ColorsAndFontsPreferencePage.equals(<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((ICategorizedThemeElementDefinition) def)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.getCategoryId(),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((ICategorizedThemeElementDefinition) defs[i])<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.getCategoryId())) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return true;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
<br/>
            return false;<br/>
        }<br/>
<br/>
        /*<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; * (non-Javadoc)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; * <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; * @see org.eclipse.jface.viewers.IStructuredContentProvider#getElements(java.lang.Object)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; */<br/>
        public Object[] getElements(Object inputElement) {<br/>
            ArrayList list = new ArrayList();<br/>
            Object[] uncatChildren = getCategoryChildren(null);<br/>
            list.addAll(Arrays.asList(uncatChildren));<br/>
            ThemeElementCategory[] categories = ((IThemeRegistry) inputElement)<br/>
                    .getCategories();<br/>
            for (int i = 0; i &lt; categories.length; i++) {<br/>
                if (categories[i].getParentId() == null) {<br/>
                    Set bindings = themeRegistry<br/>
                            .getPresentationsBindingsFor(categories[i]);<br/>
                    if (bindings == null<br/>
                            || bindings.contains(workbench.getPresentationId())) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;list.add(categories[i]);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
                }<br/>
            }<br/>
            return list.toArray(new Object[list.size()]);<br/>
        }<br/>
<br/>
        /* (non-Javadoc)<br/>
         * @see org.eclipse.jface.viewers.IContentProvider#dispose()<br/>
         */<br/>
        public void dispose() {<br/>
            categoryMap.clear();<br/>
        }<br/>
<br/>
        /* (non-Javadoc)<br/>
         * @see org.eclipse.jface.viewers.IContentProvider#inputChanged(org.eclipse.jface.viewers.Viewer, java.lang.Object, java.lang.Object)<br/>
         */<br/>
        public void inputChanged(Viewer viewer, Object oldInput, Object newInput) {<br/>
            categoryMap.clear();<br/>
            registry = (IThemeRegistry) newInput;<br/>
        }<br/>
<br/>
    }<br/>
<br/>
    private class PresentationLabelProvider extends LabelProvider implements<br/>
            IFontProvider {<br/>
<br/>
        private HashMap fonts = new HashMap();<br/>
<br/>
        private HashMap images = new HashMap();<br/>
<br/>
        private int imageSize = -1;<br/>
<br/>
        private int usableImageSize = -1;<br/>
<br/>
        private IPropertyChangeListener listener = new IPropertyChangeListener() {<br/>
            public void propertyChange(PropertyChangeEvent event) {<br/>
                fireLabelProviderChanged(new LabelProviderChangedEvent(<br/>
                        PresentationLabelProvider.this));<br/>
            }<br/>
        };<br/>
<br/>
        private Image emptyImage;<br/>
<br/>
        public PresentationLabelProvider() {<br/>
            hookListeners();<br/>
        }<br/>
<br/>
        /**<br/>
         * Hook the listeners onto the various registries.<br/>
         */<br/>
        public void hookListeners() {<br/>
            colorRegistry.addListener(listener);<br/>
            fontRegistry.addListener(listener);<br/>
        }<br/>
<br/>
        /* (non-Javadoc)<br/>
         * @see org.eclipse.jface.viewers.IBaseLabelProvider#dispose()<br/>
         */<br/>
        public void dispose() {<br/>
            super.dispose();<br/>
            colorRegistry.removeListener(listener);<br/>
            fontRegistry.removeListener(listener);<br/>
            for (Iterator i = images.values().iterator(); i.hasNext();) {<br/>
                ((Image) i.next()).dispose();<br/>
            }<br/>
            images.clear();<br/>
<br/>
            if (emptyImage != null) {<br/>
                emptyImage.dispose();<br/>
                emptyImage = null;<br/>
            }<br/>
<br/>
            //clear the fonts.<br/>
            clearFontCache();<br/>
        }<br/>
<br/>
        /**<br/>
         * Clears and disposes all fonts.<br/>
         */<br/>
        public void clearFontCache() {<br/>
            for (Iterator i = fonts.values().iterator(); i.hasNext();) {<br/>
                ((Font) i.next()).dispose();<br/>
            }<br/>
            fonts.clear();<br/>
        }<br/>
        <br/>
        /**<br/>
         * Clears and disposes all fonts and fires a label update.<br/>
         */<br/>
        public void clearFontCacheAndUpdate() {<br/>
        &nbsp;&nbsp;&nbsp;&nbsp;clearFontCache();<br/>
        &nbsp;&nbsp;&nbsp;&nbsp;fireLabelProviderChanged(new LabelProviderChangedEvent(<br/>
                    PresentationLabelProvider.this));<br/>
        }<br/>
<br/>
        /* (non-Javadoc)<br/>
         * @see org.eclipse.jface.viewers.IFontProvider#getFont(java.lang.Object)<br/>
         */<br/>
        public Font getFont(Object element) {<br/>
            Display display = tree.getDisplay();<br/>
            if (element instanceof FontDefinition) {<br/>
                int parentHeight = tree.getViewer().getControl().getFont()<br/>
                        .getFontData()[0].getHeight();<br/>
                Font baseFont = fontRegistry.get(((FontDefinition) element)<br/>
                        .getId());<br/>
                Font font = (Font) fonts.get(baseFont);<br/>
                if (font == null) {<br/>
                    FontData[] data = baseFont.getFontData();<br/>
                    for (int i = 0; i &lt; data.length; i++) {<br/>
                        data[i].setHeight(parentHeight);<br/>
                    }<br/>
                    font = new Font(display, data);<br/>
<br/>
                    fonts.put(baseFont, font);<br/>
                }<br/>
                return font;<br/>
            }<br/>
<br/>
            return JFaceResources.getDialogFont();<br/>
        }<br/>
<br/>
        /* (non-Javadoc)<br/>
         * @see org.eclipse.jface.viewers.ILabelProvider#getImage(java.lang.Object)<br/>
         */<br/>
        public Image getImage(Object element) {<br/>
            if (element instanceof ColorDefinition) {<br/>
                Color c = colorRegistry<br/>
                        .get(((ColorDefinition) element).getId());<br/>
                Image image = (Image) images.get(c);<br/>
                if (image == null) {<br/>
                    Display display = tree.getDisplay();<br/>
                    ensureImageSize();<br/>
                    image = new Image(display, imageSize, imageSize);<br/>
<br/>
                    GC gc = new GC(image);<br/>
                    gc.setBackground(tree.getViewer().getControl()<br/>
                            .getBackground());<br/>
                    gc.setForeground(tree.getViewer().getControl()<br/>
                            .getBackground());<br/>
                    gc.drawRectangle(0, 0, imageSize - 1, imageSize - 1);<br/>
<br/>
                    gc.setForeground(tree.getViewer().getControl()<br/>
                            .getForeground());<br/>
                    gc.setBackground(c);<br/>
<br/>
                    int offset = (imageSize - usableImageSize) / 2;<br/>
                    gc.drawRectangle(offset, offset, usableImageSize - offset,<br/>
                            usableImageSize - offset);<br/>
                    gc.fillRectangle(offset + 1, offset + 1, usableImageSize<br/>
                            - offset - 1, usableImageSize - offset - 1);<br/>
                    gc.dispose();<br/>
<br/>
                    images.put(c, image);<br/>
                }<br/>
                return image;<br/>
<br/>
            } else if (element instanceof FontDefinition) {<br/>
                return workbench.getSharedImages().getImage(<br/>
                        IWorkbenchGraphicConstants.IMG_OBJ_FONT);<br/>
            } else {<br/>
                return workbench.getSharedImages().getImage(<br/>
                        IWorkbenchGraphicConstants.IMG_OBJ_THEME_CATEGORY);<br/>
            }<br/>
        }<br/>
<br/>
        private void ensureImageSize() {<br/>
            if (imageSize == -1) {<br/>
                imageSize = tree.getViewer().getTree().getItemHeight();<br/>
                usableImageSize = Math.max(1, imageSize - 4);<br/>
            }<br/>
        }<br/>
<br/>
        /* (non-Javadoc)<br/>
         * @see org.eclipse.jface.viewers.ILabelProvider#getText(java.lang.Object)<br/>
         */<br/>
        public String getText(Object element) {<br/>
            if (element instanceof IHierarchalThemeElementDefinition) {<br/>
                IHierarchalThemeElementDefinition themeElement = (IHierarchalThemeElementDefinition) element;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (themeElement.getDefaultsTo() != null) {<br/>
                    String myCategory = ((ICategorizedThemeElementDefinition) themeElement).getCategoryId();<br/>
                    ICategorizedThemeElementDefinition def;<br/>
                    if (element instanceof ColorDefinition)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;def = themeRegistry.findColor(themeElement.getDefaultsTo());<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;def = themeRegistry.findFont(themeElement.getDefaultsTo());<br/>
<br/>
                    if (!ColorsAndFontsPreferencePage.equals(def.getCategoryId(), myCategory)) {<br/>
                    &nbsp;&nbsp;&nbsp;&nbsp;if (isDefault(themeElement))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return MessageFormat.format(RESOURCE_BUNDLE.getString("defaultFormat_default"), new Object[] { themeElement.getName(), def.getName() }); //$NON-NLS-1$<br/>
               &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return MessageFormat.format(RESOURCE_BUNDLE.getString("defaultFormat_override"), new Object[] { themeElement.getName(), def.getName() }); //$NON-NLS-1$<br/>
                    }<br/>
                }<br/>
            }<br/>
            return ((IThemeElementDefinition) element).getName();<br/>
        }<br/>
<br/>
        /**<br/>
         * Return whether the element is set to default.<br/>
         * <br/>
         * @param def the definition<br/>
         * @return whether the element is set to default<br/>
         * @since 3.2<br/>
         */<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;private boolean isDefault(IThemeElementDefinition def) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (def instanceof FontDefinition)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return ColorsAndFontsPreferencePage.this.isDefault((FontDefinition)def);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (def instanceof ColorDefinition)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return ColorsAndFontsPreferencePage.this.isDefault((ColorDefinition)def);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return false;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
    }<br/>
<br/>
    /**<br/>
     * The translation bundle in which to look up internationalized text.<br/>
     */<br/>
    private final static ResourceBundle RESOURCE_BUNDLE = ResourceBundle<br/>
            .getBundle(ColorsAndFontsPreferencePage.class.getName());<br/>
<br/>
    /**<br/>
     * Map to precalculate category color lists.<br/>
     */<br/>
    private Map categoryMap = new HashMap(7);<br/>
<br/>
    private Font appliedDialogFont;<br/>
<br/>
    /**<br/>
     * Map of definition id-&gt;RGB objects that map to changes expressed in this<br/>
     * UI session.  These changes should be made in preferences and the<br/>
     * registry.<br/>
     */<br/>
    private Map colorPreferencesToSet = new HashMap(7);<br/>
<br/>
    private CascadingColorRegistry colorRegistry;<br/>
<br/>
    /**<br/>
     * Map of definition id-&gt;RGB objects that map to changes expressed in this<br/>
     * UI session.  These changes should be made in the registry.<br/>
     */<br/>
    private Map colorValuesToSet = new HashMap(7);<br/>
<br/>
    /**<br/>
     * The default color preview composite.<br/>
     */<br/>
    private Composite defaultColorPreview;<br/>
    <br/>
    /**<br/>
     * The default font preview composite.<br/>
     */<br/>
    private Composite defaultFontPreview;<br/>
    <br/>
    /**<br/>
     * The composite to use when no preview is available.<br/>
     */<br/>
    private Composite defaultNoPreview;<br/>
    <br/>
&nbsp;&nbsp;&nbsp;&nbsp;/**<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * Currently selected font for preview; might be null.<br/>
&nbsp;&nbsp;&nbsp;&nbsp; */<br/>
&nbsp;&nbsp;&nbsp;&nbsp;private Font currentFont;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;/**<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * Currently selected color for preview; might be null. <br/>
&nbsp;&nbsp;&nbsp;&nbsp; */<br/>
&nbsp;&nbsp;&nbsp;&nbsp;private Color currentColor;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;/**<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * Canvas used to draw default color preview <br/>
&nbsp;&nbsp;&nbsp;&nbsp; */<br/>
&nbsp;&nbsp;&nbsp;&nbsp;private Canvas colorSampler;<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;/**<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * Canvas used to draw default font preview<br/>
&nbsp;&nbsp;&nbsp;&nbsp; */<br/>
&nbsp;&nbsp;&nbsp;&nbsp;private Canvas fontSampler;<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;private String fontSampleText;<br/>
<br/>
    private List dialogFontWidgets = new ArrayList();<br/>
<br/>
    private Button fontChangeButton;<br/>
<br/>
    /**<br/>
     * The button to edit the default of the selected element.<br/>
     * @since 3.7<br/>
     */<br/>
&nbsp;&nbsp;&nbsp;&nbsp;private Button editDefaultButton;<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;/**<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * The button to go to the default of the selected element.<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * <br/>
&nbsp;&nbsp;&nbsp;&nbsp; * @since 3.7<br/>
&nbsp;&nbsp;&nbsp;&nbsp; */<br/>
&nbsp;&nbsp;&nbsp;&nbsp;private Button goToDefaultButton;<br/>
<br/>
    private Map fontPreferencesToSet = new HashMap(7);<br/>
<br/>
    private CascadingFontRegistry fontRegistry;<br/>
<br/>
    private Button fontResetButton;<br/>
<br/>
    private Button fontSystemButton;<br/>
<br/>
    /**<br/>
     * Map of definition id-&gt;FontData[] objects that map to changes expressed in<br/>
     * this UI session.  These changes should be made in preferences and the<br/>
     * registry.<br/>
     */<br/>
    private Map fontValuesToSet = new HashMap(7);<br/>
<br/>
    /**<br/>
     * The composite that is parent to all previews.<br/>
     */<br/>
    private Composite previewComposite;<br/>
<br/>
    /**<br/>
     * A mapping from PresentationCategory-&gt;Composite for the created previews.<br/>
     */<br/>
    private Map previewMap = new HashMap(7);<br/>
<br/>
    /**<br/>
     * Set containing all IPresentationPreviews created.<br/>
     */<br/>
    private Set previewSet = new HashSet(7);<br/>
<br/>
    /**<br/>
     * The layout for the previewComposite.<br/>
     */<br/>
    private StackLayout stackLayout;<br/>
<br/>
    private final IThemeRegistry themeRegistry;<br/>
<br/>
    private ITheme currentTheme;<br/>
<br/>
    private PresentationLabelProvider labelProvider;<br/>
<br/>
    private CascadingTheme cascadingTheme;<br/>
<br/>
    private IPropertyChangeListener themeChangeListener;<br/>
<br/>
    private Workbench workbench;<br/>
<br/>
    private FilteredTree tree;<br/>
    <br/>
&nbsp;&nbsp;&nbsp;&nbsp;private Text descriptionText;<br/>
<br/>
    /**<br/>
     * Create a new instance of the receiver.<br/>
     */<br/>
    public ColorsAndFontsPreferencePage() {<br/>
        themeRegistry = WorkbenchPlugin.getDefault().getThemeRegistry();<br/>
        //no-op<br/>
    }<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;/**<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * {@inheritDoc}<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * &lt;p&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * Everything else except the following string patterns is ignored:<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * &lt;ul&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * &lt;li&gt;&lt;strong&gt;selectCategory:&lt;/strong&gt;ID - selects and expands the category<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * with the given ID&lt;/li&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * &lt;li&gt;&lt;strong&gt;selectFont:&lt;/strong&gt;ID - selects the font with the given ID&lt;/li&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * &lt;li&gt;&lt;strong&gt;selectColor:&lt;/strong&gt;ID - selects the color with the given ID<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * &lt;/li&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * &lt;/p&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * <br/>
&nbsp;&nbsp;&nbsp;&nbsp; * @param data<br/>
&nbsp;&nbsp;&nbsp;&nbsp; *            the data to be applied<br/>
&nbsp;&nbsp;&nbsp;&nbsp; */<br/>
&nbsp;&nbsp;&nbsp;&nbsp;public void applyData(Object data) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (tree == null || !(data instanceof String))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ThemeRegistry themeRegistry = (ThemeRegistry) tree.getViewer().getInput();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String command = (String) data;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (command.startsWith("selectCategory:")) { //$NON-NLS-1$<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String categoryId = command.substring(15);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ThemeElementCategory category = themeRegistry.findCategory(categoryId);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (category != null) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;selectAndReveal(category);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tree.getViewer().expandToLevel(category, 1);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else if (command.startsWith("selectFont:")) { //$NON-NLS-1$<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String id = command.substring(11);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FontDefinition fontDef = themeRegistry.findFont(id);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (fontDef != null) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;selectAndReveal(fontDef);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else if (command.startsWith("selectColor:")) { //$NON-NLS-1$<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String id = command.substring(12);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ColorDefinition colorDef = themeRegistry.findColor(id);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (colorDef != null) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;selectAndReveal(colorDef);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;/**<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * Selects and reveals the given element.<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * <br/>
&nbsp;&nbsp;&nbsp;&nbsp; * @param selection<br/>
&nbsp;&nbsp;&nbsp;&nbsp; *            the object to select and reveal<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * @since 3.7<br/>
&nbsp;&nbsp;&nbsp;&nbsp; */<br/>
&nbsp;&nbsp;&nbsp;&nbsp;private void selectAndReveal(Object selection) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TreeViewer viewer = tree.getViewer();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;viewer.setSelection(new StructuredSelection(selection), <span class="mv">false</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;viewer.reveal(selection);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;viewer.getTree().setFocus();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
<br/>
    private static boolean equals(String string, String string2) {<br/>
        if ((string == null &amp;&amp; string2 == null))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="add">return <span class="mv">true</span>;</span><br/>
        if (string == null || string2 == null)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="mv">return false;</span><br/>
        if (string.equals(string2))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="mv">return true;</span><br/>
        <span class="add">return <span class="mv">false</span>;</span><br/>
    }<br/>
<br/>
    /**<br/>
     * Create a button for the preference page.<br/>
     * @param parent<br/>
     * @param label<br/>
     */<br/>
    private Button createButton(Composite parent, String label) {<br/>
        Button button = new Button(parent, SWT.PUSH | SWT.CENTER);<br/>
        button.setText(label);<br/>
        myApplyDialogFont(button);<br/>
        setButtonLayoutData(button);<br/>
        button.setEnabled(<span class="mv">false</span>);<br/>
        return button;<br/>
    }<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;private Label createSeparator(Composite parent) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Label separator = new Label(parent, SWT.NONE);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;separator.setFont(parent.getFont());<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;separator.setVisible(<span class="mv">false</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GridData gd = new GridData();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gd.horizontalAlignment = GridData.FILL;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gd.verticalAlignment = GridData.BEGINNING;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gd.heightHint = 4;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;separator.setLayoutData(gd);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return separator;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
<br/>
<br/>
    /* (non-Javadoc)<br/>
     * @see org.eclipse.jface.preference.PreferencePage#createContents(org.eclipse.swt.widgets.Composite)<br/>
     */<br/>
    protected Control createContents(Composite parent) {<br/>
    &nbsp;&nbsp;&nbsp;&nbsp;PlatformUI.getWorkbench().getHelpSystem().setHelp(parent, IWorkbenchHelpContextIds.FONTS_PREFERENCE_PAGE);<br/>
    &nbsp;&nbsp;&nbsp;&nbsp;<br/>
        parent.addDisposeListener(new DisposeListener() {<br/>
            public void widgetDisposed(DisposeEvent e) {<br/>
                if (appliedDialogFont != null)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;appliedDialogFont.dispose();<br/>
            }<br/>
        });<br/>
        <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final SashForm advancedComposite = new SashForm(parent, SWT.VERTICAL);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GridData sashData = new GridData(SWT.FILL, SWT.FILL, <span class="mv">true</span>, true);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;advancedComposite.setLayoutData(sashData);<br/>
        <br/>
        Composite mainColumn = new Composite(advancedComposite, SWT.NONE);<br/>
        GridLayout layout = new GridLayout();<br/>
        layout.numColumns = 2;<br/>
        layout.marginWidth = 0;<br/>
        layout.marginHeight = 0;<br/>
        mainColumn.setFont(parent.getFont());<br/>
        mainColumn.setLayout(layout);<br/>
<br/>
        GridData data = new GridData(GridData.BEGINNING);<br/>
        data.horizontalSpan = 2;<br/>
        Label label = new Label(mainColumn, SWT.LEFT);<br/>
        label.setText(RESOURCE_BUNDLE.getString("colorsAndFonts")); //$NON-NLS-1$<br/>
        myApplyDialogFont(label);<br/>
        label.setLayoutData(data);<br/>
<br/>
        createTree(mainColumn);<br/>
        <br/>
        // --- buttons<br/>
        Composite controlColumn = new Composite(mainColumn, SWT.NONE);<br/>
        data = new GridData(GridData.FILL_VERTICAL);<br/>
        controlColumn.setLayoutData(data);<br/>
        layout = new GridLayout();<br/>
        layout.marginHeight = 0;<br/>
        layout.marginWidth = 0;<br/>
        controlColumn.setLayout(layout);<br/>
        <br/>
        // we need placeholder to offset the filter control of the table<br/>
        Label placeholder = new Label(controlColumn, SWT.NONE);<br/>
        GridData placeholderData = new GridData(SWT.TOP);<br/>
        placeholderData.heightHint = convertVerticalDLUsToPixels(12);<br/>
        placeholder.setLayoutData(placeholderData);<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fontChangeButton = createButton(controlColumn, RESOURCE_BUNDLE.getString("openChange")); //$NON-NLS-1$<br/>
        fontSystemButton = createButton(controlColumn, WorkbenchMessages.FontsPreference_useSystemFont);<br/>
        fontResetButton = createButton(controlColumn, RESOURCE_BUNDLE.getString("reset")); //$NON-NLS-1$<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;createSeparator(controlColumn);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;editDefaultButton = createButton(controlColumn, RESOURCE_BUNDLE.getString("editDefault")); //$NON-NLS-1$<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goToDefaultButton = createButton(controlColumn, RESOURCE_BUNDLE.getString("goToDefault")); //$NON-NLS-1$<br/>
        // --- end of buttons<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;createDescriptionControl(mainColumn);<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Composite previewColumn = new Composite(advancedComposite, SWT.NONE);<br/>
        GridLayout previewLayout = new GridLayout();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;previewLayout.marginTop = 7;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;previewLayout.marginWidth = 0;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;previewLayout.marginHeight = 0;<br/>
        previewColumn.setFont(parent.getFont());<br/>
        previewColumn.setLayout(previewLayout);<br/>
        <br/>
        // --- create preview control<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Composite composite = new Composite(previewColumn, SWT.NONE);<br/>
<br/>
        GridData data2 = new GridData(GridData.FILL_BOTH);<br/>
        composite.setLayoutData(data2);<br/>
        GridLayout layout2 = new GridLayout(1, <span class="mv">true</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;layout2.marginHeight = 0;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;layout2.marginWidth = 0;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;composite.setLayout(layout2);<br/>
        <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Label label2 = new Label(composite, SWT.LEFT);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;label2.setText(RESOURCE_BUNDLE.getString("preview")); //$NON-NLS-1$<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;myApplyDialogFont(label2);<br/>
        <br/>
        previewComposite = new Composite(composite, SWT.NONE);<br/>
        previewComposite.setLayoutData(new GridData(GridData.FILL_BOTH));<br/>
        stackLayout = new StackLayout();<br/>
        stackLayout.marginHeight = 0;<br/>
        stackLayout.marginWidth = 0;<br/>
        previewComposite.setLayout(stackLayout);<br/>
        // -- end of preview control<br/>
         <br/>
        <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;defaultFontPreview = createFontPreviewControl();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;defaultColorPreview = createColorPreviewControl();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;defaultNoPreview = createNoPreviewControl();<br/>
        <br/>
        hookListeners();<br/>
        <br/>
        updateTreeSelection(tree.getViewer().getSelection());<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;advancedComposite.setWeights(new int[] { 75, 25 });<br/>
        return advancedComposite;<br/>
    }<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;/**<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * Create the &lt;code&gt;ListViewer&lt;/code&gt; that will contain all color<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * definitions as defined in the extension point.<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * <br/>
&nbsp;&nbsp;&nbsp;&nbsp; * @param parent<br/>
&nbsp;&nbsp;&nbsp;&nbsp; *            the parent &lt;code&gt;Composite&lt;/code&gt;.<br/>
&nbsp;&nbsp;&nbsp;&nbsp; */<br/>
&nbsp;&nbsp;&nbsp;&nbsp;private void createTree(Composite parent) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;labelProvider = new PresentationLabelProvider();<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Create a custom pattern matcher that will allow<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// non-category elements to be returned in the event that their children<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// do not and also search the descriptions.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PatternFilter filter = new PatternFilter() {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; * (non-Javadoc)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; * @see org.eclipse.ui.dialogs.PatternFilter#isLeafMatch(org.eclipse.jface.viewers.Viewer, java.lang.Object)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; * @since 3.7<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; */<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;protected boolean isLeafMatch(Viewer viewer, Object element) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (super.isLeafMatch(viewer, element))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="add">return <span class="mv">true</span>;</span><br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String text = null;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (element instanceof ICategorizedThemeElementDefinition)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text = ((ICategorizedThemeElementDefinition) element).getDescription();<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return text != null ? wordMatches(text) : <span class="mv">false</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;filter.setIncludeLeadingWildcard(<span class="mv">true</span>);<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tree = new FilteredTree(parent, SWT.SINGLE | SWT.H_SCROLL | SWT.V_SCROLL | SWT.BORDER,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;filter, <span class="mv">true</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GridData data = new GridData(GridData.FILL_BOTH | GridData.VERTICAL_ALIGN_FILL);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;data.widthHint = Math.max(285, convertWidthInCharsToPixels(30));<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;data.heightHint = Math.max(175, convertHeightInCharsToPixels(10));<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tree.setLayoutData(data);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;myApplyDialogFont(tree.getViewer().getControl());<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Text filterText = tree.getFilterControl();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (filterText != null)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;myApplyDialogFont(filterText);<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tree.getViewer().setLabelProvider(labelProvider);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tree.getViewer().setContentProvider(new ThemeContentProvider());<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tree.getViewer().setComparator(new ViewerComparator() {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public int category(Object element) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (element instanceof ThemeElementCategory)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 1;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tree.getViewer().setInput(WorkbenchPlugin.getDefault().getThemeRegistry());<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tree.getViewer().addDoubleClickListener(new IDoubleClickListener() {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public void doubleClick(DoubleClickEvent event) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IStructuredSelection s = (IStructuredSelection) event.getSelection();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Object element = s.getFirstElement();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (tree.getViewer().isExpandable(element))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tree.getViewer().setExpandedState(element,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!tree.getViewer().getExpandedState(element));<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (element instanceof FontDefinition)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;editFont(tree.getDisplay());<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else if (element instanceof ColorDefinition)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;editColor(tree.getDisplay());<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;updateControls();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;restoreTreeExpansion();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;restoreTreeSelection();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
<br/>
    /* (non-Javadoc)<br/>
     * @see org.eclipse.jface.dialogs.IDialogPage#dispose()<br/>
     */<br/>
    public void dispose() {<br/>
        super.dispose();<br/>
        <br/>
        workbench.getThemeManager().removePropertyChangeListener(themeChangeListener);<br/>
        clearPreviews();<br/>
        // also dispose elements used by default previewers<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (currentFont != null &amp;&amp; !currentFont.isDisposed()) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;currentFont.dispose();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;currentFont = null;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (currentColor != null &amp;&amp; !currentColor.isDisposed()) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;currentColor.dispose();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;currentColor = null;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
        colorRegistry.dispose();<br/>
        fontRegistry.dispose();<br/>
    }<br/>
<br/>
    /**<br/>
     * Clear all previews.<br/>
     */<br/>
    private void clearPreviews() {<br/>
        if (cascadingTheme != null)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cascadingTheme.dispose();<br/>
<br/>
        for (Iterator i = previewSet.iterator(); i.hasNext();) {<br/>
            IThemePreview preview = (IThemePreview) i.next();<br/>
            try {<br/>
                preview.dispose();<br/>
            } catch (RuntimeException e) {<br/>
                WorkbenchPlugin.log(RESOURCE_BUNDLE.getString("errorDisposePreviewLog"), //$NON-NLS-1$ <br/>
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;StatusUtil.newStatus(IStatus.ERROR, e.getMessage(), e));<br/>
            }<br/>
        }<br/>
        previewSet.clear();<br/>
    }<br/>
<br/>
    /**<br/>
     * Get the ancestor of the given color, if any.<br/>
     * <br/>
     * @param definition the descendant &lt;code&gt;ColorDefinition&lt;/code&gt;.<br/>
     * @return the ancestor &lt;code&gt;ColorDefinition&lt;/code&gt;, or &lt;code&gt;null&lt;/code&gt;<br/>
     * &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if none.<br/>
     */<br/>
    private ColorDefinition getColorAncestor(ColorDefinition definition) {<br/>
        String defaultsTo = definition.getDefaultsTo();<br/>
        if (defaultsTo == null)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return null;<br/>
        return themeRegistry.findColor(defaultsTo);<br/>
    }<br/>
<br/>
    /**<br/>
     * Get the RGB value of the given colors ancestor, if any.<br/>
     * <br/>
     * @param definition the descendant &lt;code&gt;ColorDefinition&lt;/code&gt;.<br/>
     * @return the ancestor &lt;code&gt;RGB&lt;/code&gt;, or &lt;code&gt;null&lt;/code&gt; if none.<br/>
     */<br/>
    private RGB getColorAncestorValue(ColorDefinition definition) {<br/>
        ColorDefinition ancestor = getColorAncestor(definition);<br/>
        if (ancestor == null)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return null;<br/>
        return getColorValue(ancestor);<br/>
    }<br/>
<br/>
    /**<br/>
     * Get the RGB value for the specified definition.  Cascades through<br/>
     * preferenceToSet, valuesToSet and finally the registry.<br/>
     * <br/>
     * @param definition the &lt;code&gt;ColorDefinition&lt;/code&gt;.<br/>
     * @return the &lt;code&gt;RGB&lt;/code&gt; value.<br/>
     */<br/>
    private RGB getColorValue(ColorDefinition definition) {<br/>
        String id = definition.getId();<br/>
        RGB updatedRGB = (RGB) colorPreferencesToSet.get(id);<br/>
        if (updatedRGB == null) {<br/>
            updatedRGB = (RGB) colorValuesToSet.get(id);<br/>
            if (updatedRGB == null)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;updatedRGB = currentTheme.getColorRegistry().getRGB(id);<br/>
        }<br/>
        return updatedRGB;<br/>
    }<br/>
<br/>
    /**<br/>
     * Get colors that descend from the provided color.<br/>
     * <br/>
     * @param definition the ancestor &lt;code&gt;ColorDefinition&lt;/code&gt;.<br/>
     * @return the ColorDefinitions that have the provided definition as their<br/>
     * &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;defaultsTo attribute.<br/>
     */<br/>
    private ColorDefinition[] getDescendantColors(ColorDefinition definition) {<br/>
        List list = new ArrayList(5);<br/>
        String id = definition.getId();<br/>
<br/>
        ColorDefinition[] colors = themeRegistry.getColors();<br/>
        ColorDefinition[] sorted = new ColorDefinition[colors.length];<br/>
        System.arraycopy(colors, 0, sorted, 0, sorted.length);<br/>
<br/>
        Arrays.sort(sorted, new IThemeRegistry.HierarchyComparator(colors));<br/>
<br/>
        for (int i = 0; i &lt; sorted.length; i++) {<br/>
            if (id.equals(sorted[i].getDefaultsTo()))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;list.add(sorted[i]);<br/>
        }<br/>
        return (ColorDefinition[]) list.toArray(new ColorDefinition[list.size()]);<br/>
    }<br/>
<br/>
    private FontDefinition[] getDescendantFonts(FontDefinition definition) {<br/>
        List list = new ArrayList(5);<br/>
        String id = definition.getId();<br/>
<br/>
        FontDefinition[] fonts = themeRegistry.getFonts();<br/>
        FontDefinition[] sorted = new FontDefinition[fonts.length];<br/>
        System.arraycopy(fonts, 0, sorted, 0, sorted.length);<br/>
<br/>
        Arrays.sort(sorted, new IThemeRegistry.HierarchyComparator(fonts));<br/>
<br/>
        for (int i = 0; i &lt; sorted.length; i++) {<br/>
            if (id.equals(sorted[i].getDefaultsTo()))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;list.add(sorted[i]);<br/>
        }<br/>
        return (FontDefinition[]) list.toArray(new FontDefinition[list.size()]);<br/>
    }<br/>
<br/>
    private FontDefinition getFontAncestor(FontDefinition definition) {<br/>
        String defaultsTo = definition.getDefaultsTo();<br/>
        if (defaultsTo == null)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return null;<br/>
        return themeRegistry.findFont(defaultsTo);<br/>
    }<br/>
<br/>
    private FontData[] getFontAncestorValue(FontDefinition definition) {<br/>
        FontDefinition ancestor = getFontAncestor(definition);<br/>
        if (ancestor == null) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return PreferenceConverter.getDefaultFontDataArray(<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;getPreferenceStore(), ThemeElementHelper.createPreferenceKey(currentTheme, definition.getId()));<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
        return getFontValue(ancestor);<br/>
    }<br/>
<br/>
    protected FontData[] getFontValue(FontDefinition definition) {<br/>
        String id = definition.getId();<br/>
        FontData[] updatedFD = (FontData[]) fontPreferencesToSet.get(id);<br/>
        if (updatedFD == null) {<br/>
            updatedFD = (FontData[]) fontValuesToSet.get(id);<br/>
            if (updatedFD == null)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;updatedFD = currentTheme.getFontRegistry().getFontData(id);<br/>
        }<br/>
        return updatedFD;<br/>
    }<br/>
<br/>
    protected ColorDefinition getSelectedColorDefinition() {<br/>
        Object o = ((IStructuredSelection) tree.getViewer().getSelection()).getFirstElement();<br/>
        if (o instanceof ColorDefinition)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return (ColorDefinition) o;<br/>
        return null;<br/>
    }<br/>
<br/>
    protected FontDefinition getSelectedFontDefinition() {<br/>
        Object o = ((IStructuredSelection) tree.getViewer().getSelection()).getFirstElement();<br/>
        if (o instanceof FontDefinition)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return (FontDefinition) o;<br/>
        return null;<br/>
    }<br/>
    <br/>
    protected boolean isFontSelected() {<br/>
    &nbsp;&nbsp;&nbsp;&nbsp;Object o = ((IStructuredSelection) tree.getViewer().getSelection()).getFirstElement();<br/>
    &nbsp;&nbsp;&nbsp;&nbsp;return (o instanceof FontDefinition);<br/>
    }<br/>
<br/>
    protected boolean isColorSelected() {<br/>
    &nbsp;&nbsp;&nbsp;&nbsp;Object o = ((IStructuredSelection) tree.getViewer().getSelection()).getFirstElement();<br/>
    &nbsp;&nbsp;&nbsp;&nbsp;return (o instanceof ColorDefinition);<br/>
    }<br/>
    <br/>
    /**<br/>
     * Hook all control listeners.<br/>
     */<br/>
    private void hookListeners() {<br/>
        TreeViewer viewer = tree.getViewer();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;viewer.addSelectionChangedListener(new ISelectionChangedListener() {<br/>
                public void selectionChanged(SelectionChangedEvent event) {<br/>
                    updateTreeSelection(event.getSelection());<br/>
                }<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br/>
        fontChangeButton.addSelectionListener(new SelectionAdapter() {<br/>
            public void widgetSelected(SelectionEvent event) {<br/>
            &nbsp;&nbsp;&nbsp;&nbsp;Display display = event.display;<br/>
            &nbsp;&nbsp;&nbsp;&nbsp;if (isFontSelected())<br/>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;editFont(display);<br/>
            &nbsp;&nbsp;&nbsp;&nbsp;else if (isColorSelected())<br/>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;editColor(display);<br/>
            &nbsp;&nbsp;&nbsp;&nbsp;updateControls();<br/>
            }<br/>
        });<br/>
<br/>
        fontResetButton.addSelectionListener(new SelectionAdapter() {<br/>
<br/>
            public void widgetSelected(SelectionEvent e) {<br/>
            &nbsp;&nbsp;&nbsp;&nbsp;if (isFontSelected())<br/>
                    resetFont(getSelectedFontDefinition());<br/>
            &nbsp;&nbsp;&nbsp;&nbsp;else if (isColorSelected())<br/>
                  resetColor(getSelectedColorDefinition());<br/>
            &nbsp;&nbsp;&nbsp;&nbsp;updateControls();<br/>
            }<br/>
        });<br/>
<br/>
        fontSystemButton.addSelectionListener(new SelectionAdapter() {<br/>
            public void widgetSelected(SelectionEvent event) {<br/>
                FontDefinition definition = getSelectedFontDefinition();<br/>
                if (definition == null)<br/>
                &nbsp;&nbsp;&nbsp;&nbsp;return;<br/>
                FontData[] defaultFontData = JFaceResources.getDefaultFont().getFontData();<br/>
                setFontPreferenceValue(definition, defaultFontData);<br/>
                setRegistryValue(definition, defaultFontData);<br/>
                updateControls();<br/>
            }<br/>
        });<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;editDefaultButton.addSelectionListener(new SelectionAdapter() {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public void widgetSelected(SelectionEvent event) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Display display = event.display;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FontDefinition fontDefinition = getSelectedFontDefinition();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (fontDefinition != null) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String defaultFontId = fontDefinition.getDefaultsTo();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FontDefinition defaultFontDefinition = themeRegistry.findFont(defaultFontId);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;editFont(defaultFontDefinition, display);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ColorDefinition colorDefinition = getSelectedColorDefinition();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (colorDefinition != null) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String defaultColorId = colorDefinition.getDefaultsTo();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ColorDefinition defaultColorDefinition = themeRegistry<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.findColor(defaultColorId);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;editColor(defaultColorDefinition, display);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;updateControls();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goToDefaultButton.addSelectionListener(new SelectionAdapter() {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public void widgetSelected(SelectionEvent event) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FontDefinition fontDefinition = getSelectedFontDefinition();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (fontDefinition != null) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String defaultFontId = fontDefinition.getDefaultsTo();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FontDefinition defaultFontDefinition = themeRegistry.findFont(defaultFontId);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;selectAndReveal(defaultFontDefinition);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ColorDefinition colorDefinition = getSelectedColorDefinition();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (colorDefinition != null) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String defaultColorId = colorDefinition.getDefaultsTo();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ColorDefinition defaultColorDefinition = themeRegistry<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.findColor(defaultColorId);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;selectAndReveal(defaultColorDefinition);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;updateControls();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});<br/>
<br/>
    }<br/>
<br/>
    /* (non-Javadoc)<br/>
     * @see org.eclipse.ui.IWorkbenchPreferencePage#init(org.eclipse.ui.IWorkbench)<br/>
     */<br/>
    public void init(IWorkbench aWorkbench) {<br/>
        this.workbench = (Workbench) aWorkbench;<br/>
        setPreferenceStore(PrefUtil.getInternalPreferenceStore());<br/>
<br/>
        final IThemeManager themeManager = aWorkbench.getThemeManager();<br/>
<br/>
        themeChangeListener = new IPropertyChangeListener() {<br/>
            public void propertyChange(PropertyChangeEvent event) {<br/>
                if (event.getProperty().equals(<br/>
                        IThemeManager.CHANGE_CURRENT_THEME)) {<br/>
                    updateThemeInfo(themeManager);<br/>
                    refreshCategory();<br/>
                    tree.getViewer().refresh(); // refresh all the labels in the tree<br/>
                }<br/>
            }<br/>
        };<br/>
        themeManager.addPropertyChangeListener(themeChangeListener);<br/>
<br/>
        updateThemeInfo(themeManager);<br/>
    }<br/>
<br/>
    private void updateThemeInfo(IThemeManager manager) {<br/>
        clearPreviews();<br/>
        categoryMap.clear();<br/>
<br/>
        if (labelProvider != null)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;labelProvider.dispose(); // nuke the old cache<br/>
<br/>
        currentTheme = manager.getCurrentTheme();<br/>
<br/>
        if (colorRegistry != null)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;colorRegistry.dispose();<br/>
        if (fontRegistry != null)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fontRegistry.dispose();<br/>
<br/>
        currentTheme = manager.getCurrentTheme();<br/>
<br/>
        colorRegistry = new CascadingColorRegistry(currentTheme.getColorRegistry());<br/>
        fontRegistry = new CascadingFontRegistry(currentTheme.getFontRegistry());<br/>
<br/>
        fontPreferencesToSet.clear();<br/>
        fontValuesToSet.clear();<br/>
<br/>
        colorPreferencesToSet.clear();<br/>
        colorValuesToSet.clear();<br/>
<br/>
        if (labelProvider != null)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;labelProvider.hookListeners(); // rehook the listeners<br/>
    }<br/>
<br/>
    /**<br/>
     * Answers whether the definition is currently set to the default value.<br/>
     * <br/>
     * @param definition the &lt;code&gt;ColorDefinition&lt;/code&gt; to check.<br/>
     * @return Return whether the definition is currently mapped to the default<br/>
     * &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;value, either in the preference store or in the local change record<br/>
     * &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;of this preference page.<br/>
     */<br/>
    private boolean isDefault(ColorDefinition definition) {<br/>
        String id = definition.getId();<br/>
<br/>
        if (colorPreferencesToSet.containsKey(id)) {<br/>
            if (definition.getValue() != null) { // value-based color<br/>
                if (colorPreferencesToSet.get(id).equals(definition.getValue()))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="add">return <span class="mv">true</span>;</span><br/>
            } else {<br/>
                if (colorPreferencesToSet.get(id).equals(getColorAncestorValue(definition)))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="mv">return true;</span><br/>
            }<br/>
        } else {<br/>
            if (definition.getValue() != null) { // value-based color<br/>
                if (getPreferenceStore().isDefault(ThemeElementHelper.createPreferenceKey(currentTheme, id)))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="mv">return true;</span><br/>
            } else {<br/>
                // a descendant is default if it's the same value as its ancestor<br/>
                if (getColorValue(definition).equals(getColorAncestorValue(definition)))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="mv">return true;</span><br/>
            }<br/>
        }<br/>
        <span class="mv">return false;</span><br/>
    }<br/>
<br/>
    private boolean isDefault(FontDefinition definition) {<br/>
        String id = definition.getId();<br/>
<br/>
        if (fontPreferencesToSet.containsKey(id)) {<br/>
            if (definition.getValue() != null) { // value-based font<br/>
                if (Arrays.equals((FontData[]) fontPreferencesToSet.get(id), definition.getValue()))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="mv">return true;</span><br/>
            } else {<br/>
                FontData[] ancestor = getFontAncestorValue(definition);<br/>
                if (Arrays.equals((FontData[]) fontPreferencesToSet.get(id), ancestor))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="mv">return true;</span><br/>
            }<br/>
        } else {<br/>
            if (definition.getValue() != null) { // value-based font<br/>
                if (getPreferenceStore().isDefault(ThemeElementHelper.createPreferenceKey(currentTheme, id)))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="mv">return true;</span><br/>
            } else {<br/>
                FontData[] ancestor = getFontAncestorValue(definition);<br/>
                if (ancestor == null)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="mv">return true;</span><br/>
                // a descendant is default if it's the same value as its ancestor<br/>
                if (Arrays.equals(getFontValue(definition), ancestor))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="mv">return true;</span><br/>
            }<br/>
        }<br/>
        <span class="mv">return false;</span><br/>
    }<br/>
<br/>
    /**<br/>
     * Apply the dialog font to the control and store<br/>
     * it for later so that it can be used for a later<br/>
     * update.<br/>
     * @param control<br/>
     */<br/>
    private void myApplyDialogFont(Control control) {<br/>
        control.setFont(JFaceResources.getDialogFont());<br/>
        dialogFontWidgets.add(control);<br/>
    }<br/>
<br/>
    /**<br/>
     * @see org.eclipse.jface.preference.PreferencePage#performApply()<br/>
     */<br/>
    protected void performApply() {<br/>
        super.performApply();<br/>
<br/>
        //Apply the default font to the dialog.<br/>
        Font oldFont = appliedDialogFont;<br/>
        FontDefinition fontDefinition = themeRegistry.findFont(JFaceResources.DIALOG_FONT);<br/>
        if (fontDefinition == null)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;<br/>
        FontData[] newData = getFontValue(fontDefinition);<br/>
<br/>
        appliedDialogFont = new Font(getControl().getDisplay(), newData);<br/>
<br/>
        updateForDialogFontChange(appliedDialogFont);<br/>
        getApplyButton().setFont(appliedDialogFont);<br/>
        getDefaultsButton().setFont(appliedDialogFont);<br/>
<br/>
        if (oldFont != null)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;oldFont.dispose();<br/>
    }<br/>
<br/>
    private void performColorDefaults() {<br/>
        ColorDefinition[] definitions = themeRegistry.getColors();<br/>
<br/>
        // apply defaults in depth-order.<br/>
        ColorDefinition[] definitionsCopy = new ColorDefinition[definitions.length];<br/>
        System.arraycopy(definitions, 0, definitionsCopy, 0,definitions.length);<br/>
<br/>
        Arrays.sort(definitionsCopy, new IThemeRegistry.HierarchyComparator(definitions));<br/>
<br/>
        for (int i = 0; i &lt; definitionsCopy.length; i++) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;resetColor(definitionsCopy[i]);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
    }<br/>
<br/>
    private boolean performColorOk() {<br/>
        for (Iterator i = colorPreferencesToSet.keySet().iterator(); i.hasNext();) {<br/>
            String id = (String) i.next();<br/>
            String key = ThemeElementHelper.createPreferenceKey(currentTheme, id);<br/>
            RGB rgb = (RGB) colorPreferencesToSet.get(id);<br/>
            String rgbString = StringConverter.asString(rgb);<br/>
            String storeString = getPreferenceStore().getString(key);<br/>
<br/>
            if (!rgbString.equals(storeString))<br/>
                getPreferenceStore().setValue(key, rgbString);<br/>
        }<br/>
<br/>
        colorValuesToSet.clear();<br/>
        colorPreferencesToSet.clear();<br/>
        <span class="mv">return true;</span><br/>
    }<br/>
<br/>
    /* (non-Javadoc)<br/>
     * @see org.eclipse.jface.preference.PreferencePage#performDefaults()<br/>
     */<br/>
    protected void performDefaults() {<br/>
        performColorDefaults();<br/>
        performFontDefaults();<br/>
        updateControls();<br/>
    }<br/>
<br/>
    private void performFontDefaults() {<br/>
        FontDefinition[] definitions = themeRegistry.getFonts();<br/>
<br/>
        // apply defaults in depth-order.<br/>
        FontDefinition[] definitionsCopy = new FontDefinition[definitions.length];<br/>
        System.arraycopy(definitions, 0, definitionsCopy, 0, definitions.length);<br/>
<br/>
        Arrays.sort(definitionsCopy, new IThemeRegistry.HierarchyComparator(definitions));<br/>
<br/>
        for (int i = 0; i &lt; definitionsCopy.length; i++) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;resetFont(definitionsCopy[i]);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
    }<br/>
<br/>
    private boolean performFontOk() {<br/>
        for (Iterator i = fontPreferencesToSet.keySet().iterator(); i.hasNext();) {<br/>
            String id = (String) i.next();<br/>
            String key = ThemeElementHelper.createPreferenceKey(currentTheme, id);<br/>
            FontData[] fd = (FontData[]) fontPreferencesToSet.get(id);<br/>
<br/>
            String fdString = PreferenceConverter.getStoredRepresentation(fd);<br/>
            String storeString = getPreferenceStore().getString(key);<br/>
<br/>
            if (!fdString.equals(storeString))<br/>
                getPreferenceStore().setValue(key, fdString);<br/>
        }<br/>
<br/>
        fontValuesToSet.clear();<br/>
        fontPreferencesToSet.clear();<br/>
        <span class="mv">return true;</span><br/>
    }<br/>
<br/>
    /* (non-Javadoc)<br/>
     * @see org.eclipse.jface.preference.IPreferencePage#performOk()<br/>
     */<br/>
    public boolean performOk() {<br/>
    &nbsp;&nbsp;&nbsp;&nbsp;saveTreeExpansion();<br/>
    &nbsp;&nbsp;&nbsp;&nbsp;saveTreeSelection();<br/>
        boolean result =  performColorOk() &amp;&amp; performFontOk();<br/>
        if(result)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PrefUtil.savePrefs();<br/>
        return result;<br/>
    }<br/>
<br/>
    /**<br/>
     * Refreshes the category.<br/>
     */<br/>
    private void refreshCategory() {<br/>
        updateControls();<br/>
    }<br/>
<br/>
    /**<br/>
     * Resets the supplied definition to its default value.<br/>
     * <br/>
     * @param definition the &lt;code&gt;ColorDefinition&lt;/code&gt; to reset.<br/>
     * @return whether any change was made.<br/>
     */<br/>
    private boolean resetColor(ColorDefinition definition) {<br/>
        if (!isDefault(definition)) {<br/>
            RGB newRGB;<br/>
            if (definition.getValue() != null)<br/>
                newRGB = definition.getValue();<br/>
            else<br/>
                newRGB = getColorAncestorValue(definition);<br/>
<br/>
            if (newRGB != null) {<br/>
                setColorPreferenceValue(definition, newRGB);<br/>
                setRegistryValue(definition, newRGB);<br/>
                <span class="mv">return true;</span><br/>
            }<br/>
        }<br/>
        <span class="mv">return false;</span><br/>
    }<br/>
<br/>
    protected boolean resetFont(FontDefinition definition) {<br/>
        if (!isDefault(definition)) {<br/>
            FontData[] newFD;<br/>
            if (definition.getDefaultsTo() != null)<br/>
                newFD = getFontAncestorValue(definition);<br/>
            else<br/>
                newFD = PreferenceConverter.getDefaultFontDataArray(getPreferenceStore(), ThemeElementHelper<br/>
                                .createPreferenceKey(currentTheme, definition.getId()));<br/>
<br/>
            if (newFD != null) {<br/>
                setFontPreferenceValue(definition, newFD);<br/>
                setRegistryValue(definition, newFD);<br/>
                <span class="mv">return true;</span><br/>
            }<br/>
        }<br/>
        <span class="add">return <span class="mv">false</span>;</span><br/>
    }<br/>
<br/>
    /**<br/>
     * Set the value (in preferences) for the given color.<br/>
     * <br/>
     * @param definition the &lt;code&gt;ColorDefinition&lt;/code&gt; to set.<br/>
     * @param newRGB the new &lt;code&gt;RGB&lt;/code&gt; value for the definitions<br/>
     * &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;identifier.<br/>
     */<br/>
    protected void setColorPreferenceValue(ColorDefinition definition, RGB newRGB) {<br/>
        setDescendantRegistryValues(definition, newRGB);<br/>
        colorPreferencesToSet.put(definition.getId(), newRGB);<br/>
    }<br/>
<br/>
    /**<br/>
     * Set the value (in registry) for the given colors children.<br/>
     * <br/>
     * @param definition the &lt;code&gt;ColorDefinition&lt;/code&gt; whose children should<br/>
     * &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;be set.<br/>
     * @param newRGB the new &lt;code&gt;RGB&lt;/code&gt; value for the definitions<br/>
     * &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;identifier.<br/>
     */<br/>
    private void setDescendantRegistryValues(ColorDefinition definition, RGB newRGB) {<br/>
        ColorDefinition[] children = getDescendantColors(definition);<br/>
<br/>
        for (int i = 0; i &lt; children.length; i++) {<br/>
            if (isDefault(children[i])) {<br/>
                setDescendantRegistryValues(children[i], newRGB);<br/>
                setRegistryValue(children[i], newRGB);<br/>
                colorValuesToSet.put(children[i].getId(), newRGB);<br/>
            }<br/>
        }<br/>
    }<br/>
<br/>
    private void setDescendantRegistryValues(FontDefinition definition, FontData[] datas) {<br/>
        FontDefinition[] children = getDescendantFonts(definition);<br/>
<br/>
        for (int i = 0; i &lt; children.length; i++) {<br/>
            if (isDefault(children[i])) {<br/>
                setDescendantRegistryValues(children[i], datas);<br/>
                setRegistryValue(children[i], datas);<br/>
                fontValuesToSet.put(children[i].getId(), datas);<br/>
            }<br/>
        }<br/>
    }<br/>
<br/>
    protected void setFontPreferenceValue(FontDefinition definition, FontData[] datas) {<br/>
        setDescendantRegistryValues(definition, datas);<br/>
        fontPreferencesToSet.put(definition.getId(), datas);<br/>
    }<br/>
<br/>
    /**<br/>
     * Updates the working registry.<br/>
     * @param definition<br/>
     * @param newRGB<br/>
     */<br/>
    protected void setRegistryValue(ColorDefinition definition, RGB newRGB) {<br/>
        colorRegistry.put(definition.getId(), newRGB);<br/>
    }<br/>
<br/>
    protected void setRegistryValue(FontDefinition definition, FontData[] datas) {<br/>
        fontRegistry.put(definition.getId(), datas);<br/>
    }<br/>
<br/>
    /**<br/>
     * Returns the preview for the category.<br/>
     * @param category the category<br/>
     * @return the preview for the category, or its ancestors preview if it does not have one.<br/>
     */<br/>
    private IThemePreview getThemePreview(ThemeElementCategory category) throws CoreException {<br/>
        IThemePreview preview = category.createPreview();<br/>
        if (preview != null)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return preview;<br/>
<br/>
        if (category.getParentId() != null) {<br/>
            int idx = Arrays.binarySearch(themeRegistry.getCategories(),<br/>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;category.getParentId(), IThemeRegistry.ID_COMPARATOR);<br/>
            if (idx &gt;= 0)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return getThemePreview(themeRegistry.getCategories()[idx]);<br/>
        }<br/>
        return null;<br/>
    }<br/>
<br/>
    private ITheme getCascadingTheme() {<br/>
        if (cascadingTheme == null)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cascadingTheme = new CascadingTheme(currentTheme, colorRegistry, fontRegistry);<br/>
        return cascadingTheme;<br/>
    }<br/>
<br/>
    /**<br/>
     * Update for a change in the dialog font.<br/>
     * @param newFont<br/>
     */<br/>
    private void updateForDialogFontChange(Font newFont) {<br/>
        Iterator iterator = dialogFontWidgets.iterator();<br/>
        while (iterator.hasNext()) {<br/>
            ((Control) iterator.next()).setFont(newFont);<br/>
        }<br/>
<br/>
        //recalculate the fonts for the tree<br/>
        labelProvider.clearFontCacheAndUpdate();<br/>
    }<br/>
    <br/>
    private void updateTreeSelection(ISelection selection) {<br/>
    &nbsp;&nbsp;&nbsp;&nbsp;ThemeElementCategory category = null;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;    Object element = ((IStructuredSelection) selection).getFirstElement();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;    if (element instanceof ThemeElementCategory) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;    &nbsp;&nbsp;&nbsp;&nbsp;category = (ThemeElementCategory) element;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;    } else if (element instanceof ColorDefinition) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;    &nbsp;&nbsp;&nbsp;&nbsp;String categoryID = ((ColorDefinition) element).getCategoryId();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;    &nbsp;&nbsp;&nbsp;&nbsp;category = WorkbenchPlugin.getDefault().getThemeRegistry().findCategory(categoryID);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;    } else if (element instanceof FontDefinition) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;    &nbsp;&nbsp;&nbsp;&nbsp;String categoryID = ((FontDefinition) element).getCategoryId();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;    &nbsp;&nbsp;&nbsp;&nbsp;category = WorkbenchPlugin.getDefault().getThemeRegistry().findCategory(categoryID);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;    }<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Composite previewControl = null;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (category != null) { // check if there is a preview for it<br/>
&nbsp;&nbsp;&nbsp;&nbsp;        previewControl = (Composite) previewMap.get(category);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;        if (previewControl == null) {<br/>
                try {<br/>
                    IThemePreview preview = getThemePreview(category);<br/>
                    if (preview != null) {<br/>
                        previewControl = new Composite(previewComposite, SWT.NONE);<br/>
                        previewControl.setLayout(new FillLayout());<br/>
                        ITheme theme = getCascadingTheme();<br/>
                        preview.createControl(previewControl, theme);<br/>
                        previewSet.add(preview);<br/>
                        previewMap.put(category, previewControl);<br/>
                    }<br/>
                } catch (CoreException e) {<br/>
                    previewControl = new Composite(previewComposite, SWT.NONE);<br/>
                    previewControl.setLayout(new FillLayout());<br/>
                    myApplyDialogFont(previewControl);<br/>
                    Text error = new Text(previewControl, SWT.WRAP | SWT.READ_ONLY);<br/>
                    error.setText(RESOURCE_BUNDLE.getString("errorCreatingPreview")); //$NON-NLS-1$<br/>
                    WorkbenchPlugin.log(RESOURCE_BUNDLE.getString("errorCreatePreviewLog"), //$NON-NLS-1$ <br/>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;StatusUtil.newStatus(IStatus.ERROR, e.getMessage(), e));<br/>
                }<br/>
&nbsp;&nbsp;&nbsp;&nbsp;        }<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
    &nbsp;&nbsp;&nbsp;&nbsp;<br/>
        if (previewControl == null) { // there is no preview for this theme, use default preview<br/>
        &nbsp;&nbsp;&nbsp;&nbsp;if (element instanceof ColorDefinition)<br/>
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;previewControl = defaultColorPreview;<br/>
        &nbsp;&nbsp;&nbsp;&nbsp;else if (element instanceof FontDefinition)<br/>
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;previewControl = defaultFontPreview;<br/>
        &nbsp;&nbsp;&nbsp;&nbsp;else<br/>
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;previewControl = defaultNoPreview;<br/>
        }<br/>
<br/>
        stackLayout.topControl = previewControl;<br/>
        previewComposite.layout();<br/>
        updateControls();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
<br/>
    /**<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * Restore the selection state of the tree.<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * @since 3.1<br/>
&nbsp;&nbsp;&nbsp;&nbsp; */<br/>
&nbsp;&nbsp;&nbsp;&nbsp;private void restoreTreeSelection() {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String selectedElementString = getPreferenceStore().getString(SELECTED_ELEMENT_PREF);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (selectedElementString == null)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Object element = findElementFromMarker(selectedElementString);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (element == null)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tree.getViewer().setSelection(new StructuredSelection(element), <span class="mv">true</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;/**<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * Save the selection state of the tree.<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * @since 3.1<br/>
&nbsp;&nbsp;&nbsp;&nbsp; */<br/>
&nbsp;&nbsp;&nbsp;&nbsp;private void saveTreeSelection() {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IStructuredSelection selection = (IStructuredSelection) tree.getViewer().getSelection();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Object element = selection.getFirstElement();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;StringBuffer buffer = new StringBuffer();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;appendMarkerToBuffer(buffer, element);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (buffer.length() &gt; 0)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buffer.append(((IThemeElementDefinition) element).getId());<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;getPreferenceStore().setValue(SELECTED_ELEMENT_PREF, buffer.toString());<br/>
&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;/**<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * Restore the expansion state of the tree.<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * @since 3.1<br/>
&nbsp;&nbsp;&nbsp;&nbsp; */<br/>
&nbsp;&nbsp;&nbsp;&nbsp;private void restoreTreeExpansion() {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String expandedElementsString = getPreferenceStore().getString(EXPANDED_ELEMENTS_PREF);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (expandedElementsString == null)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String[] expandedElementIDs = Util.getArrayFromList(expandedElementsString, EXPANDED_ELEMENTS_TOKEN);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (expandedElementIDs.length == 0)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List elements = new ArrayList(expandedElementIDs.length);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for (int i = 0; i &lt; expandedElementIDs.length; i++) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IThemeElementDefinition def = findElementFromMarker(expandedElementIDs[i]);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (def != null)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;elements.add(def);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tree.getViewer().setExpandedElements(elements.toArray());<br/>
&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;/**<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * Find the theme element from the given string. It will check the first<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * character against the known constants and then call the appropriate<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * method on the theme registry. If the element does not exist or the string<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * is invalid &lt;code&gt;null&lt;/code&gt; is returned.<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * <br/>
&nbsp;&nbsp;&nbsp;&nbsp; * @param string the string to parse<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * @return the element, or &lt;code&gt;null&lt;/code&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp; */<br/>
&nbsp;&nbsp;&nbsp;&nbsp;private IThemeElementDefinition findElementFromMarker(String string) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (string.length() &lt; 2)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return null;<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;char marker = string.charAt(0);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String id = string.substring(1);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IThemeElementDefinition def = null;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;switch (marker) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case MARKER_FONT:<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;def = themeRegistry.findFont(id);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case MARKER_COLOR:<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;def = themeRegistry.findColor(id);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case MARKER_CATEGORY:<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;def = themeRegistry.findCategory(id);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return def;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;/**<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * Saves the expansion state of the tree.<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * @since 3.1<br/>
&nbsp;&nbsp;&nbsp;&nbsp; */<br/>
&nbsp;&nbsp;&nbsp;&nbsp;private void saveTreeExpansion() {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Object[] elements = tree.getViewer().getExpandedElements();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List elementIds = new ArrayList(elements.length);<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;StringBuffer buffer = new StringBuffer();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for (int i = 0; i &lt; elements.length; i++) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Object object = elements[i];<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;appendMarkerToBuffer(buffer, object);<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (buffer.length() != 0) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buffer.append(((IThemeElementDefinition) object).getId());<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;elementIds.add(buffer.toString());<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buffer.setLength(0);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for (Iterator i = elementIds.iterator(); i.hasNext();) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String id = (String) i.next();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buffer.append(id);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (i.hasNext()) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buffer.append(EXPANDED_ELEMENTS_TOKEN);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;getPreferenceStore().setValue(EXPANDED_ELEMENTS_PREF, buffer.toString());<br/>
&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;private void appendMarkerToBuffer(StringBuffer buffer, Object object) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (object instanceof FontDefinition) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buffer.append(MARKER_FONT);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else if (object instanceof ColorDefinition) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buffer.append(MARKER_COLOR);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else if (object instanceof ThemeElementCategory) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buffer.append(MARKER_CATEGORY);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;/**<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * Edit the currently selected font.<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * <br/>
&nbsp;&nbsp;&nbsp;&nbsp; * @param display<br/>
&nbsp;&nbsp;&nbsp;&nbsp; *            the display to open the dialog on<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * @since 3.2<br/>
&nbsp;&nbsp;&nbsp;&nbsp; */<br/>
&nbsp;&nbsp;&nbsp;&nbsp;private void editFont(Display display) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;editFont(getSelectedFontDefinition(), display);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;/**<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * Edit the given font.<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * <br/>
&nbsp;&nbsp;&nbsp;&nbsp; * @param definition<br/>
&nbsp;&nbsp;&nbsp;&nbsp; *            the font definition<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * @param display<br/>
&nbsp;&nbsp;&nbsp;&nbsp; *            the display to open the dialog on<br/>
&nbsp;&nbsp;&nbsp;&nbsp; * @since 3.7<br/>
&nbsp;&nbsp;&nbsp;&nbsp; */<br/>
&nbsp;&nbsp;&nbsp;&nbsp;private void editFont(FontDefinition definition, Display display) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (definition != null) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final FontDialog fontDialog = new FontDialog(getShell());<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fontDialog.setFontList(getFontValue(definition));<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final FontData data = fontDialog.open();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (data != null) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;setFontPreferenceValue(definition, fontDialog.getFontList());<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;setRegistryValue(definition, fontDialog.getFontList());<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;private void editColor(Display display) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;editColor(getSelectedColorDefinition(), display);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;private void editColor(ColorDefinition definition, Display display) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (definition == null)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RGB currentColor = colorRegistry.getRGB(definition.getId());<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ColorDialog colorDialog = new ColorDialog(display.getActiveShell());<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;colorDialog.setRGB(currentColor);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RGB selectedColor =  colorDialog.open();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ((selectedColor != null) &amp;&amp; (!selectedColor.equals(currentColor))) {<br/>
             setColorPreferenceValue(definition, selectedColor);<br/>
             setRegistryValue(definition, selectedColor);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;protected void updateControls() {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FontDefinition fontDefinition = getSelectedFontDefinition();<br/>
        if (fontDefinition != null) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;boolean isDefault = isDefault(fontDefinition);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;boolean hasDefault = fontDefinition.getDefaultsTo() != null;<br/>
            fontChangeButton.setEnabled(<span class="mv">true</span>);<br/>
            fontSystemButton.setEnabled(<span class="mv">true</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fontResetButton.setEnabled(!isDefault);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;editDefaultButton.setEnabled(hasDefault &amp;&amp; isDefault);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goToDefaultButton.setEnabled(hasDefault);<br/>
            setCurrentFont(fontDefinition);<br/>
            return;<br/>
        }<br/>
        ColorDefinition colorDefinition = getSelectedColorDefinition();<br/>
        if (colorDefinition != null) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;boolean isDefault = isDefault(getSelectedColorDefinition());<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;boolean hasDefault = colorDefinition.getDefaultsTo() != null;<br/>
            fontChangeButton.setEnabled(<span class="mv">true</span>);<br/>
            fontSystemButton.setEnabled(<span class="mv">false</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fontResetButton.setEnabled(!isDefault);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;editDefaultButton.setEnabled(hasDefault &amp;&amp; isDefault);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goToDefaultButton.setEnabled(hasDefault);<br/>
            setCurrentColor(colorDefinition);<br/>
            return;<br/>
        }<br/>
        // not a font or a color?<br/>
        fontChangeButton.setEnabled(<span class="mv">false</span>);<br/>
        fontSystemButton.setEnabled(<span class="mv">false</span>);<br/>
        fontResetButton.setEnabled(<span class="mv">false</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;editDefaultButton.setEnabled(<span class="mv">false</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goToDefaultButton.setEnabled(<span class="add">false</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;descriptionText.setText(""); //$NON-NLS-1$<br/>
&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<br/>
    /**<br/>
     * @return Return the default "No preview available." preview.<br/>
     */<br/>
&nbsp;&nbsp;&nbsp;&nbsp;private Composite createNoPreviewControl() {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Composite noPreviewControl = new Composite(previewComposite, SWT.NONE);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;noPreviewControl.setLayout(new FillLayout());<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Label l = new Label(noPreviewControl, SWT.LEFT);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;l.setText(RESOURCE_BUNDLE.getString("noPreviewAvailable")); //$NON-NLS-1$<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;myApplyDialogFont(l);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return noPreviewControl;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;private void setCurrentFont(FontDefinition fontDefinition) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FontData[] fontData = getFontValue(fontDefinition);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (currentFont != null &amp;&amp; !currentFont.isDisposed())<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;currentFont.dispose();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;currentFont = new Font(previewComposite.getDisplay(), fontData);<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// recalculate sample text<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;StringBuffer tmp = new StringBuffer();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for (int i = 0; i &lt; fontData.length; i++) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tmp.append(fontData[i].getName());<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tmp.append(' ');<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tmp.append(fontData[i].getHeight());<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int style = fontData[i].getStyle();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ((style &amp; SWT.BOLD) != 0) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tmp.append(' ');<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tmp.append(RESOURCE_BUNDLE.getString("boldFont")); //$NON-NLS-1$<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ((style &amp; SWT.ITALIC) != 0) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tmp.append(' ');<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tmp.append(RESOURCE_BUNDLE.getString("italicFont")); //$NON-NLS-1$<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fontSampleText = tmp.toString();<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String description = fontDefinition.getDescription();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;descriptionText.setText(description == null ? "" : description); //$NON-NLS-1$<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fontSampler.redraw();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;public void setCurrentColor(ColorDefinition colorDefinition) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RGB color = getColorValue(colorDefinition);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (currentColor != null &amp;&amp; !currentColor.isDisposed())<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;currentColor.dispose();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;currentColor = new Color(previewComposite.getDisplay(), color);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;colorSampler.redraw();<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String description = colorDefinition.getDescription();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;descriptionText.setText(description == null ? "" : description); //$NON-NLS-1$<br/>
&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;private Composite createFontPreviewControl() {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fontSampler = new Canvas(previewComposite, SWT.NONE);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GridLayout gridLayout = new GridLayout();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gridLayout.marginWidth = 0;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gridLayout.marginHeight = 0;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fontSampler.setLayout(gridLayout);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fontSampler.setLayoutData(new GridData(GridData.FILL_BOTH));<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fontSampler.addPaintListener(new PaintListener() {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public void paintControl(PaintEvent e) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (currentFont != null) // do the font preview<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;paintFontSample(e.gc);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return fontSampler;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;private void paintFontSample(GC gc) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (currentFont == null || currentFont.isDisposed())<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// draw rectangle all around<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Rectangle clientArea = colorSampler.getClientArea();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FontMetrics standardFontMetrics = gc.getFontMetrics();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int standardLineHeight = standardFontMetrics.getHeight();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int maxHeight = standardLineHeight * 4;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (clientArea.height &gt; maxHeight)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;clientArea = new Rectangle(clientArea.x, clientArea.y, clientArea.width, maxHeight);<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gc.setForeground(previewComposite.getDisplay().getSystemColor(SWT.COLOR_WIDGET_NORMAL_SHADOW));<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gc.drawRectangle(0, 0, clientArea.width - 1, clientArea.height - 1);<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gc.setForeground(previewComposite.getDisplay().getSystemColor(SWT.COLOR_BLACK));<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gc.setFont(currentFont);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FontMetrics fontMetrics = gc.getFontMetrics();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int lineHeight = fontMetrics.getHeight();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int topY = clientArea.y + 5;<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gc.setClipping(1, 1, clientArea.width - 2, clientArea.height - 2);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gc.drawText(fontSampleText, clientArea.x + 5, topY);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gc.drawText(RESOURCE_BUNDLE.getString("fontTextSample"), clientArea.x + 5, topY + lineHeight); //$NON-NLS-1$<br/>
&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;private Composite createColorPreviewControl() {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;colorSampler = new Canvas(previewComposite, SWT.NONE);<br/>
        GridLayout gridLayout = new GridLayout();<br/>
        gridLayout.marginWidth = 0;<br/>
        gridLayout.marginHeight = 0;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;colorSampler.setLayout(gridLayout);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;colorSampler.setLayoutData(new GridData(GridData.FILL_BOTH));<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;colorSampler.addPaintListener(new PaintListener() {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public void paintControl(PaintEvent e) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (currentColor != null) // do the color preview<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;paintColorSample(e.gc);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return colorSampler;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;private void paintColorSample(GC gc) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (currentColor == null || currentColor.isDisposed())<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gc.setFont(previewComposite.getDisplay().getSystemFont());<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FontMetrics fontMetrics = gc.getFontMetrics();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int lineHeight = fontMetrics.getHeight();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Rectangle clientArea = colorSampler.getClientArea();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int maxHeight = lineHeight * 4;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (clientArea.height &gt; maxHeight)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;clientArea = new Rectangle(clientArea.x, clientArea.y, clientArea.width, maxHeight);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String messageTop = RESOURCE_BUNDLE.getString("fontColorSample"); //$NON-NLS-1$<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RGB rgb = currentColor.getRGB();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String messageBottom = MessageFormat<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.format(<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"RGB({0}, {1}, {2})", new Object[] { new Integer(rgb.red), new Integer(rgb.green), new Integer(rgb.blue) }); //$NON-NLS-1$<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// calculate position of the vertical line<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int separator = (clientArea.width - 2) / 3;<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// calculate text positions<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int verticalCenter = clientArea.height / 2;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int textTopY = (verticalCenter - lineHeight) / 2;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (textTopY &lt; 1)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;textTopY = 1;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;textTopY += clientArea.y;<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int textBottomY = verticalCenter + textTopY;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (textBottomY &gt; clientArea.height - 2)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;textBottomY = clientArea.height - 2;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;textBottomY += clientArea.y;<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int stringWidthTop = gc.stringExtent(messageTop).x;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int textTopX = (separator - stringWidthTop - 1) / 2;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (textTopX &lt; 1)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;textTopX = 1;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;textTopX += clientArea.x;<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int stringWidthBottom = gc.stringExtent(messageBottom).x;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int textBottomX = (separator - stringWidthBottom - 1) / 2;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (textBottomX &lt; 1)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;textBottomX = 1;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;textBottomX += clientArea.x;<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// put text on the left - default background<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gc.setForeground(currentColor);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gc.drawText(messageTop, textTopX, textTopY);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gc.drawText(messageBottom, textBottomX, textBottomY);<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// fill right rectangle<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gc.setBackground(previewComposite.getDisplay().getSystemColor(SWT.COLOR_LIST_BACKGROUND));<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int rightWidth = clientArea.width - 2 - separator * 2;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gc.fillRectangle(separator * 2, 1, rightWidth, clientArea.height - 2);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// put text in the right rectangle<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gc.setForeground(currentColor);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gc.drawText(messageTop, separator * 2 + textTopX, textTopY);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gc.drawText(messageBottom, separator * 2 + textBottomX, textBottomY);<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// fill center rectangle<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gc.setBackground(currentColor);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gc.fillRectangle(separator, 1, separator, clientArea.height - 2);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// text: center top<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gc.setForeground(previewComposite.getDisplay().getSystemColor(SWT.COLOR_BLACK));<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gc.drawText(messageTop, separator + textTopX, textTopY);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gc.setForeground(previewComposite.getDisplay().getSystemColor(SWT.COLOR_WHITE));<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gc.drawText(messageBottom, separator + textBottomX, textBottomY);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// niceties<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gc.setForeground(previewComposite.getDisplay().getSystemColor(SWT.COLOR_WIDGET_NORMAL_SHADOW));<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gc.drawLine(separator, verticalCenter, separator * 2 - 1, verticalCenter);<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// draw rectangle all around<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gc.setForeground(previewComposite.getDisplay().getSystemColor(SWT.COLOR_WIDGET_NORMAL_SHADOW));<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gc.drawRectangle(0, 0, clientArea.width - 1, clientArea.height - 1);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;private void createDescriptionControl(Composite parent) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Composite composite = new Composite(parent, SWT.NONE);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GridLayout layout = new GridLayout();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;layout.marginWidth = 0;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;layout.marginHeight = 0;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;composite.setLayout(layout);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GridData data = new GridData(GridData.FILL_HORIZONTAL);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;data.horizontalSpan = 2;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;composite.setLayoutData(data);<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Label label = new Label(composite, SWT.LEFT);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;label.setText(RESOURCE_BUNDLE.getString("description")); //$NON-NLS-1$<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;myApplyDialogFont(label);<br/>
<br/>
        descriptionText = new Text(composite, SWT.READ_ONLY | SWT.BORDER | SWT.WRAP);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;data = new GridData(GridData.FILL_BOTH);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;data.heightHint = convertHeightInCharsToPixels(3);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;data.widthHint = convertWidthInCharsToPixels(30);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;descriptionText.setLayoutData(data);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;myApplyDialogFont(descriptionText);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
}<br/>
</div>
</div>
</div>
<div class="clear"></div>
</div>
</body>
</html>