<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8" />
<title>Diff result</title>
<style type="text/css">
body { width: 100%; font-size: 10pt; }
h1 { font-size: 125%; }
div.content { font-family: Verdana, "DejaVu Sans Condensed", "Liberation Sans","Nimbus Sans L", Helvetica, sans-serif; margin : 1em auto; width: 100%; }
div.left { float: left; width: 48%; padding: 1em; }
div.right { float: right; width: 48%; padding: 1em; }
div.code { font-family: "Liberation Mono", "Courrier New", monospace; border:1px solid black;}
div.clear { clear: both; }
span.del { background-color : red; font-weight: normal; font-style: normal;}
span.add { background-color : lightgreen; font-weight: bold; font-style: normal;}
span.upd { background-color : orange; font-weight: bold; font-style: italic;}
span.id { background-color : white; font-weight: normal; font-style: normal;}
span.mv { background-color : yellow; font-weight: normal; font-style: normal;}
</style></head><body><div class="content"><div class="left">
<h1>left_AttributeValue_1.49.java</h1>
<div class="code">
<div class="id">
package org.tigris.scarab.om;<br/>
<br/>
/* ================================================================<br/>
 * Copyright (c) 2000-2002 CollabNet.  All rights reserved.<br/>
 * <br/>
 * Redistribution and use in source and binary forms, with or without<br/>
 * modification, are permitted provided that the following conditions are<br/>
 * met:<br/>
 * <br/>
 * 1. Redistributions of source code must retain the above copyright<br/>
 * notice, this list of conditions and the following disclaimer.<br/>
 * <br/>
 * 2. Redistributions in binary form must reproduce the above copyright<br/>
 * notice, this list of conditions and the following disclaimer in the<br/>
 * documentation and/or other materials provided with the distribution.<br/>
 * <br/>
 * 3. The end-user documentation included with the redistribution, if<br/>
 * any, must include the following acknowlegement: "This product includes<br/>
 * software developed by Collab.Net &lt;http://www.Collab.Net/&gt;."<br/>
 * Alternately, this acknowlegement may appear in the software itself, if<br/>
 * and wherever such third-party acknowlegements normally appear.<br/>
 * <br/>
 * 4. The hosted project names must not be used to endorse or promote<br/>
 * products derived from this software without prior written<br/>
 * permission. For written permission, please contact info@collab.net.<br/>
 * <br/>
 * 5. Products derived from this software may not use the "Tigris" or <br/>
 * "Scarab" names nor may "Tigris" or "Scarab" appear in their names without <br/>
 * prior written permission of Collab.Net.<br/>
 * <br/>
 * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED<br/>
 * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF<br/>
 * MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.<br/>
 * IN NO EVENT SHALL COLLAB.NET OR ITS CONTRIBUTORS BE LIABLE FOR ANY<br/>
 * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL<br/>
 * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE<br/>
 * GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS<br/>
 * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER<br/>
 * IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR<br/>
 * OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF<br/>
 * ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.<br/>
 *<br/>
 * ====================================================================<br/>
 * <br/>
 * This software consists of voluntary contributions made by many<br/>
 * individuals on behalf of Collab.Net.<br/>
 */ <br/>
<br/>
// JDK classes<br/>
import java.util.List;<br/>
import java.util.ArrayList;<br/>
<br/>
import org.apache.commons.util.ObjectUtils;<br/>
// Turbine classes<br/>
import org.apache.torque.om.Persistent;<br/>
import org.apache.torque.om.ObjectKey;<br/>
import org.apache.torque.om.NumberKey;<br/>
import org.apache.torque.pool.DBConnection;<br/>
<br/>
import org.apache.fulcrum.cache.TurbineGlobalCacheService;<br/>
import org.apache.fulcrum.cache.GlobalCacheService;<br/>
import org.apache.fulcrum.cache.ObjectExpiredException;<br/>
import org.apache.fulcrum.cache.CachedObject;<br/>
<br/>
import org.apache.fulcrum.TurbineServices;<br/>
<br/>
import org.tigris.scarab.util.ScarabException;<br/>
import org.tigris.scarab.services.user.UserManager;<br/>
import org.tigris.scarab.services.module.ModuleEntity;<br/>
import org.tigris.scarab.services.module.ModuleManager;<br/>
<br/>
/** <br/>
  * The skeleton for this class was autogenerated by Torque on:<br/>
  *<br/>
  * [Wed Feb 28 16:36:26 PST 2001]<br/>
  *<br/>
  * You should add additional methods to this class to meet the<br/>
  * application requirements.  This class will only be generated as<br/>
  * long as it does not already exist in the output directory.<br/>
  */<br/>
public abstract class AttributeValue <br/>
    extends BaseAttributeValue<br/>
    implements Persistent<br/>
{<br/>
    // need a local reference<br/>
    private Attribute aAttribute;<br/>
<br/>
    private Transaction transaction;<br/>
    private NumberKey oldOptionId;<br/>
    private NumberKey oldUserId;<br/>
    private String oldValue;<br/>
    private int oldNumericValue;<br/>
    private boolean oldOptionIdIsSet;<br/>
    private boolean oldUserIdIsSet;<br/>
    private boolean oldValueIsSet;<br/>
    private boolean oldNumericValueIsSet;<br/>
    private AttributeValue chainedValue;<br/>
    <br/>
    private static String className = "AttributeValue";<br/>
<br/>
    <br/>
    /** Creates a new attribute. Do not do anything here.<br/>
     * All initialization should be performed in init().<br/>
     */<br/>
    protected AttributeValue()<br/>
    {<br/>
        oldOptionIdIsSet = false;<br/>
        oldUserIdIsSet = false;<br/>
        oldValueIsSet = false;<br/>
        oldNumericValueIsSet = false;<br/>
    }<br/>
<br/>
    /**<br/>
     * Get the value of chainedValue.<br/>
     * @return value of chainedValue.<br/>
     */<br/>
    public AttributeValue getChainedValue() <br/>
    {<br/>
        return chainedValue;<br/>
    }<br/>
    <br/>
    /**<br/>
     * Set the value of chainedValue.<br/>
     * @param v  Value to assign to chainedValue.<br/>
     */<br/>
    public void setChainedValue(AttributeValue  v)<br/>
        throws Exception<br/>
    {<br/>
        if ( v == null ) <br/>
        {<br/>
            this.chainedValue = null;<br/>
        }<br/>
        else <br/>
        {        <br/>
            if ( v.getAttributeId() == null &amp;&amp; getAttributeId() != null ) <br/>
            {<br/>
                v.setAttributeId(getAttributeId());<br/>
            }<br/>
            else if (v.getAttribute() != null <br/>
                     &amp;&amp; !v.getAttribute().equals(getAttribute()))<br/>
            {<br/>
                throw new ScarabException(<br/>
                    "Values for different Attributes cannot be chained: " +<br/>
                    v.getAttributeId() + " and " + getAttributeId() );<br/>
            }<br/>
            <br/>
            if ( v.getIssueId() == null &amp;&amp; getIssueId() != null ) <br/>
            {<br/>
                v.setIssueId(getIssueId());<br/>
            }<br/>
            else if ( v.getIssue() != null <br/>
                      &amp;&amp; !v.getIssue().equals(getIssue()) )<br/>
            {<br/>
                throw new ScarabException(<br/>
                    "Values for different Issues cannot be chained: " +<br/>
                    v.getIssueId() + " and " + getIssueId() );<br/>
            }<br/>
<br/>
            if ( this.chainedValue == null ) <br/>
            {<br/>
                this.chainedValue = v;<br/>
            }<br/>
            else <br/>
            {<br/>
                chainedValue.setChainedValue(v);<br/>
            }<br/>
            <br/>
            if ( transaction != null ) <br/>
            {<br/>
                v.startTransaction(transaction);<br/>
            }        <br/>
        }<br/>
    }<br/>
<br/>
    /**<br/>
     * This method returns a flat List of all AttributeValues that might<br/>
     * be chained to this one. This AttributeValue will be first in the List.<br/>
     *<br/>
     * @return a &lt;code&gt;List&lt;/code&gt; of AttributeValue's<br/>
     */<br/>
    public List getValueList()<br/>
    {<br/>
        List list = new ArrayList();<br/>
        list.add(this);<br/>
        AttributeValue av = getChainedValue();<br/>
        while ( av != null ) <br/>
        {<br/>
            list.add(av);<br/>
            av = av.getChainedValue();<br/>
        }<br/>
        return list;<br/>
    }<br/>
<br/>
    /**<br/>
     * sets the AttributeId for this as well as any chained values.<br/>
     */<br/>
    public void setAttributeId(NumberKey nk)<br/>
        throws Exception<br/>
    {<br/>
        super.setAttributeId(nk);<br/>
        if ( chainedValue != null ) <br/>
        {<br/>
            chainedValue.setAttributeId(nk);<br/>
        }<br/>
    }<br/>
<br/>
    /**<br/>
     * sets the IssueId for this as well as any chained values.<br/>
     */<br/>
    public void setIssueId(NumberKey nk)<br/>
        throws Exception<br/>
    {<br/>
        super.setIssueId(nk);<br/>
        if ( chainedValue != null ) <br/>
        {<br/>
            chainedValue.setIssueId(nk);<br/>
        }<br/>
    }<br/>
<br/>
    /**<br/>
     * Enters this attribute value into a transaction.  All changes to a<br/>
     * value must occur within a transaction.  The transaction is cleared<br/>
     * once the attribute value is saved.<br/>
     *<br/>
     * @param transaction a &lt;code&gt;Transaction&lt;/code&gt; value<br/>
     * @exception ScarabException if a new transaction is set before<br/>
     * the value is saved.<br/>
     */<br/>
    public void startTransaction(Transaction transaction)<br/>
        throws ScarabException<br/>
    {<br/>
        if ( transaction == null ) <br/>
        {<br/>
            String mesg = "Cannot start a transaction using null Transaction"; <br/>
            throw new ScarabException(mesg);<br/>
        }<br/>
        <br/>
        if ( this.transaction == null ) <br/>
        {<br/>
            this.transaction = transaction;<br/>
        }<br/>
        else <br/>
        {<br/>
            throw new ScarabException("A new transaction was set and " +<br/>
                "a transaction was already in progress.");<br/>
        }<br/>
        oldOptionIdIsSet = false;<br/>
        oldValueIsSet = false;<br/>
        oldOptionId = null;<br/>
        oldValue = null;<br/>
        if ( chainedValue != null ) <br/>
        {<br/>
            chainedValue.startTransaction(transaction);<br/>
        }<br/>
    }<br/>
<br/>
    private void endTransaction()<br/>
    {<br/>
        this.transaction = null;<br/>
        oldOptionId = null;<br/>
        oldValue = null;<br/>
        oldOptionIdIsSet = false;<br/>
        oldValueIsSet = false;<br/>
        if ( chainedValue != null ) <br/>
        {<br/>
            chainedValue.endTransaction();<br/>
        }        <br/>
    }<br/>
<br/>
    private void checkTransaction(String errorMessage)<br/>
        throws ScarabException<br/>
    {<br/>
        if ( transaction == null ) <br/>
        {<br/>
            throw new ScarabException(errorMessage);<br/>
        }<br/>
    }<br/>
<br/>
    public String getQueryKey()<br/>
    {<br/>
        String key = super.getQueryKey();<br/>
        if ( key == null || key.length() == 0 ) <br/>
        {<br/>
            try<br/>
            {<br/>
                key = "__" + getAttribute().getQueryKey();<br/>
            }<br/>
            catch (Exception e)<br/>
            {<br/>
                key = "";<br/>
            }<br/>
        }<br/>
        <br/>
        return key;<br/>
    }<br/>
<br/>
    public String toString()<br/>
    {<br/>
        try<br/>
        {<br/>
            return getAttribute().getName();<br/>
        }<br/>
        catch (Exception e)<br/>
        {<br/>
            return "";<br/>
        }<br/>
    }<br/>
<br/>
    /**<br/>
     * Get the OptionId<br/>
     * @return String<br/>
     */<br/>
    public String getOptionIdAsString()<br/>
    {<br/>
      String optionIdString = "";<br/>
      if (getOptionId() != null) <br/>
          optionIdString = getOptionId().toString();<br/>
      return optionIdString;<br/>
    }<br/>
<br/>
    /**<br/>
     * Makes sure to set the Value as well, to make display of the<br/>
     * option easier<br/>
     *<br/>
     * @param optionId a &lt;code&gt;NumberKey&lt;/code&gt; value<br/>
     */<br/>
    public void setOptionId(NumberKey optionId)<br/>
        throws Exception<br/>
    {<br/>
        if ( optionId != null &amp;&amp; optionId.getValue() != null ) <br/>
        {<br/>
            List options = getIssue().getModule()<br/>
                .getRModuleOptions(getAttribute(), getIssue().getIssueType());<br/>
            for ( int i=options.size()-1; i&gt;=0; i-- ) <br/>
            {<br/>
                RModuleOption option = (RModuleOption)options.get(i);<br/>
                if ( option.getOptionId().equals(optionId) ) <br/>
                {<br/>
                    setValueOnly(option.getDisplayValue());<br/>
                    break;<br/>
                }<br/>
            }<br/>
        }<br/>
        else<br/>
        {<br/>
            // any reason to set a option_id to null, once its already set?<br/>
            setValueOnly(null);<br/>
        }<br/>
        <br/>
        setOptionIdOnly(optionId);<br/>
    }<br/>
<br/>
    /**<br/>
     * Makes sure to set the Value as well<br/>
     *<br/>
     * @param int <br/>
     */<br/>
    public void setNumericValue(int v)<br/>
    {        <br/>
        setValueOnly(String.valueOf(v));<br/>
        if ( v != getNumericValue() )<br/>
        { <br/>
            // if the value is set multiple times before saving only<br/>
            // save the last saved value<br/>
            if ( !isNew() &amp;&amp; !oldNumericValueIsSet ) <br/>
            {<br/>
                oldNumericValue = getNumericValue();<br/>
                oldNumericValueIsSet = true;<br/>
            }<br/>
            super.setNumericValue(v);<br/>
        }  <br/>
    }<br/>
<br/>
    protected void setOptionIdOnly(NumberKey optionId)<br/>
        throws Exception<br/>
    {<br/>
        if ( !ObjectUtils.equals(optionId, getOptionId()) )<br/>
        { <br/>
            // if the value is set multiple times before saving only<br/>
            // save the last saved value<br/>
            if ( !isNew() &amp;&amp; !oldOptionIdIsSet ) <br/>
            {<br/>
                oldOptionId = new NumberKey(getOptionId());<br/>
                oldOptionIdIsSet = true;<br/>
            }<br/>
            super.setOptionId(optionId);<br/>
        }  <br/>
    }<br/>
<br/>
    /**<br/>
     * Makes sure to set the Value as well, to make display of the<br/>
     * user easier<br/>
     *<br/>
     * @param userId a &lt;code&gt;NumberKey&lt;/code&gt; value<br/>
     */<br/>
    public void setUserId(NumberKey userId)<br/>
        throws Exception<br/>
    {<br/>
        if ( userId != null &amp;&amp; userId.getValue() != null ) <br/>
        {<br/>
            ScarabUser user = UserManager.getInstance(userId);<br/>
            setValueOnly(user.getUserName());<br/>
        }<br/>
        else<br/>
        {<br/>
            // any reason to set a user_id to null, once its already set?<br/>
            setValueOnly(null);<br/>
        }<br/>
<br/>
        setUserIdOnly(userId);<br/>
    }<br/>
<br/>
    protected void setUserIdOnly(NumberKey value)<br/>
        throws Exception<br/>
    {<br/>
        if ( !ObjectUtils.equals(value, getUserId()) )<br/>
        { <br/>
            // if the value is set multiple times before saving only<br/>
            // save the last saved value<br/>
            if ( !isNew() &amp;&amp; !oldUserIdIsSet ) <br/>
            {<br/>
                oldUserId = new NumberKey(getUserId());<br/>
                oldUserIdIsSet = true;<br/>
            }<br/>
            super.setUserId(value);<br/>
        }<br/>
    }<br/>
<br/>
    /**<br/>
     * Not implemented always throws an exception<br/>
     *<br/>
     * @return a &lt;code&gt;NumberKey[]&lt;/code&gt; value<br/>
     * @exception Exception if an error occurs<br/>
     */<br/>
    public NumberKey[] getOptionIds()<br/>
        throws Exception<br/>
    {<br/>
        throw new ScarabException("not implemented");<br/>
    }<br/>
<br/>
    public void setOptionIds(NumberKey[] ids)<br/>
        throws Exception<br/>
    {<br/>
        if ( ids != null &amp;&amp; ids.length &gt; 0 ) <br/>
        {<br/>
            setOptionId(ids[0]);<br/>
        }<br/>
        if ( ids != null &amp;&amp; ids.length &gt; 1 ) <br/>
        {<br/>
            for ( int i=1; i&lt;ids.length; i++ ) <br/>
            {            <br/>
                AttributeValue av = AttributeValue                <br/>
                    .getNewInstance(getAttributeId(), getIssue());<br/>
                setChainedValue(av);<br/>
                av.setOptionId(ids[i]);<br/>
            }<br/>
        }<br/>
    }<br/>
<br/>
    /**<br/>
     * Not implemented always throws an exception<br/>
     *<br/>
     * @return a &lt;code&gt;NumberKey[]&lt;/code&gt; value<br/>
     * @exception Exception if an error occurs<br/>
     */<br/>
    public NumberKey[] getUserIds()<br/>
        throws Exception<br/>
    {<br/>
        throw new ScarabException("not implemented");<br/>
    }<br/>
<br/>
    public void setUserIds(NumberKey[] ids)<br/>
        throws Exception<br/>
    {<br/>
        if ( ids != null &amp;&amp; ids.length &gt; 0 ) <br/>
        {<br/>
            setUserId(ids[0]);<br/>
        }<br/>
        if ( ids != null &amp;&amp; ids.length &gt; 1 ) <br/>
        {<br/>
            for ( int i=1; i&lt;ids.length; i++ ) <br/>
            {            <br/>
                AttributeValue av = AttributeValue                <br/>
                    .getNewInstance(getAttributeId(), getIssue());<br/>
                setChainedValue(av);<br/>
                av.setUserId(ids[i]);<br/>
            }<br/>
        }<br/>
    }<br/>
<br/>
    public void setValue(String value)<br/>
    {<br/>
        setValueOnly(value);<br/>
    }<br/>
<br/>
    protected void setValueOnly(String value)<br/>
    {<br/>
        if ( !ObjectUtils.equals(value, getValue()) )<br/>
        { <br/>
            // if the value is set multiple times before saving only<br/>
            // save the last saved value<br/>
            if ( !isNew() &amp;&amp; !oldValueIsSet ) <br/>
            {<br/>
                oldValue = getValue();<br/>
                oldValueIsSet = true;<br/>
            }<br/>
            super.setValue(value);<br/>
        }<br/>
    }<br/>
<br/>
    public boolean isRequired()<br/>
       throws Exception<br/>
    {<br/>
        RModuleAttribute rma = getIssue().getModule()<br/>
            .getRModuleAttribute(getAttribute(), getIssue().getIssueType());<br/>
        return rma.getRequired();<br/>
    }<br/>
<br/>
    public boolean isSet()<br/>
       throws Exception<br/>
    {<br/>
        return !(getOptionId() == null &amp;&amp; getValue() == null<br/>
                 &amp;&amp; getUserId() == null);<br/>
    }<br/>
<br/>
    public Attribute getAttribute() throws Exception<br/>
    {<br/>
        if ( aAttribute==null &amp;&amp; (getAttributeId() != null) )<br/>
        {<br/>
            aAttribute = Attribute.getInstance(getAttributeId());<br/>
            <br/>
            // make sure the parent attribute is in synch.<br/>
            super.setAttribute(aAttribute);            <br/>
        }<br/>
        return aAttribute;<br/>
    }<br/>
<br/>
    public RModuleAttribute getRModuleAttribute()<br/>
        throws Exception<br/>
    {<br/>
        ModuleEntity module = ModuleManager<br/>
            .getInstance(getIssue().getModuleId());<br/>
        return module.getRModuleAttribute(getAttribute(),<br/>
                                          getIssue().getIssueType()); <br/>
    }<br/>
<br/>
    public void setAttribute(Attribute v) throws Exception<br/>
    {<br/>
        aAttribute = v;<br/>
        super.setAttribute(v);<br/>
    }<br/>
<br/>
<br/>
    public AttributeOption getAttributeOption()<br/>
        throws Exception<br/>
    {<br/>
        return getAttribute().getAttributeOption(getOptionId());<br/>
    }<br/>
<br/>
<br/>
    /**<br/>
     * if the Attribute related to this value is marked as relevant<br/>
     * to quick search in the module related to the Issue<br/>
     * related to this value.<br/>
     *<br/>
     * @return a &lt;code&gt;boolean&lt;/code&gt; value<br/>
     */<br/>
    public boolean isQuickSearchAttribute()<br/>
        throws Exception<br/>
    {<br/>
        boolean result = false;<br/>
        Attribute[] qsAttributes = getIssue().getModule()<br/>
            .getQuickSearchAttributes(getIssue().getIssueType());<br/>
        for ( int i=qsAttributes.length-1; i&gt;=0; i--) <br/>
        {<br/>
            if ( qsAttributes[i].equals(getAttribute()) ) <br/>
            {<br/>
                result = true;<br/>
                break;<br/>
            }<br/>
        }<br/>
        <br/>
        return result;<br/>
    }<br/>
<br/>
    static String getCacheKey(ObjectKey key)<br/>
    {<br/>
        String keyString = key.getValue().toString();<br/>
        return new StringBuffer(className.length() + keyString.length())<br/>
            .append(className).append(keyString).toString();<br/>
    }<br/>
<br/>
    /**<br/>
     * Creates, initializes and returns a new AttributeValue.<br/>
     * @return new Attribute instance<br/>
     * @param issue Issue object which this attribute is associated with<br/>
     * @param intId This Attribute's Id<br/>
     */<br/>
    public static AttributeValue getNewInstance(<br/>
        RModuleAttribute rma, Issue issue) throws Exception<br/>
    {<br/>
        return getNewInstance(rma.getAttributeId(), issue);<br/>
    }<br/>
<br/>
    /**<br/>
     * Creates, initializes and returns a new AttributeValue.<br/>
     * @return new AttributeValue instance<br/>
     * @param issue Issue object which this attributeValue is associated<br/>
     * @param attId the Attribute's Id<br/>
     */<br/>
    public static AttributeValue getNewInstance(<br/>
        ObjectKey attId, Issue issue) throws Exception<br/>
    {<br/>
        Attribute attribute = Attribute.getInstance(attId);<br/>
        return getNewInstance(attribute, issue);<br/>
    }<br/>
<br/>
    /**<br/>
     * Creates, initializes and returns a new AttributeValue.<br/>
     * @return new AttributeValue instance<br/>
     * @param issue Issue object which this attributeValue is associated<br/>
     * @param attId the Attribute's Id<br/>
     */<br/>
    public static synchronized AttributeValue getNewInstance(<br/>
        Attribute attribute, Issue issue) throws Exception<br/>
    {<br/>
        String className = attribute<br/>
            .getAttributeType().getJavaClassName();<br/>
        AttributeValue attv = (AttributeValue)<br/>
            Class.forName(className).newInstance();<br/>
        attv.setAttribute(attribute);<br/>
        attv.setIssue(issue);<br/>
<br/>
        String key = getCacheKey(attribute.getPrimaryKey());<br/>
        TurbineGlobalCacheService tgcs = <br/>
            (TurbineGlobalCacheService)TurbineServices<br/>
            .getInstance().getService(GlobalCacheService.SERVICE_NAME);<br/>
<br/>
        Object resources = null;<br/>
        try<br/>
        {<br/>
            resources = tgcs.getObject(key).getContents();<br/>
        }<br/>
        catch (ObjectExpiredException oee)<br/>
        {<br/>
            resources = attv.loadResources();<br/>
            tgcs.addObject(key, new CachedObject(resources));<br/>
        }<br/>
<br/>
        attv.setResources(resources);<br/>
        attv.init();<br/>
        return attv;<br/>
    }<br/>
<br/>
    /** <br/>
     * Loads from database data specific for this Attribute including Name.<br/>
     * These are data common to all Attribute instances with same id.<br/>
     * Data retrieved here will then be used in setResources.<br/>
     * @return Object containing Attribute resources which will be <br/>
     *         used in setResources.<br/>
     */<br/>
    protected abstract Object loadResources() throws Exception;<br/>
    <br/>
    /** <br/>
     * This method is used by an Attribute instance to obtain <br/>
     * specific resources such as option list for SelectOneAttribute.<br/>
     * It may, for example put them into instance variables. Attributes<br/>
     * may use common resources as-is or create it's own resources<br/>
     * based on common, it should not, however, modify common resources<br/>
     * since they will be used by other Attribute instances.<br/>
     *<br/>
     * @param resources Resources common for Attributes with the specified id.<br/>
     */<br/>
    protected abstract void setResources(Object resources);<br/>
        <br/>
    /** Override this method if you need any initialization for this attr.<br/>
     * @throws Exception Generic Exception<br/>
     */<br/>
    public abstract void init() throws Exception;<br/>
    <br/>
    public boolean supportsVoting()<br/>
    {<br/>
        return false;<br/>
    }<br/>
    <br/>
    public AttributeValue copy() throws Exception<br/>
    {<br/>
        AttributeValue copyObj = AttributeValue<br/>
            .getNewInstance(getAttributeId(), getIssue());<br/>
        return copyInto(copyObj);<br/>
    }<br/>
<br/>
    public void save(DBConnection dbcon)<br/>
        throws Exception<br/>
    {<br/>
        if ( <span class="mv">isModified()</span> ) <br/>
        {<br/>
            checkTransaction("Cannot save a value outside a Transaction");<br/>
            // Save activity record<br/>
            Activity activity = new Activity();<br/>
            String desc = getActivityDescription();<br/>
            activity.create(<span class="mv">getIssue()</span>, getAttribute(), desc, this.transaction,<br/>
                            oldNumericValue, getNumericValue(),<br/>
                            oldUserId, getUserId(),<br/>
                            oldOptionId, getOptionId(),<br/>
                            oldValue , getValue());<br/>
        }        <br/>
        super.save(dbcon);<br/>
        if ( chainedValue != null ) <br/>
        {<br/>
            chainedValue.save(dbcon);<br/>
        }<br/>
        <br/>
        endTransaction();<br/>
    }<br/>
<br/>
    // Not sure it is a good idea to save description in activity record<br/>
    // the description can be generated from the other data and it brings<br/>
    // up i18n issues.<br/>
    private String getActivityDescription()<br/>
        throws Exception<br/>
    {<br/>
        String id = <span class="del"><span class="mv">getIssue()</span>.<span class="mv">getFederatedId</span>()</span>;<br/>
        String name = getAttribute().getName();<br/>
        String newValue = getValue();<br/>
        /*<br/>
       int length = 40 + id.length() + name.length() + newValue.length();<br/>
        if ( oldValue != null ) <br/>
        {<br/>
            length += oldValue.length();<br/>
        }<br/>
        <br/>
        StringBuffer sb = new StringBuffer(length)<br/>
        */<br/>
        StringBuffer sb = new StringBuffer()<br/>
            .append(name);<br/>
        if ( oldValue == null ) <br/>
        {<br/>
            sb.append(" set");<br/>
        }<br/>
        else<br/>
        {<br/>
            sb.append(" changed from ")<br/>
              .append(oldValue);<br/>
        }<br/>
        sb.append(" to ")<br/>
          .append(newValue);<br/>
        return sb.toString();<br/>
    }<br/>
}<br/>
<br/>
<br/>
<br/>
</div>
</div>
</div>
<div class="right">
<h1>right_AttributeValue_1.50.java</h1>
<div class="code">
<div class="id">
package org.tigris.scarab.om;<br/>
<br/>
/* ================================================================<br/>
 * Copyright (c) 2000-2002 CollabNet.  All rights reserved.<br/>
 * <br/>
 * Redistribution and use in source and binary forms, with or without<br/>
 * modification, are permitted provided that the following conditions are<br/>
 * met:<br/>
 * <br/>
 * 1. Redistributions of source code must retain the above copyright<br/>
 * notice, this list of conditions and the following disclaimer.<br/>
 * <br/>
 * 2. Redistributions in binary form must reproduce the above copyright<br/>
 * notice, this list of conditions and the following disclaimer in the<br/>
 * documentation and/or other materials provided with the distribution.<br/>
 * <br/>
 * 3. The end-user documentation included with the redistribution, if<br/>
 * any, must include the following acknowlegement: "This product includes<br/>
 * software developed by Collab.Net &lt;http://www.Collab.Net/&gt;."<br/>
 * Alternately, this acknowlegement may appear in the software itself, if<br/>
 * and wherever such third-party acknowlegements normally appear.<br/>
 * <br/>
 * 4. The hosted project names must not be used to endorse or promote<br/>
 * products derived from this software without prior written<br/>
 * permission. For written permission, please contact info@collab.net.<br/>
 * <br/>
 * 5. Products derived from this software may not use the "Tigris" or <br/>
 * "Scarab" names nor may "Tigris" or "Scarab" appear in their names without <br/>
 * prior written permission of Collab.Net.<br/>
 * <br/>
 * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED<br/>
 * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF<br/>
 * MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.<br/>
 * IN NO EVENT SHALL COLLAB.NET OR ITS CONTRIBUTORS BE LIABLE FOR ANY<br/>
 * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL<br/>
 * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE<br/>
 * GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS<br/>
 * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER<br/>
 * IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR<br/>
 * OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF<br/>
 * ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.<br/>
 *<br/>
 * ====================================================================<br/>
 * <br/>
 * This software consists of voluntary contributions made by many<br/>
 * individuals on behalf of Collab.Net.<br/>
 */ <br/>
<br/>
// JDK classes<br/>
import java.util.List;<br/>
import java.util.ArrayList;<br/>
<br/>
import org.apache.commons.util.ObjectUtils;<br/>
// Turbine classes<br/>
import org.apache.torque.om.Persistent;<br/>
import org.apache.torque.om.ObjectKey;<br/>
import org.apache.torque.om.NumberKey;<br/>
import org.apache.torque.pool.DBConnection;<br/>
<br/>
import org.apache.fulcrum.cache.TurbineGlobalCacheService;<br/>
import org.apache.fulcrum.cache.GlobalCacheService;<br/>
import org.apache.fulcrum.cache.ObjectExpiredException;<br/>
import org.apache.fulcrum.cache.CachedObject;<br/>
<br/>
import org.apache.fulcrum.TurbineServices;<br/>
<br/>
import org.tigris.scarab.util.ScarabException;<br/>
import org.tigris.scarab.services.user.UserManager;<br/>
import org.tigris.scarab.services.module.ModuleEntity;<br/>
import org.tigris.scarab.services.module.ModuleManager;<br/>
<br/>
/** <br/>
  * The skeleton for this class was autogenerated by Torque on:<br/>
  *<br/>
  * [Wed Feb 28 16:36:26 PST 2001]<br/>
  *<br/>
  * You should add additional methods to this class to meet the<br/>
  * application requirements.  This class will only be generated as<br/>
  * long as it does not already exist in the output directory.<br/>
  */<br/>
public abstract class AttributeValue <br/>
    extends BaseAttributeValue<br/>
    implements Persistent<br/>
{<br/>
    // need a local reference<br/>
    private Attribute aAttribute;<br/>
<br/>
    private Transaction transaction;<br/>
    private NumberKey oldOptionId;<br/>
    private NumberKey oldUserId;<br/>
    private String oldValue;<br/>
    private int oldNumericValue;<br/>
    private boolean oldOptionIdIsSet;<br/>
    private boolean oldUserIdIsSet;<br/>
    private boolean oldValueIsSet;<br/>
    private boolean oldNumericValueIsSet;<br/>
    private AttributeValue chainedValue;<br/>
    <br/>
    private static String className = "AttributeValue";<br/>
<br/>
    <br/>
    /** Creates a new attribute. Do not do anything here.<br/>
     * All initialization should be performed in init().<br/>
     */<br/>
    protected AttributeValue()<br/>
    {<br/>
        oldOptionIdIsSet = false;<br/>
        oldUserIdIsSet = false;<br/>
        oldValueIsSet = false;<br/>
        oldNumericValueIsSet = false;<br/>
    }<br/>
<br/>
    /**<br/>
     * Get the value of chainedValue.<br/>
     * @return value of chainedValue.<br/>
     */<br/>
    public AttributeValue getChainedValue() <br/>
    {<br/>
        return chainedValue;<br/>
    }<br/>
    <br/>
    /**<br/>
     * Set the value of chainedValue.<br/>
     * @param v  Value to assign to chainedValue.<br/>
     */<br/>
    public void setChainedValue(AttributeValue  v)<br/>
        throws Exception<br/>
    {<br/>
        if ( v == null ) <br/>
        {<br/>
            this.chainedValue = null;<br/>
        }<br/>
        else <br/>
        {        <br/>
            if ( v.getAttributeId() == null &amp;&amp; getAttributeId() != null ) <br/>
            {<br/>
                v.setAttributeId(getAttributeId());<br/>
            }<br/>
            else if (v.getAttribute() != null <br/>
                     &amp;&amp; !v.getAttribute().equals(getAttribute()))<br/>
            {<br/>
                throw new ScarabException(<br/>
                    "Values for different Attributes cannot be chained: " +<br/>
                    v.getAttributeId() + " and " + getAttributeId() );<br/>
            }<br/>
            <br/>
            if ( v.getIssueId() == null &amp;&amp; getIssueId() != null ) <br/>
            {<br/>
                v.setIssueId(getIssueId());<br/>
            }<br/>
            else if ( v.getIssue() != null <br/>
                      &amp;&amp; !v.getIssue().equals(getIssue()) )<br/>
            {<br/>
                throw new ScarabException(<br/>
                    "Values for different Issues cannot be chained: " +<br/>
                    v.getIssueId() + " and " + getIssueId() );<br/>
            }<br/>
<br/>
            if ( this.chainedValue == null ) <br/>
            {<br/>
                this.chainedValue = v;<br/>
            }<br/>
            else <br/>
            {<br/>
                chainedValue.setChainedValue(v);<br/>
            }<br/>
            <br/>
            if ( transaction != null ) <br/>
            {<br/>
                v.startTransaction(transaction);<br/>
            }        <br/>
        }<br/>
    }<br/>
<br/>
    /**<br/>
     * This method returns a flat List of all AttributeValues that might<br/>
     * be chained to this one. This AttributeValue will be first in the List.<br/>
     *<br/>
     * @return a &lt;code&gt;List&lt;/code&gt; of AttributeValue's<br/>
     */<br/>
    public List getValueList()<br/>
    {<br/>
        List list = new ArrayList();<br/>
        list.add(this);<br/>
        AttributeValue av = getChainedValue();<br/>
        while ( av != null ) <br/>
        {<br/>
            list.add(av);<br/>
            av = av.getChainedValue();<br/>
        }<br/>
        return list;<br/>
    }<br/>
<br/>
    /**<br/>
     * sets the AttributeId for this as well as any chained values.<br/>
     */<br/>
    public void setAttributeId(NumberKey nk)<br/>
        throws Exception<br/>
    {<br/>
        super.setAttributeId(nk);<br/>
        if ( chainedValue != null ) <br/>
        {<br/>
            chainedValue.setAttributeId(nk);<br/>
        }<br/>
    }<br/>
<br/>
    /**<br/>
     * sets the IssueId for this as well as any chained values.<br/>
     */<br/>
    public void setIssueId(NumberKey nk)<br/>
        throws Exception<br/>
    {<br/>
        super.setIssueId(nk);<br/>
        if ( chainedValue != null ) <br/>
        {<br/>
            chainedValue.setIssueId(nk);<br/>
        }<br/>
    }<br/>
<br/>
    /**<br/>
     * Enters this attribute value into a transaction.  All changes to a<br/>
     * value must occur within a transaction.  The transaction is cleared<br/>
     * once the attribute value is saved.<br/>
     *<br/>
     * @param transaction a &lt;code&gt;Transaction&lt;/code&gt; value<br/>
     * @exception ScarabException if a new transaction is set before<br/>
     * the value is saved.<br/>
     */<br/>
    public void startTransaction(Transaction transaction)<br/>
        throws ScarabException<br/>
    {<br/>
        if ( transaction == null ) <br/>
        {<br/>
            String mesg = "Cannot start a transaction using null Transaction"; <br/>
            throw new ScarabException(mesg);<br/>
        }<br/>
        <br/>
        if ( this.transaction == null ) <br/>
        {<br/>
            this.transaction = transaction;<br/>
        }<br/>
        else <br/>
        {<br/>
            throw new ScarabException("A new transaction was set and " +<br/>
                "a transaction was already in progress.");<br/>
        }<br/>
        oldOptionIdIsSet = false;<br/>
        oldValueIsSet = false;<br/>
        oldOptionId = null;<br/>
        oldValue = null;<br/>
        if ( chainedValue != null ) <br/>
        {<br/>
            chainedValue.startTransaction(transaction);<br/>
        }<br/>
    }<br/>
<br/>
    private void endTransaction()<br/>
    {<br/>
        this.transaction = null;<br/>
        oldOptionId = null;<br/>
        oldValue = null;<br/>
        oldOptionIdIsSet = false;<br/>
        oldValueIsSet = false;<br/>
        if ( chainedValue != null ) <br/>
        {<br/>
            chainedValue.endTransaction();<br/>
        }        <br/>
    }<br/>
<br/>
    private void checkTransaction(String errorMessage)<br/>
        throws ScarabException<br/>
    {<br/>
        if ( transaction == null ) <br/>
        {<br/>
            throw new ScarabException(errorMessage);<br/>
        }<br/>
    }<br/>
<br/>
    public String getQueryKey()<br/>
    {<br/>
        String key = super.getQueryKey();<br/>
        if ( key == null || key.length() == 0 ) <br/>
        {<br/>
            try<br/>
            {<br/>
                key = "__" + getAttribute().getQueryKey();<br/>
            }<br/>
            catch (Exception e)<br/>
            {<br/>
                key = "";<br/>
            }<br/>
        }<br/>
        <br/>
        return key;<br/>
    }<br/>
<br/>
    public String toString()<br/>
    {<br/>
        try<br/>
        {<br/>
            return getAttribute().getName();<br/>
        }<br/>
        catch (Exception e)<br/>
        {<br/>
            return "";<br/>
        }<br/>
    }<br/>
<br/>
    /**<br/>
     * Get the OptionId<br/>
     * @return String<br/>
     */<br/>
    public String getOptionIdAsString()<br/>
    {<br/>
      String optionIdString = "";<br/>
      if (getOptionId() != null) <br/>
          optionIdString = getOptionId().toString();<br/>
      return optionIdString;<br/>
    }<br/>
<br/>
    /**<br/>
     * Makes sure to set the Value as well, to make display of the<br/>
     * option easier<br/>
     *<br/>
     * @param optionId a &lt;code&gt;NumberKey&lt;/code&gt; value<br/>
     */<br/>
    public void setOptionId(NumberKey optionId)<br/>
        throws Exception<br/>
    {<br/>
        if ( optionId != null &amp;&amp; optionId.getValue() != null ) <br/>
        {<br/>
            List options = getIssue().getModule()<br/>
                .getRModuleOptions(getAttribute(), getIssue().getIssueType());<br/>
            for ( int i=options.size()-1; i&gt;=0; i-- ) <br/>
            {<br/>
                RModuleOption option = (RModuleOption)options.get(i);<br/>
                if ( option.getOptionId().equals(optionId) ) <br/>
                {<br/>
                    setValueOnly(option.getDisplayValue());<br/>
                    break;<br/>
                }<br/>
            }<br/>
        }<br/>
        else<br/>
        {<br/>
            // any reason to set a option_id to null, once its already set?<br/>
            setValueOnly(null);<br/>
        }<br/>
        <br/>
        setOptionIdOnly(optionId);<br/>
    }<br/>
<br/>
    /**<br/>
     * Makes sure to set the Value as well<br/>
     *<br/>
     * @param int <br/>
     */<br/>
    public void setNumericValue(int v)<br/>
    {        <br/>
        setValueOnly(String.valueOf(v));<br/>
        if ( v != getNumericValue() )<br/>
        { <br/>
            // if the value is set multiple times before saving only<br/>
            // save the last saved value<br/>
            if ( !isNew() &amp;&amp; !oldNumericValueIsSet ) <br/>
            {<br/>
                oldNumericValue = getNumericValue();<br/>
                oldNumericValueIsSet = true;<br/>
            }<br/>
            super.setNumericValue(v);<br/>
        }  <br/>
    }<br/>
<br/>
    protected void setOptionIdOnly(NumberKey optionId)<br/>
        throws Exception<br/>
    {<br/>
        if ( !ObjectUtils.equals(optionId, getOptionId()) )<br/>
        { <br/>
            // if the value is set multiple times before saving only<br/>
            // save the last saved value<br/>
            if ( !isNew() &amp;&amp; !oldOptionIdIsSet ) <br/>
            {<br/>
                oldOptionId = new NumberKey(getOptionId());<br/>
                oldOptionIdIsSet = true;<br/>
            }<br/>
            super.setOptionId(optionId);<br/>
        }  <br/>
    }<br/>
<br/>
    /**<br/>
     * Makes sure to set the Value as well, to make display of the<br/>
     * user easier<br/>
     *<br/>
     * @param userId a &lt;code&gt;NumberKey&lt;/code&gt; value<br/>
     */<br/>
    public void setUserId(NumberKey userId)<br/>
        throws Exception<br/>
    {<br/>
        if ( userId != null &amp;&amp; userId.getValue() != null ) <br/>
        {<br/>
            ScarabUser user = UserManager.getInstance(userId);<br/>
            setValueOnly(user.getUserName());<br/>
        }<br/>
        else<br/>
        {<br/>
            // any reason to set a user_id to null, once its already set?<br/>
            setValueOnly(null);<br/>
        }<br/>
<br/>
        setUserIdOnly(userId);<br/>
    }<br/>
<br/>
    protected void setUserIdOnly(NumberKey value)<br/>
        throws Exception<br/>
    {<br/>
        if ( !ObjectUtils.equals(value, getUserId()) )<br/>
        { <br/>
            // if the value is set multiple times before saving only<br/>
            // save the last saved value<br/>
            if ( !isNew() &amp;&amp; !oldUserIdIsSet ) <br/>
            {<br/>
                oldUserId = new NumberKey(getUserId());<br/>
                oldUserIdIsSet = true;<br/>
            }<br/>
            super.setUserId(value);<br/>
        }<br/>
    }<br/>
<br/>
    /**<br/>
     * Not implemented always throws an exception<br/>
     *<br/>
     * @return a &lt;code&gt;NumberKey[]&lt;/code&gt; value<br/>
     * @exception Exception if an error occurs<br/>
     */<br/>
    public NumberKey[] getOptionIds()<br/>
        throws Exception<br/>
    {<br/>
        throw new ScarabException("not implemented");<br/>
    }<br/>
<br/>
    public void setOptionIds(NumberKey[] ids)<br/>
        throws Exception<br/>
    {<br/>
        if ( ids != null &amp;&amp; ids.length &gt; 0 ) <br/>
        {<br/>
            setOptionId(ids[0]);<br/>
        }<br/>
        if ( ids != null &amp;&amp; ids.length &gt; 1 ) <br/>
        {<br/>
            for ( int i=1; i&lt;ids.length; i++ ) <br/>
            {            <br/>
                AttributeValue av = AttributeValue                <br/>
                    .getNewInstance(getAttributeId(), getIssue());<br/>
                setChainedValue(av);<br/>
                av.setOptionId(ids[i]);<br/>
            }<br/>
        }<br/>
    }<br/>
<br/>
    /**<br/>
     * Not implemented always throws an exception<br/>
     *<br/>
     * @return a &lt;code&gt;NumberKey[]&lt;/code&gt; value<br/>
     * @exception Exception if an error occurs<br/>
     */<br/>
    public NumberKey[] getUserIds()<br/>
        throws Exception<br/>
    {<br/>
        throw new ScarabException("not implemented");<br/>
    }<br/>
<br/>
    public void setUserIds(NumberKey[] ids)<br/>
        throws Exception<br/>
    {<br/>
        if ( ids != null &amp;&amp; ids.length &gt; 0 ) <br/>
        {<br/>
            setUserId(ids[0]);<br/>
        }<br/>
        if ( ids != null &amp;&amp; ids.length &gt; 1 ) <br/>
        {<br/>
            for ( int i=1; i&lt;ids.length; i++ ) <br/>
            {            <br/>
                AttributeValue av = AttributeValue                <br/>
                    .getNewInstance(getAttributeId(), getIssue());<br/>
                setChainedValue(av);<br/>
                av.setUserId(ids[i]);<br/>
            }<br/>
        }<br/>
    }<br/>
<br/>
    public void setValue(String value)<br/>
    {<br/>
        setValueOnly(value);<br/>
    }<br/>
<br/>
    protected void setValueOnly(String value)<br/>
    {<br/>
        if ( !ObjectUtils.equals(value, getValue()) )<br/>
        { <br/>
            // if the value is set multiple times before saving only<br/>
            // save the last saved value<br/>
            if ( !isNew() &amp;&amp; !oldValueIsSet ) <br/>
            {<br/>
                oldValue = getValue();<br/>
                oldValueIsSet = true;<br/>
            }<br/>
            super.setValue(value);<br/>
        }<br/>
    }<br/>
<br/>
    public boolean isRequired()<br/>
       throws Exception<br/>
    {<br/>
        RModuleAttribute rma = getIssue().getModule()<br/>
            .getRModuleAttribute(getAttribute(), getIssue().getIssueType());<br/>
        return rma.getRequired();<br/>
    }<br/>
<br/>
    public boolean isSet()<br/>
       throws Exception<br/>
    {<br/>
        return !(getOptionId() == null &amp;&amp; getValue() == null<br/>
                 &amp;&amp; getUserId() == null);<br/>
    }<br/>
<br/>
    public Attribute getAttribute() throws Exception<br/>
    {<br/>
        if ( aAttribute==null &amp;&amp; (getAttributeId() != null) )<br/>
        {<br/>
            aAttribute = Attribute.getInstance(getAttributeId());<br/>
            <br/>
            // make sure the parent attribute is in synch.<br/>
            super.setAttribute(aAttribute);            <br/>
        }<br/>
        return aAttribute;<br/>
    }<br/>
<br/>
    public RModuleAttribute getRModuleAttribute()<br/>
        throws Exception<br/>
    {<br/>
        ModuleEntity module = ModuleManager<br/>
            .getInstance(getIssue().getModuleId());<br/>
        return module.getRModuleAttribute(getAttribute(),<br/>
                                          getIssue().getIssueType()); <br/>
    }<br/>
<br/>
    public void setAttribute(Attribute v) throws Exception<br/>
    {<br/>
        aAttribute = v;<br/>
        super.setAttribute(v);<br/>
    }<br/>
<br/>
<br/>
    public AttributeOption getAttributeOption()<br/>
        throws Exception<br/>
    {<br/>
        return getAttribute().getAttributeOption(getOptionId());<br/>
    }<br/>
<br/>
<br/>
    /**<br/>
     * if the Attribute related to this value is marked as relevant<br/>
     * to quick search in the module related to the Issue<br/>
     * related to this value.<br/>
     *<br/>
     * @return a &lt;code&gt;boolean&lt;/code&gt; value<br/>
     */<br/>
    public boolean isQuickSearchAttribute()<br/>
        throws Exception<br/>
    {<br/>
        boolean result = false;<br/>
        Attribute[] qsAttributes = getIssue().getModule()<br/>
            .getQuickSearchAttributes(getIssue().getIssueType());<br/>
        for ( int i=qsAttributes.length-1; i&gt;=0; i--) <br/>
        {<br/>
            if ( qsAttributes[i].equals(getAttribute()) ) <br/>
            {<br/>
                result = true;<br/>
                break;<br/>
            }<br/>
        }<br/>
        <br/>
        return result;<br/>
    }<br/>
<br/>
    static String getCacheKey(ObjectKey key)<br/>
    {<br/>
        String keyString = key.getValue().toString();<br/>
        return new StringBuffer(className.length() + keyString.length())<br/>
            .append(className).append(keyString).toString();<br/>
    }<br/>
<br/>
    /**<br/>
     * Creates, initializes and returns a new AttributeValue.<br/>
     * @return new Attribute instance<br/>
     * @param issue Issue object which this attribute is associated with<br/>
     * @param intId This Attribute's Id<br/>
     */<br/>
    public static AttributeValue getNewInstance(<br/>
        RModuleAttribute rma, Issue issue) throws Exception<br/>
    {<br/>
        return getNewInstance(rma.getAttributeId(), issue);<br/>
    }<br/>
<br/>
    /**<br/>
     * Creates, initializes and returns a new AttributeValue.<br/>
     * @return new AttributeValue instance<br/>
     * @param issue Issue object which this attributeValue is associated<br/>
     * @param attId the Attribute's Id<br/>
     */<br/>
    public static AttributeValue getNewInstance(<br/>
        ObjectKey attId, Issue issue) throws Exception<br/>
    {<br/>
        Attribute attribute = Attribute.getInstance(attId);<br/>
        return getNewInstance(attribute, issue);<br/>
    }<br/>
<br/>
    /**<br/>
     * Creates, initializes and returns a new AttributeValue.<br/>
     * @return new AttributeValue instance<br/>
     * @param issue Issue object which this attributeValue is associated<br/>
     * @param attId the Attribute's Id<br/>
     */<br/>
    public static synchronized AttributeValue getNewInstance(<br/>
        Attribute attribute, Issue issue) throws Exception<br/>
    {<br/>
        String className = attribute<br/>
            .getAttributeType().getJavaClassName();<br/>
        AttributeValue attv = (AttributeValue)<br/>
            Class.forName(className).newInstance();<br/>
        attv.setAttribute(attribute);<br/>
        attv.setIssue(issue);<br/>
<br/>
        String key = getCacheKey(attribute.getPrimaryKey());<br/>
        TurbineGlobalCacheService tgcs = <br/>
            (TurbineGlobalCacheService)TurbineServices<br/>
            .getInstance().getService(GlobalCacheService.SERVICE_NAME);<br/>
<br/>
        Object resources = null;<br/>
        try<br/>
        {<br/>
            resources = tgcs.getObject(key).getContents();<br/>
        }<br/>
        catch (ObjectExpiredException oee)<br/>
        {<br/>
            resources = attv.loadResources();<br/>
            tgcs.addObject(key, new CachedObject(resources));<br/>
        }<br/>
<br/>
        attv.setResources(resources);<br/>
        attv.init();<br/>
        return attv;<br/>
    }<br/>
<br/>
    /** <br/>
     * Loads from database data specific for this Attribute including Name.<br/>
     * These are data common to all Attribute instances with same id.<br/>
     * Data retrieved here will then be used in setResources.<br/>
     * @return Object containing Attribute resources which will be <br/>
     *         used in setResources.<br/>
     */<br/>
    protected abstract Object loadResources() throws Exception;<br/>
    <br/>
    /** <br/>
     * This method is used by an Attribute instance to obtain <br/>
     * specific resources such as option list for SelectOneAttribute.<br/>
     * It may, for example put them into instance variables. Attributes<br/>
     * may use common resources as-is or create it's own resources<br/>
     * based on common, it should not, however, modify common resources<br/>
     * since they will be used by other Attribute instances.<br/>
     *<br/>
     * @param resources Resources common for Attributes with the specified id.<br/>
     */<br/>
    protected abstract void setResources(Object resources);<br/>
        <br/>
    /** Override this method if you need any initialization for this attr.<br/>
     * @throws Exception Generic Exception<br/>
     */<br/>
    public abstract void init() throws Exception;<br/>
    <br/>
    public boolean supportsVoting()<br/>
    {<br/>
        return false;<br/>
    }<br/>
    <br/>
    public AttributeValue copy() throws Exception<br/>
    {<br/>
        AttributeValue copyObj = AttributeValue<br/>
            .getNewInstance(getAttributeId(), getIssue());<br/>
        return copyInto(copyObj);<br/>
    }<br/>
<br/>
    public void save(DBConnection dbcon)<br/>
        throws Exception<br/>
    {<br/>
        if ( <span class="add"><span class="mv">isModified()</span> &amp;&amp; <span class="add">!<span class="add"><span class="mv">getIssue()</span>.<span class="add">isTemplate</span>()</span></span></span> ) <br/>
        {<br/>
            checkTransaction("Cannot save a value outside a Transaction");<br/>
            // Save activity record<br/>
            Activity activity = new Activity();<br/>
            String desc = getActivityDescription();<br/>
            activity.create(<span class="mv">getIssue()</span>, getAttribute(), desc, this.transaction,<br/>
                            oldNumericValue, getNumericValue(),<br/>
                            oldUserId, getUserId(),<br/>
                            oldOptionId, getOptionId(),<br/>
                            oldValue , getValue());<br/>
        }        <br/>
        super.save(dbcon);<br/>
        if ( chainedValue != null ) <br/>
        {<br/>
            chainedValue.save(dbcon);<br/>
        }<br/>
        <br/>
        endTransaction();<br/>
    }<br/>
<br/>
    // Not sure it is a good idea to save description in activity record<br/>
    // the description can be generated from the other data and it brings<br/>
    // up i18n issues.<br/>
    private String getActivityDescription()<br/>
        throws Exception<br/>
    {<br/>
        String id = <span class="add"><span class="add"><span class="add">getIssue</span>()</span>.<span class="mv">getFederatedId</span>()</span>;<br/>
        String name = getAttribute().getName();<br/>
        String newValue = getValue();<br/>
        /*<br/>
       int length = 40 + id.length() + name.length() + newValue.length();<br/>
        if ( oldValue != null ) <br/>
        {<br/>
            length += oldValue.length();<br/>
        }<br/>
        <br/>
        StringBuffer sb = new StringBuffer(length)<br/>
        */<br/>
        StringBuffer sb = new StringBuffer()<br/>
            .append(name);<br/>
        if ( oldValue == null ) <br/>
        {<br/>
            sb.append(" set");<br/>
        }<br/>
        else<br/>
        {<br/>
            sb.append(" changed from ")<br/>
              .append(oldValue);<br/>
        }<br/>
        sb.append(" to ")<br/>
          .append(newValue);<br/>
        return sb.toString();<br/>
    }<br/>
}<br/>
<br/>
<br/>
<br/>
</div>
</div>
</div>
<div class="clear"></div>
</div>
</body>
</html>